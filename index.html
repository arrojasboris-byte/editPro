<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>üéß PROCESOS AUDIO</title>
<style>
  :root{--bg:#f6f7f9;--ink:#0f1115;--mut:#6b7280;--grad:linear-gradient(90deg,#6a6a6a,#b63a3a,#2e2e2e);--rose:#ffe7ec;--mint:#dff7ef}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:#0f1115;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  /* TOPBAR */
  .top{display:flex;gap:0;align-items:center;padding:8px 10px;background:var(--grad);background-attachment:fixed;background-size:100vw 100%;background-position:0 0;color:#fff}
  .top h1{margin:0 8px 0 0;font-size:18px;font-weight:900}
  .search{flex:1 1 420px;max-width:680px;border:none;border-radius:999px;background:rgba(255,255,255,.18);padding:6px 12px;color:#fff}
  .iconbar{display:flex;gap:6px;margin-left:auto}
  .ticon,.btnTop{border:none;border-radius:999px;background:rgba(255,255,255,.18);color:#fff;padding:6px 9px;cursor:pointer;line-height:1}
  .btnTop{padding:6px 12px}
  /* LAYOUT */
  .layout{display:grid;grid-template-columns:1fr 1fr;gap:0;padding:0;min-height:calc(100vh - 48px);background:var(--grad);background-attachment:fixed;background-size:100% 100%;background-position:0 0}
  @media(max-width:1024px){.layout{grid-template-columns:1fr}}
  .panel{background:transparent;border-radius:0;display:flex;flex-direction:column;min-width:0}
  .panel>header{padding:6px 8px;background:transparent;color:#fff;border-radius:0;display:flex;justify-content:space-between;align-items:center;font-weight:800;min-height:44px}
  .leftHdr{min-height:44px;height:44px;background:transparent;padding:0;margin:0}
  #procList{padding-top:12px}
  .body{padding:6px;overflow:auto;flex:1;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  /* PROCESOS IZQ COMPACTO */
  .procRow{display:flex;align-items:center;gap:8px;padding:9px 10px;border:1px solid #ececf1;border-radius:12px;background:#fff;margin-bottom:9px;cursor:grab}
  .procRow:active{cursor:grabbing} .procRow.active{border-width:2px;box-shadow:0 0 0 2px rgba(0,0,0,.06)}
  .pTitle{border:none;background:transparent;font-weight:800;font-size:14px;flex:1 1 92%;min-width:0;line-height:1.2}
  .tiny{display:flex;gap:2px}
  .ico{border:none;background:#eef0f3;border-radius:999px;width:17px;height:17px;display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer}
  /* DERECHA */
  #rHeader{background:transparent}
  .right-actions{display:flex;gap:6px;align-items:center}
  /* TARJETAS */
  .card{border-radius:10px;border:1px solid #f0c5cd;background:var(--rose);padding:5px}
  .card.green{border-color:#bde6d8;background:var(--mint)}
  /* PASOS COMPACTOS */
  .row{border:1px solid #edd6db;background:#fff;border-radius:9px;padding:3px 4px;margin:4px 0;cursor:grab}
  .row:active{cursor:grabbing}
  .chip{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:5px;padding:5px 6px;border:1px solid #e6e8ec;border-radius:9px;background:linear-gradient(180deg,#fff,#f3f4f6)}
  .bubble{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:999px;background:#000;color:#fff;font-weight:900;font-size:10px}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:linear-gradient(180deg,#4b4b4b,#2b2b2b);border:1px solid #5a5a5a;color:#fff;font-weight:800;font-size:11px}
  .title{border:none;background:transparent;font-weight:800;width:100%;min-width:0;font-size:13px}
  .subTitle{background:linear-gradient(180deg,#4b4b4b,#2b2b2b);border:1px solid #5a5a5a;border-radius:8px;padding:6px 8px;color:#fff}
  .subTitle:focus{outline:2px solid #444;box-shadow:0 0 0 2px #222 inset}
  .rightPack{display:flex;align-items:center;gap:4px;flex-wrap:wrap;justify-self:end}
  .ico.sm{width:19px;height:19px;font-size:11px}
  .miniSel{border:1px solid #e5e7eb;border-radius:999px;padding:2px 6px;font-size:11px}
  .nextBadge{font-weight:800;border-radius:999px;padding:2px 6px;border:1px solid #bbb;background:#eef0f3;color:#111;max-width:clamp(160px,50vw,640px);white-space:normal;word-break:break-word;line-height:1.1}
  .detail{display:none;padding:4px 2px 2px}
  .detail textarea{width:100%;min-height:40px;border:1px solid #e5e7eb;border-radius:8px;padding:6px 7px;overflow:hidden;resize:none;font-size:13px}
  .condWrap{display:none;padding:5px 0 2px;border-top:1px dashed #e2e2e7;margin-top:3px}
  .condHdr{display:flex;align-items:center;gap:6px;margin-bottom:2px}
  .condTitle{font-weight:800;font-size:12px}
  .adder{border:none;border-radius:999px;background:#111;color:#fff;width:20px;height:20px;cursor:pointer}
  .condItem{display:flex;gap:4px;align-items:center;margin:3px 0}
  .condText{flex:1;border:1px solid #e5e7eb;border-radius:8px;padding:6px 7px;min-height:28px;font-size:12px;overflow:hidden;resize:none}
  .condDel{border:none;background:#eef0f3;border-radius:999px;width:18px;height:18px;cursor:pointer}
  .arrowV{opacity:.5;text-align:center;margin:2px 0;font-size:12px}
  .arrowV::before{content:"";display:block;width:2px;background:#cfcfd4;height:6px;margin:0 auto 2px;border-radius:2px}
  /* Conectores */
  .flow .row{position:relative}
  .flow .row .bubble{position:relative}
  .flow .row:not(:last-child) .bubble::after{content:"";position:absolute;left:50%;transform:translateX(-50%);top:20px;width:2px;height:calc(100% + 12px);background:#cfcfd4;border-radius:2px;pointer-events:none;z-index:0}
  .flow .row:not(:last-child)::after{content:"‚Üì";position:absolute;left:12px;bottom:-10px;font-size:12px;opacity:.6;color:#b63a3a;pointer-events:none;z-index:0}
  @media print{body *{visibility:hidden!important} #printDoc,#printDoc *{visibility:visible!important} #printDoc{position:absolute;inset:0;background:#fff;color:#000;padding:12px} .pbreak{page-break-after:always}}
  .procRow:hover{border-color:#b63a3a}
</style>
</head>
<body>
  <div class="top">
    <h1>üéß PROCESOS AUDIO</h1>
    <input class="search" placeholder="Buscar‚Ä¶" oninput="doSearch(this.value)">
    <div class="iconbar">
      <button class="ticon" title="Descargar HTML" onclick="downloadHTML()">‚¨áÔ∏è HTML</button>
      <button class="ticon" title="Imprimir / PDF" onclick="printAll()">üñ®Ô∏è</button>
      <button class="ticon" title="Guardar en nube" onclick="saveCloud()">‚òÅÔ∏è‚¨ÜÔ∏è</button>
      <button class="ticon" title="Actualizar desde nube" onclick="loadCloud()">‚òÅÔ∏èüîÑ</button>
      <button id="pinBtn" class="ticon" title="PIN" onclick="togglePin()">üîí</button>
      <button id="saveBtn" class="btnTop" onclick="saveMeta()">üíæ Guardar</button>
    </div>
  </div>

  <div class="layout">
    <div class="panel">
      <!-- Bot√≥n + PROCESOS con el MISMO estilo que + Subproceso, alineado al extremo derecho -->
      <header class="leftHdr">
        <div class="right-actions" style="justify-content:flex-end;width:100%">
          <button class="btnTop" onclick="addProcess()">+ PROCESOS</button>
        </div>
      </header>
      <div class="body" id="procList"></div>
    </div>

    <div class="panel">
      <header id="rHeader">
        <span></span>
        <div class="right-actions">
          <button class="btnTop" onclick="addSub()">+ Subproceso</button>
          <button class="btnTop" onclick="addStepProcess()">+ Paso</button>
        </div>
      </header>
      <div class="body" id="rightBody"></div>
    </div>
  </div>

  <div id="printDoc" style="display:none"></div>

<script>
/* ======= Estado ======= */
const LS='PROC_COMPACT_PRO_V13_FIX';
const CLOUD_KEY=LS+'_CLOUD';
const PIN_CODE='AR4321';
const ROLES=['Audi√≥logo','Responsable','Otros'];
const PASTEL=['#ffd1dc','#c6e2ff','#caffb7','#ffeec6','#e0c6ff','#ffecd1','#c2f0e8','#fff9c6'];
function uid(){return Math.random().toString(36).slice(2,9);} 
let data=safeLoad(); let selPid=(data[0]&&data[0].id)||null; let ctxSubId=null; let q=''; let dragCtx=null;
const byId=id=>document.getElementById(id); const save=()=>localStorage.setItem(LS,JSON.stringify(data));
function doSearch(v){q=(v||'').toLowerCase();render();}
function lighten(hex,f=0.86){const c=hex.replace('#','');const r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16);const nr=Math.round(r+(255-r)*f),ng=Math.round(g+(255-g)*f),nb=Math.round(b+(255-b)*f);return `rgb(${nr},${ng},${nb})`;}
function autoGrow(el){if(!el)return;el.style.height='auto';el.style.height=(el.scrollHeight+2)+'px';}
function safeLoad(){try{const raw=localStorage.getItem(LS);if(!raw)return seed();const o=JSON.parse(raw);o.forEach(p=>{p.sub=p.sub||[];p.steps=p.steps||[]});return o;}catch{return seed(true);}}
function seed(store){const d=[{id:uid(),name:'Revisi√≥n auditiva',color:PASTEL[0],desc:'',sub:[],steps:[{id:uid(),name:'Nuevo paso',desc:'',resp:ROLES[0],yes:[],no:[]}]}];if(store)localStorage.setItem(LS,JSON.stringify(d));return d;}
/* ======= Topbar ======= */
function togglePin(){const ok=sessionStorage.getItem(LS+'_PIN')==='1';if(ok){sessionStorage.removeItem(LS+'_PIN');byId('pinBtn').textContent='üîí';return;}const p=prompt('Introduce PIN');if(p===PIN_CODE){sessionStorage.setItem(LS+'_PIN','1');byId('pinBtn').textContent='üîì';}else alert('PIN incorrecto');}
const requirePin=()=>sessionStorage.getItem(LS+'_PIN')==='1';
function downloadHTML(){const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='procesos.html';a.click();URL.revokeObjectURL(a.href);} 
function saveCloud(){if(!requirePin())return alert('PIN requerido');localStorage.setItem(CLOUD_KEY,JSON.stringify({ts:Date.now(),data}));alert('Guardado en nube (simulada).');}
function loadCloud(){if(!requirePin())return alert('PIN requerido');const raw=localStorage.getItem(CLOUD_KEY);if(!raw)return alert('No hay copia');try{const obj=JSON.parse(raw);data=obj.data;selPid=data[0]?.id||null;ctxSubId=null;render();}catch{alert('Copia corrupta');}}
/* ======= Procesos izquierda ======= */
function addProcess(){data.push({id:uid(),name:'Nuevo proceso',color:PASTEL[Math.floor(Math.random()*PASTEL.length)],desc:'',sub:[],steps:[]});selPid=data[data.length-1].id;ctxSubId=null;render();}
function moveProcess(idx,delta){const to=idx+delta;if(to<0||to>=data.length)return;const it=data.splice(idx,1)[0];data.splice(to,0,it);render();}
function renderLeft(){const box=byId('procList');box.innerHTML='';
  let list=data.slice();if(q)list=list.filter(p=>p.name.toLowerCase().includes(q)||(p.desc||'').toLowerCase().includes(q));
  list.forEach((p,idx)=>{const row=document.createElement('div');row.className='procRow'+(p.id===selPid?' active':'');row.style.background='linear-gradient(180deg,#fff,'+lighten(p.color,.88)+')';row.style.borderColor=p.color;row.style.borderLeft='6px solid '+p.color;row.draggable=true;
    row.addEventListener('dragstart',()=>{dragCtx={type:'process',index:idx};});row.addEventListener('dragover',e=>e.preventDefault());row.addEventListener('drop',e=>{e.preventDefault();if(dragCtx?.type==='process'&&dragCtx.index!==idx){const it=data.splice(dragCtx.index,1)[0];data.splice(idx,0,it);render();}});
    const title=document.createElement('input');title.className='pTitle';title.value=p.name;title.oninput=e=>{p.name=e.target.value;save();};row.appendChild(title);
    const tiny=document.createElement('div');tiny.className='tiny';
    tiny.append(ico('üñâ','Editar',()=>{title.focus();title.select();}),ico('‚ñæ','Detalle',()=>{toggleDesc(p.id);}),ico('‚àí','Eliminar',()=>{if(confirm('¬øEliminar proceso?')){data=data.filter(x=>x.id!==p.id);selPid=data[0]?.id||null;render();}}),ico('‚Üë','Arriba',()=>moveProcess(idx,-1)),ico('‚Üì','Abajo',()=>moveProcess(idx,1)));
    row.appendChild(tiny);
    row.onclick=()=>{selPid=p.id;ctxSubId=null;renderRight();document.querySelectorAll('.procRow').forEach(el=>el.classList.remove('active'));row.classList.add('active');document.querySelectorAll('[id^="d_"]').forEach(el=>el.style.display='none');const det=byId('d_'+p.id);if(det){det.style.display='block';const ta=det.querySelector('textarea');autoGrow(ta);} };
    box.appendChild(row);
    const detail=document.createElement('div');detail.style.display=(p.id===selPid)?'block':'none';detail.style.margin='4px 0 6px';detail.style.background=lighten(p.color,.95);detail.style.border='1px solid '+lighten(p.color,.8);detail.style.borderRadius='8px';const ta=document.createElement('textarea');ta.style.width='100%';ta.style.minHeight='96px';ta.style.border='1px solid #e6e6e6';ta.style.borderRadius='8px';ta.style.padding='6px';ta.value=p.desc||'';ta.oninput=ev=>{p.desc=ev.target.value;autoGrow(ta);save();};autoGrow(ta);detail.appendChild(ta);box.appendChild(detail);row.dataset.detailId='d_'+p.id;detail.id='d_'+p.id; if(p.id===selPid){setTimeout(()=>autoGrow(ta),0);}
  });
}
function toggleDesc(pid){const el=byId('d_'+pid);if(!el)return;const open=el.style.display!=='block';el.style.display=open?'block':'none';if(open){const ta=el.querySelector('textarea');autoGrow(ta);}}
/* ======= Derecha ======= */
function addSub(){const p=data.find(x=>x.id===selPid);if(!p)return alert('Selecciona un proceso');p.sub.push({id:uid(),title:'Nuevo subproceso',desc:'',resp:ROLES[0],steps:[]});ctxSubId=p.sub[p.sub.length-1].id;renderRight();}
function addStepProcess(){const p=data.find(x=>x.id===selPid);if(!p)return alert('Selecciona un proceso');p.steps.push({id:uid(),name:'Nuevo paso',desc:'',resp:ROLES[0],yes:[],no:[]});ctxSubId=null;renderRight();}
function renderRight(){
  const body=byId('rightBody'); body.innerHTML='';
  const p=data.find(x=>x.id===selPid); if(!p)return;
  // Tinte sutil del proceso origen en el panel derecho
  try{ body.style.background = 'linear-gradient(180deg,'+lighten(p.color,.985)+',#ffffff)'; body.style.borderLeft='4px solid '+lighten(p.color,.78); }catch{}
  const sub=ctxSubId ? p.sub.find(s=>s.id===ctxSubId) : null;

  // Cabecera ANCLADA del subproceso seleccionado
  if(sub){
    const header=document.createElement('div'); header.className='row';
    const chip=document.createElement('div'); chip.className='chip';
    const tag=document.createElement('span'); tag.className='tag'; tag.textContent='Sub-proceso';
    const t=document.createElement('input'); t.className='title subTitle'; t.value=sub.title||'Subproceso'; t.oninput=e=>{sub.title=e.target.value;save();};
    const right=document.createElement('div'); right.className='rightPack';
    const role=miniSel(sub); right.append(role);
    chip.append(tag,t,right); header.appendChild(chip);
    // + Paso compacto pegado al t√≠tulo del subproceso
    const inlineAdd=document.createElement('button'); inlineAdd.className='adder'; inlineAdd.textContent='+'; inlineAdd.title='A√±adir paso al subproceso'; inlineAdd.style.margin='4px 0 0 26px';
    inlineAdd.onclick=()=>{(sub.steps||(sub.steps=[])).push({id:uid(),name:'Nuevo paso',resp:ROLES[0],yes:[],no:[]});renderRight();};
    header.appendChild(inlineAdd); body.appendChild(header);
  }

  // PASOS: siempre debajo de la cabecera del subproceso (si existe)
  const card=document.createElement('div'); card.className='card flow'; card.style.padding='5px';
  // Fondo del contenedor de pasos con color del proceso + gris
  card.style.background = 'linear-gradient(180deg,'+lighten(p.color,.92)+', #f7f7f7)'; card.style.borderColor = lighten(p.color,.75);
  const list=sub ? (sub.steps||[]) : p.steps;
  list.forEach((st,i)=>{ card.appendChild(stepRow(p,sub,st,i)); });
  body.appendChild(card);

  // Listado de subprocesos solo si NO hay uno seleccionado
  if(!sub && p.sub.length){
    const g=document.createElement('div'); g.className='card green'; g.style.marginTop='6px';
    // Lista de subprocesos tambi√©n con tinte del proceso
    g.style.background = 'linear-gradient(180deg,'+lighten(p.color,.95)+', #f7f7f7)'; g.style.borderColor = lighten(p.color,.78);
    p.sub.forEach((s,idx)=> g.appendChild(subMini(p,s,idx)) );
    body.appendChild(g);
  }
}
/* ======= Paso ======= */
function normalize(list){if(!Array.isArray(list))return [];return list.map(x=>typeof x==='string'?{id:uid(),text:x}:(x.id?x:{id:uid(),...x}));}
function badge(pid,prefix='IR AL PROCESO: '){const tgt=data.find(p=>p.id===pid);if(!tgt)return null;const el=document.createElement('span');el.className='nextBadge';el.textContent=prefix+tgt.name;el.style.background=lighten(tgt.color,.55);el.style.border='1px solid '+lighten(tgt.color,.35);return el;}
function stepRow(proc,sub,st,i){
  const list=sub?(sub.steps||[]):proc.steps;
  const row=document.createElement('div'); row.className='row'; row.draggable=true; row.style.borderColor=lighten(proc.color,.85);
  row.addEventListener('dragstart',()=>{dragCtx={type:'step',pid:proc.id,subId:sub?.id||null,index:i};});
  row.addEventListener('dragover',e=>e.preventDefault());
  row.addEventListener('drop',e=>{e.preventDefault();if(dragCtx?.type!=='step')return;const same=dragCtx.pid===proc.id&&(dragCtx.subId||null)===(sub?.id||null);if(!same)return;const from=dragCtx.index,to=i;if(from===to)return;const it=list.splice(from,1)[0];list.splice(to,0,it);renderRight();});

  const chip=document.createElement('div'); chip.className='chip';
  // Sutileza del color del proceso en el chip
  chip.style.background = 'linear-gradient(180deg,#ffffff,'+lighten(proc.color,.97)+')';
  const num=document.createElement('div'); num.className='bubble'; num.textContent=i+1;
  const title=document.createElement('input'); title.className='title'; title.value=st.name||'Paso'; title.oninput=e=>{st.name=e.target.value;save();};
  const right=document.createElement('div'); right.className='rightPack';

  const iEdit=ico('üñâ','Editar',()=>{title.focus();title.select();});
  const iLink=ico('üîó','Enlace',()=>{const u=prompt('Pega enlace',st.link||'');if(u!==null){st.link=u;save();renderRight();}});
  const fin=document.createElement('input'); fin.type='file'; fin.style.display='none'; fin.onchange=e=>{const f=e.target.files?.[0];if(f){st.doc=f.name;save();renderRight();}};
  const iDoc=ico('üìé','Documento',()=>fin.click());
  const iGoto=ico('üö©','Pr√≥ximo proceso',()=>{pick(st.nextPid,v=>{st.nextPid=v;save();renderRight();});});
  const iSiNo=ico('‚ùì','Si/No'); iSiNo.style.background='#111'; iSiNo.style.color='#fff';
  const iDel=ico('‚àí','Eliminar',()=>{if(confirm('¬øEliminar paso?')){const pos=list.indexOf(st);list.splice(pos,1);renderRight();}});
  right.append(iEdit,iLink,iDoc,iGoto,iDel,iSiNo,fin);

  /* Iconos en pastel */
  iEdit.style.background='#bfdbfe'; iEdit.style.color='#1f2937';
  iLink.style.background='#ddd6fe'; iLink.style.color='#1f2937';
  iDoc.style.background='#e2e8f0'; iDoc.style.color='#1f2937';
  iGoto.style.background='#fed7aa'; iGoto.style.color='#1f2937';
  iDel.style.background='#fecaca'; iDel.style.color='#1f2937';

  const role=miniSel(st); right.append(role);
  if(st.nextPid){const b=badge(st.nextPid); if(b) right.append(b);}
  if(st.meta){const meta=ico('üéØ','Meta cumplida'); meta.style.background='#ffe3a6'; right.append(meta);}

  chip.append(num,title,right); row.appendChild(chip);

  /* Si/No + detalle */
  st.yes=normalize(st.yes); st.no=normalize(st.no);
  const cond=condBlock(st);
  const hasActive=((st.yes&&st.yes.length)>0)||!!st.yesNextPid||((st.no&&st.no.length)>0)||!!st.noNextPid;
  if(hasActive){ cond.style.display='block'; }
  iSiNo.onclick=()=>{
    const active=((st.yes&&st.yes.length)>0)||!!st.yesNextPid||((st.no&&st.no.length)>0)||!!st.noNextPid;
    if(active){ cond.style.display='block'; return; }
    cond.style.display = (cond.style.display==='block') ? 'none' : 'block';
  };
  row.appendChild(cond);

  const detail=document.createElement('div'); detail.className='detail';
  const tx=document.createElement('textarea'); tx.value=st.desc||''; tx.oninput=e=>{st.desc=e.target.value;autoGrow(tx);save();};
  autoGrow(tx); detail.appendChild(tx);

  const toggleDetail=()=>{const open=detail.style.display!=='block';detail.style.display=open?'block':'none';if(open)autoGrow(tx);};
  const iDetail=ico('‚ñæ','Detalle',toggleDetail); iDetail.style.background='#6b7280'; iDetail.style.color='#fff';
  right.prepend(iDetail);

  chip.addEventListener('click',(e)=>{ if(e.target.closest('.ico')|| e.target.tagName==='SELECT' || e.target===title) return; toggleDetail(); });
  chip.addEventListener('dblclick',toggleDetail);
  num.onclick=toggleDetail; title.ondblclick=toggleDetail;

  return row;
}
function miniSel(obj){const sel=document.createElement('select');sel.className='miniSel';ROLES.forEach(r=>{const o=document.createElement('option');o.value=r;o.textContent=r;sel.appendChild(o);});sel.value=obj.resp||ROLES[0];sel.onchange=e=>{obj.resp=e.target.value;save();};return sel;}
function ico(g,t,fn){const b=document.createElement('button');b.className='ico sm';b.title=t;b.textContent=g;if(fn)b.onclick=(ev)=>{ev.stopPropagation();fn(ev);};return b;}
/* S√≠/No por rama */
function condBlock(st){
  const wrap=document.createElement('div'); wrap.className='condWrap';
  wrap.append(oneSide('Si NO‚Ä¶','no',st));
  wrap.append(oneSide('Si S√ç‚Ä¶','yes',st));
  return wrap;
}
function oneSide(title,branch,st){
  const b=document.createElement('div');
  const hdr=document.createElement('div'); hdr.className='condHdr';
  const t=document.createElement('div'); t.className='condTitle'; t.textContent=title;

  const key=branch+'NextPid';
  const hdrFlag=ico('üö©','Pr√≥ximo proceso para '+title,()=>{ pick(st[key],v=>{ st[key]=v; save(); renderRight(); }); });
  hdrFlag.style.color='#fff';
  function applyFlagStyle(){ const on=!!st[key]; hdrFlag.style.background= on ? '#16a34a' : '#ea580c'; }
  applyFlagStyle();

  const plus=document.createElement('button'); plus.className='adder'; plus.textContent='+'; plus.title='A√±adir condici√≥n a '+title;
  const list=(st[branch]||(st[branch]=[]));
  plus.onclick=()=>{ list.push({id:uid(),text:''}); renderRight(); };

  hdr.append(t,hdrFlag,plus);
  if(st[key]){ const bb=badge(st[key],'IR AL PROCESO: '); if(bb) hdr.appendChild(bb); }
  b.appendChild(hdr);

  (list||[]).forEach(it=>{
    const r=document.createElement('div'); r.className='condItem';
    const tx=document.createElement('textarea'); tx.className='condText'; tx.placeholder='Escribe‚Ä¶';
    tx.value=it.text||''; tx.oninput=e=>{it.text=e.target.value;autoGrow(tx);save();}; autoGrow(tx);
    const del=document.createElement('button'); del.className='condDel'; del.textContent='‚àí';
    del.onclick=()=>{ const idx=list.indexOf(it); if(idx>-1){ list.splice(idx,1); renderRight(); } };
    r.append(tx,del); b.appendChild(r);
  });
  return b;
}
/* Subprocesos */
function subMini(proc,s,idx){
  const row=document.createElement('div'); row.className='row'; row.draggable=true;
  row.addEventListener('dragstart',()=>{dragCtx={type:'sub',pid:proc.id,index:idx};});
  row.addEventListener('dragover',e=>e.preventDefault());
  row.addEventListener('drop',e=>{e.preventDefault();if(dragCtx?.type!=='sub'||dragCtx.pid!==proc.id)return;const it=proc.sub.splice(dragCtx.index,1)[0];proc.sub.splice(idx,0,it);renderRight();});

  const chip=document.createElement('div'); chip.className='chip';
  const b=document.createElement('div'); b.className='bubble'; b.textContent=idx+1;
  const t=document.createElement('input'); t.className='title subTitle'; t.value=s.title||'Subproceso'; t.oninput=e=>{s.title=e.target.value;save();};
  const right=document.createElement('div'); right.className='rightPack';
  const edit=ico('üñâ','Editar',()=>{t.focus();t.select();});
  const del=ico('‚àí','Eliminar',()=>{if(confirm('¬øEliminar subproceso?')){proc.sub=proc.sub.filter(x=>x!==s);if(ctxSubId===s.id)ctxSubId=null;renderRight();}});
  const role=miniSel(s);
  right.append(edit,del,role);
  chip.append(b,t,right); row.appendChild(chip);

  const add=document.createElement('button'); add.textContent='+ Paso'; add.className='adder'; add.style.margin='5px 0 0 26px';
  add.onclick=()=>{(s.steps||(s.steps=[])).push({id:uid(),name:'Nuevo paso',resp:ROLES[0],yes:[],no:[]});ctxSubId=s.id;renderRight();};
  row.appendChild(add);

  chip.onclick=()=>{ctxSubId=s.id;renderRight();};
  return row;
}
/* Picker */
function pick(current,onPick){
  const o=document.createElement('div');
  Object.assign(o.style,{position:'fixed',inset:0,background:'rgba(0,0,0,.45)',display:'grid',placeItems:'center',zIndex:9990});
  const card=document.createElement('div');
  Object.assign(card.style,{background:'#fff',padding:'12px',borderRadius:'10px',boxShadow:'0 14px 38px rgba(0,0,0,.2)',width:'min(92vw,420px)'});
  const h=document.createElement('div'); h.textContent='Selecciona proceso de destino'; h.style.fontWeight='800'; h.style.marginBottom='6px';

  const sel=document.createElement('select'); sel.style.width='100%'; sel.style.padding='8px'; sel.style.border='1px solid #ddd'; sel.style.borderRadius='8px';
  data.forEach(p=>{const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name; opt.dataset.color=p.color; sel.appendChild(opt);});
  sel.value=current||data[0].id;

  const preview=document.createElement('div'); preview.style.display='flex'; preview.style.alignItems='center'; preview.style.gap='8px'; preview.style.margin='8px 0 4px';
  const dot=document.createElement('span'); Object.assign(dot.style,{display:'inline-block',width:'14px',height:'14px',borderRadius:'999px',border:'1px solid #bbb'});
  const badgePreview=document.createElement('span'); badgePreview.className='nextBadge';

  function updatePreview(){
    const id=sel.value; const tgt=data.find(p=>p.id===id) || data[0]; if(!tgt) return;
    dot.style.background=tgt.color;
    badgePreview.textContent='IR AL PROCESO: '+tgt.name;
    badgePreview.style.background=lighten(tgt.color,.55);
    badgePreview.style.border='1px solid '+lighten(tgt.color,.35);
  }
  sel.addEventListener('change',updatePreview); updatePreview();
  preview.append(dot,badgePreview);

  const bar=document.createElement('div'); bar.style.display='flex'; bar.style.justifyContent='flex-end'; bar.style.gap='8px'; bar.style.marginTop='8px';
  const cancel=document.createElement('button'); cancel.textContent='Cancelar'; cancel.className='btnTop'; cancel.style.background='#ddd'; cancel.style.color='#000'; cancel.onclick=()=>document.body.removeChild(o);
  const ok=document.createElement('button'); ok.textContent='Aceptar'; ok.className='btnTop'; ok.style.background='#b63a3a'; ok.style.color='#fff'; ok.onclick=()=>{onPick(sel.value); document.body.removeChild(o);};
  bar.append(cancel,ok);

  card.append(h,sel,preview,bar); o.appendChild(card); document.body.appendChild(o);
}
/* Meta */
function saveMeta(){const p=data.find(x=>x.id===selPid);if(!p)return;const list=ctxSubId?((p.sub.find(s=>s.id===ctxSubId)||{}).steps||[]):p.steps;if(list.length){list.forEach((s,k)=>s.meta=(k===list.length-1));}save();renderRight();}
/* Print */
function printAll(){
  const wrap=byId('printDoc'); wrap.innerHTML=''; const root=document.createElement('div');
  data.forEach((proc,pi)=>{
    const pBox=document.createElement('div');
    const h2=document.createElement('h2'); h2.textContent=(pi+1)+'. '+proc.name; h2.style.margin='0 0 6px'; h2.style.borderBottom='2px solid #000'; pBox.appendChild(h2);
    if(proc.desc){ const d=document.createElement('p'); d.textContent='Descripci√≥n: '+proc.desc; pBox.appendChild(d); }
    if(proc.steps.length){ const h=document.createElement('h3'); h.textContent='Pasos'; pBox.appendChild(h); proc.steps.forEach((st,si)=>pBox.appendChild(printStep(st,si))); }
    if(proc.sub.length){
      const h=document.createElement('h3'); h.textContent='Subprocesos'; pBox.appendChild(h);
      proc.sub.forEach((sp,qi)=>{ const sb=document.createElement('div'); const sh=document.createElement('h4'); sh.textContent=(pi+1)+'.S'+(qi+1)+' '+sp.title; sb.appendChild(sh); (sp.steps||[]).forEach((st,si)=>sb.appendChild(printStep(st,si))); pBox.appendChild(sb); });
    }
    if(pi < data.length-1){ const cut=document.createElement('div'); cut.className='pbreak'; pBox.appendChild(cut); }
    root.appendChild(pBox);
  });
  wrap.appendChild(root); wrap.style.display='block';
  setTimeout(()=>{ window.print(); wrap.style.display='none'; wrap.innerHTML=''; },40);
}
function printStep(st,si){
  const box=document.createElement('div'); box.style.border='1px solid #ddd'; box.style.borderRadius='8px'; box.style.padding='6px 8px'; box.style.margin='4px 0';
  const h=document.createElement('div'); h.style.fontWeight='800'; h.textContent='Paso '+(si+1)+': '+(st.name||''); box.appendChild(h);
  const r=document.createElement('div'); r.textContent='Responsable: '+(st.resp||'‚Äî'); r.style.fontSize='12px'; r.style.opacity='.85'; box.appendChild(r);
  if(st.desc){const d=document.createElement('div');d.textContent='Descripci√≥n: '+st.desc;box.appendChild(d);} 
  if(st.link){const l=document.createElement('div');l.textContent='Enlace: '+st.link;box.appendChild(l);} 
  if(st.doc){const d2=document.createElement('div');d2.textContent='Documento: '+st.doc;box.appendChild(d2);} 
  if(st.nextPid){const b=badge(st.nextPid); if(b){const w=document.createElement('div');w.appendChild(b);box.appendChild(w);}}
  if(st.no && st.no.length){ const t=document.createElement('div'); t.textContent='Si NO:'; box.appendChild(t); st.no.forEach(i=>{ const li=document.createElement('div'); li.textContent='- '+i.text; box.appendChild(li); }); if(st.noNextPid){ const bb=badge(st.noNextPid,'IR AL PROCESO: '); if(bb){ const w=document.createElement('div'); w.appendChild(bb); box.appendChild(w);} } }
  if(st.yes && st.yes.length){ const t2=document.createElement('div'); t2.textContent='Si S√ç:'; box.appendChild(t2); st.yes.forEach(i=>{ const li2=document.createElement('div'); li2.textContent='- '+i.text; box.appendChild(li2); }); if(st.yesNextPid){ const bb2=badge(st.yesNextPid,'IR AL PROCESO: '); if(bb2){ const w2=document.createElement('div'); w2.appendChild(bb2); box.appendChild(w2);} } }
  if(st.meta){const m=document.createElement('span');m.textContent='  üéØ';h.appendChild(m);} 
  return box;
}
/* Render */
function render(){renderLeft();renderRight();save();}
render();
window.addEventListener('keydown',e=>{if(e.key==='Enter'){const a=document.activeElement;if(a&&(a.tagName==='INPUT'||a.tagName==='TEXTAREA')){e.preventDefault();a.blur();save();}}});
/* Tests m√≠nimos */
(function(){const ok=(n,b)=>console[b?'log':'error']('TEST '+(b?'‚úî':'‚úñ')+' '+n);try{ok('uid',typeof uid==='function');const prev=data.length;addProcess();ok('addProcess',data.length===prev+1);data.pop();selPid=data[0].id;render();}catch(e){console.error(e);}})();
</script>
</body>
</html>
