<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>üéß PROCESOS AUDIO</title>
<style>
  :root{
    --bg:#eceff3;           /* antes #f6f7f9 ‚Üí m√°s gris */
    --ink:#0f1115;
    --mut:#6b7280;
    --grad:linear-gradient(90deg,#6a6a6a,#b63a3a,#2e2e2e);
    --panel:#f3f4f8;        /* antes blanco */
    --card:#f7f8fb;         /* tarjetas suavemente grises */
    --inset:#f5f7fb;
    --line:#cfcfd4;
    --sh-l1:0 1px 0 #fff inset, 0 1px 2px rgba(0,0,0,.08);
    --sh-l2:0 2px 0 #e8eaf0, 0 8px 16px rgba(0,0,0,.08);
    --sh-in:0 2px 6px rgba(0,0,0,.06) inset;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

  /* TOPBAR */
  .top{display:flex;gap:0;align-items:center;padding:8px 10px;background:var(--grad);background-attachment:fixed;background-size:100vw 100%;background-position:0 0;color:#fff;box-shadow:var(--sh-l2)}
  .top h1{margin:0 8px 0 0;font-size:20px;font-weight:900;text-shadow:0 1px 0 rgba(0,0,0,.35);display:flex;align-items:center;gap:8px}
  .top h1 .logo{font-size:36px;line-height:1;filter:drop-shadow(0 1px 0 rgba(0,0,0,.25))}
  .top h1 .title-text{letter-spacing:.2px}
  .search{flex:1 1 520px;max-width:740px;border:1px solid rgba(255,255,255,.35);border-radius:999px;background:rgba(255,255,255,.18);padding:6px 12px;color:#fff;box-shadow:var(--sh-l1)}
  .last{margin:0 8px;font-size:12px;opacity:.85}
  .iconbar{display:flex;gap:6px;margin-left:auto}
  .ticon,.btnTop{border:1px solid rgba(255,255,255,.35);border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.25),rgba(255,255,255,.12));color:#fff;padding:6px 9px;cursor:pointer;line-height:1;box-shadow:var(--sh-l2)}
  .btnTop{padding:6px 12px}
  .ticon:active,.btnTop:active{transform:translateY(1px);box-shadow:0 1px 0 rgba(0,0,0,.1)}

  /* LAYOUT */
  .layout{display:grid;grid-template-columns:1fr 2fr;gap:0;padding:0;min-height:calc(100vh - 48px);background:var(--grad);background-attachment:fixed;background-size:100% 100%;background-position:0 0}
  @media(max-width:1024px){.layout{grid-template-columns:1fr}}
  .panel{background:transparent;border-radius:0;display:flex;flex-direction:column;min-width:0}
  .panel>header{padding:6px 8px;background:transparent;color:#fff;border-radius:0;display:flex;justify-content:space-between;align-items:center;font-weight:800;min-height:44px}
  .leftHdr{min-height:44px;height:44px;background:transparent;padding:0;margin:0}
  #procList{padding-top:12px}
  .body{padding:6px;overflow:auto;flex:1;background:var(--panel);border-radius:12px;box-shadow:var(--sh-l2)}

  /* PROCESOS IZQ (3D compact) */
  .procRow{display:flex;align-items:center;gap:8px;padding:9px 10px;border:1px solid #e0e4ec;border-radius:12px;background:linear-gradient(180deg,#fdfefe,#eef1f6);margin-bottom:9px;cursor:grab;box-shadow:var(--sh-l2);position:relative}
  .procRow:active{cursor:grabbing}
  .procRow.active{border-width:2px;box-shadow:0 0 0 2px rgba(0,0,0,.06), var(--sh-l2)}
  .pTitle{border:1px solid #dfe3ea;background:linear-gradient(180deg,#ffffff,#f4f6f9);box-shadow:var(--sh-in);font-weight:800;font-size:14px;flex:1 1 92%;min-width:0;line-height:1.2;border-radius:8px;padding:4px 6px}
  .tiny{display:flex;gap:4px}
  .ico{border:1px solid #dfe3ea;background:linear-gradient(180deg,#fafbfc,#eceff4);border-radius:8px;min-width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;box-shadow:var(--sh-l2);user-select:none}
  .ico:active{transform:translateY(1px)}
  .ico:focus-visible{outline:2px solid #b63a3a}
  .ico.del{display:none}

  /* DERECHA (3D) */
  #rHeader{background:transparent}
  .right-actions{display:flex;gap:6px;align-items:center}

  /* TARJETAS */
  .card{border-radius:12px;border:1px solid #dcdfe7;background:linear-gradient(180deg,#ffffff,#f0f2f7);padding:6px;box-shadow:var(--sh-l2)}
  .card.green{border-color:#cfe9df;background:linear-gradient(180deg,#ffffff,#eef7f5)}

  /* PASOS (3D compact) */
  .row{border:1px solid #dcdfe7;background:linear-gradient(180deg,#ffffff,#eef1f7);border-radius:10px;padding:3px 4px;margin:4px 0;cursor:grab;box-shadow:var(--sh-l2);position:relative}
  .row:active{cursor:grabbing}
  .rowSub{border:1px solid #dcdfe7;background:linear-gradient(180deg,#ffffff,#eef1f7);border-radius:10px;padding:3px 4px;margin:4px 0;box-shadow:var(--sh-l2)}
  .chip{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:5px;padding:5px 6px;border:1px solid #e6e8ec;border-radius:10px;background:linear-gradient(180deg,#ffffff,#f3f4f6);box-shadow:var(--sh-l1)}
  .bubble{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:999px;background:linear-gradient(180deg,#1f2937,#0b1020);border:1px solid #0b0f18;color:#fff;font-weight:900;font-size:9px;box-shadow:var(--sh-l2);position:relative;z-index:2}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:linear-gradient(180deg,#4b4b4b,#2b2b2b);border:1px solid #5a5a5a;color:#fff;font-weight:800;font-size:11px;box-shadow:var(--sh-l2)}
  .title{border:1px solid #dfe3ea;background:linear-gradient(180deg,#ffffff,#f4f6f9);box-shadow:var(--sh-in);font-weight:800;width:100%;min-width:0;font-size:13px;border-radius:8px;padding:4px 6px}
  .subTitle{background:linear-gradient(180deg,#4b4b4b,#2b2b2b);border:1px solid #5a5a5a;border-radius:8px;padding:6px 8px;color:#fff;box-shadow:var(--sh-l2)}
  .subTitle:focus{outline:2px solid #444;box-shadow:0 0 0 2px #222 inset}
  .rightPack{display:flex;align-items:center;gap:4px;flex-wrap:wrap;justify-self:end}
  .ico.sm{min-width:22px;height:22px;font-size:12px}
  .miniSel{border:1px solid #dfe3ea;border-radius:999px;padding:3px 8px;font-size:11px;background:linear-gradient(180deg,#ffffff,#f4f6f9);box-shadow:var(--sh-in)}
  .nextBadge{font-weight:800;border-radius:999px;padding:2px 6px;border:1px solid #bbb;background:linear-gradient(180deg,#ffffff,#eef0f3);color:#111;max-width:clamp(160px,50vw,640px);white-space:normal;word-break:break-word;line-height:1.1;box-shadow:var(--sh-l1)}
  .detail{display:none;padding:4px 2px 2px}
  .detail textarea{width:100%;min-height:40px;border:1px solid #dfe3ea;border-radius:8px;padding:6px 7px;overflow:hidden;resize:none;font-size:13px;background:var(--inset);box-shadow:var(--sh-in)}

  /* Si/No */
  .condWrap{display:none;padding:5px 0 2px;border-top:1px dashed #e2e2e7;margin-top:3px;margin-left:calc(var(--line-x,42px) + 14px)}
  .condHdr{display:flex;align-items:center;gap:6px;margin-bottom:2px}
  .condTitle{font-weight:800;font-size:12px}
  .adder{border:1px solid #dfe3ea;border-radius:999px;background:linear-gradient(180deg,#ffffff,#f4f6f9);color:#111;min-width:22px;height:22px;cursor:pointer;box-shadow:var(--sh-l2);user-select:none}
  .condItem{display:flex;gap:4px;align-items:center;margin:3px 0}
  .condText{flex:1;border:1px solid #dfe3ea;border-radius:8px;padding:6px 7px;min-height:28px;font-size:12px;overflow:hidden;resize:none;background:var(--inset);box-shadow:var(--sh-in)}
  .condDel{border:1px solid #dfe3ea;background:linear-gradient(180deg,#fafbfc,#eceff4);border-radius:999px;min-width:18px;height:18px;cursor:pointer;box-shadow:var(--sh-l2);user-select:none}
  .condNum{font-weight:900;margin-right:6px;color:#111;font-size:10px}
  .condChildren{margin-left:16px;border-left:2px dashed #c7ccd4;padding-left:10px}
  .branch-yes .condChildren{border-left-color:#a7f3d0}
  .branch-no .condChildren{border-left-color:#fecaca}
  .branch-yes .condNum{color:#166534}
  .branch-no .condNum{color:#7c2d12}

  /* Conectores: n√∫mero a n√∫mero */
  .flow .row .bubble{position:relative;z-index:2}
  .flow .row .bubble::after{content:"";position:absolute;left:50%;transform:translateX(-50%);top:100%;width:2px;height:var(--conn-len,22px);background:var(--line);border-radius:2px;pointer-events:none;z-index:0}
  .flow .row:last-child .bubble::after{content:none}

  /* LOCK UI */
  body.locked .editOnly,
  body.locked .adder,
  body.locked .ico.del { display:none !important; }
  body.locked input.title,
  body.locked input.pTitle,
  body.locked textarea { pointer-events:none; background:linear-gradient(180deg,#f2f3f6,#e9ecf3); color:#555; }
  body.locked select.miniSel { pointer-events:none; opacity:.6; }

  @media print{body *{visibility:hidden!important} #printDoc,#printDoc *{visibility:visible!important} #printDoc{position:absolute;inset:0;background:#fff;color:#000;padding:12px} .pbreak{page-break-after:always}}
  .procRow:hover{border-color:#b63a3a}

  /* Mobile */
  @media(max-width:1024px){
    html,body{height:auto}
    .layout{grid-template-columns:1fr;min-height:auto}
    .panel{min-height:auto}
    .body{overflow:visible;max-height:none}
  }
  .bigFinish{font-weight:900;padding:8px 16px}
</style>
</head>
<body>
  <div class="top">
    <h1><span class="logo" aria-hidden="true">üéß</span><span class="title-text">PROCESOS AUDIO</span></h1>
    <input class="search" placeholder="Buscar‚Ä¶" oninput="doSearch(this.value)"> <span id="lastSaved" class="last">√öltima actualizaci√≥n: ‚Äî</span>
    <div class="iconbar">
      <button class="ticon" title="Descargar HTML" onclick="downloadHTML()">‚¨áÔ∏è HTML</button>
      <button class="ticon" title="Imprimir / PDF" onclick="printAll()">üñ®Ô∏è</button>
      <button class="ticon" title="Guardar en nube" onclick="saveCloud()">‚òÅÔ∏è‚¨ÜÔ∏è</button>
      <button class="ticon" title="Actualizar desde nube" onclick="loadCloud()">‚òÅÔ∏èüîÑ</button>
      <button id="pinBtn" class="ticon" title="PIN" onclick="togglePin()">üîí</button>
      <button id="saveBtn" class="btnTop editOnly" onclick="saveMeta()">üíæ Guardar</button>
    </div>
  </div>

  <div class="layout">
    <div class="panel">
      <header class="leftHdr">
        <div class="right-actions" style="justify-content:flex-end;width:100%">
          <button class="btnTop editOnly" onclick="addProcess()">+Procesos</button>
        </div>
      </header>
      <div class="body" id="procList"></div>
    </div>

    <div class="panel">
      <header id="rHeader">
        <span></span>
        <div class="right-actions">
          <button class="btnTop editOnly" onclick="addSub()">+ Subproceso</button>
          <button class="btnTop editOnly" onclick="addStepProcess()">+ Paso</button>
        </div>
      </header>
      <div class="body" id="rightBody"></div>
    </div>
  </div>

  <div id="printDoc" style="display:none"></div>

<script>
/* ======= Estado / Constantes ======= */
const LS='PROC_COMPACT_PRO_V14_SOLID';
const CLOUD_KEY=LS+'_CLOUD';
const PIN_CODE='AR4321';
const ROLES=['Audi√≥logo','Responsable','Otros'];
const PASTEL=['#ffd1dc','#c6e2ff','#caffb7','#ffeec6','#e0c6ff','#ffecd1','#c2f0e8','#fff9c6'];

function uid(){return Math.random().toString(36).slice(2,9);} 
const byId=id=>document.getElementById(id);
const canEdit=()=>sessionStorage.getItem(LS+'_PIN')==='1';
const save=()=>{ localStorage.setItem(LS,JSON.stringify(data)); updateLastSaved(); };

let data=safeLoad(); 
let selPid=(data[0]&&data[0].id)||null; 
let ctxSubId=null; 
let q=''; 
let dragCtx=null;

/* ======= Util ======= */
function updateLastSaved(){
  const el=byId('lastSaved'); if(!el) return;
  const d=new Date(); const pad=n=>String(n).padStart(2,'0');
  const ts=`${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  el.textContent='√öltima actualizaci√≥n: '+ts; localStorage.setItem(LS+'_STAMP', ts);
}
function doSearch(v){q=(v||'').toLowerCase();render();}
function lighten(hex,f=0.86){const c=hex.replace('#','');const r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16);const nr=Math.round(r+(255-r)*f),ng=Math.round(g+(255-g)*f),nb=Math.round(b+(255-b)*f);return `rgb(${nr},${ng},${nb})`;}
function autoGrow(el){if(!el)return;el.style.height='auto';el.style.height=(el.scrollHeight+2)+'px';}
function a11y(button, handler){
  button.tabIndex = 0;
  button.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); handler(e); });
  button.addEventListener('keydown', function(e){
    if(e.key==='Enter' || e.key===' '){ e.preventDefault(); e.stopPropagation(); handler(e); }
  });
}

/* ======= PRELOAD seguro + carga ======= */
function safeLoad(){
  try{
    if(window.__PRELOAD_DATA__ && !localStorage.getItem(LS)){
      const preloadObj = (typeof window.__PRELOAD_DATA__==='string')
        ? JSON.parse(window.__PRELOAD_DATA__)
        : window.__PRELOAD_DATA__;
      localStorage.setItem(LS, JSON.stringify(preloadObj));
      if(window.__PRELOAD_STAMP__) localStorage.setItem(LS+'_STAMP', window.__PRELOAD_STAMP__);
    }
    const raw=localStorage.getItem(LS);
    if(!raw) return seed(true);
    const o=JSON.parse(raw);
    o.forEach(p=>{p.sub=p.sub||[];p.steps=p.steps||[]});
    return o;
  }catch(e){
    if(window.__PRELOAD_DATA__){
      try{
        const o = (typeof window.__PRELOAD_DATA__==='string')
          ? JSON.parse(window.__PRELOAD_DATA__)
          : window.__PRELOAD_DATA__;
        localStorage.setItem(LS, JSON.stringify(o));
        return o;
      }catch(_e){}
    }
    return seed(true);
  }
}
function seed(store){
  const d=[{id:uid(),name:'Revisi√≥n auditiva',color:PASTEL[0],desc:'',sub:[],steps:[{id:uid(),name:'Nuevo paso',desc:'',resp:ROLES[0],yes:[],no:[]}]}];
  if(store)localStorage.setItem(LS,JSON.stringify(d));
  return d;
}

/* ======= PIN / Lock ======= */
function togglePin(){
  const ok=canEdit();
  if(ok){ sessionStorage.removeItem(LS+'_PIN'); byId('pinBtn').textContent='üîí'; applyLockState(); return; }
  const p=prompt('Introduce PIN');
  if(p===PIN_CODE){ sessionStorage.setItem(LS+'_PIN','1'); byId('pinBtn').textContent='üîì'; applyLockState(); }
  else alert('PIN incorrecto');
}
function applyLockState(){
  const locked=!canEdit();
  document.body.classList.toggle('locked', locked);
  document.querySelectorAll('input, textarea, select').forEach(function(el){
    if(el.closest('.iconbar')) return;
    if(locked){ (el.tagName==='SELECT') ? el.setAttribute('disabled','') : el.setAttribute('readonly',''); }
    else { (el.tagName==='SELECT') ? el.removeAttribute('disabled') : el.removeAttribute('readonly'); }
  });
  document.querySelectorAll('.procRow,.row').forEach(function(el){ el.draggable = !locked; });
}

/* ======= Topbar ======= */
function downloadHTML(){
  const html=document.documentElement.outerHTML;
  const stamp=localStorage.getItem(LS+'_STAMP')||new Date().toISOString();
  const payload=JSON.stringify(data).replace(/</g,'\\u003C');
  const stampEsc=stamp.replace(/</g,'\\u003C').replace(/"/g,'\\"');
  const injector = '<script>(function(){try{'
    +'window.__PRELOAD_DATA__='+payload+';'
    +'window.__PRELOAD_STAMP__="'+stampEsc+'";'
    +'localStorage.setItem("'+LS+'",'+payload+');'
    +'localStorage.setItem("'+LS+'_STAMP","'+stampEsc+'");'
    +'}catch(e){}})();<' + '/script>';
  let final;
  if(html.includes('<head>')) final = html.replace('<head>', '<head>'+injector);
  else if(html.includes('</body>')) final = html.replace('</body>', injector+'</body>');
  else final = injector + html;
  const blob = new Blob([final], {type:'text/html'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='procesos.html'; a.click(); URL.revokeObjectURL(a.href);
}
function saveCloud(){ if(!canEdit()) return alert('Modo lectura. Desbloquea con PIN.'); localStorage.setItem(CLOUD_KEY,JSON.stringify({ts:Date.now(),data})); alert('Guardado en nube (simulada).'); }
function loadCloud(){ if(!canEdit()) return alert('Modo lectura. Desbloquea con PIN.'); const raw=localStorage.getItem(CLOUD_KEY); if(!raw) return alert('No hay copia'); try{const obj=JSON.parse(raw); data=obj.data; selPid=data[0]&&data[0].id||null; ctxSubId=null; render();}catch(_e){alert('Copia corrupta');} }

/* ======= Procesos izquierda ======= */
function addProcess(){ 
  if(!canEdit()) return alert('Modo lectura. Desbloquea con PIN.'); 
  data.push({id:uid(),name:'Nuevo proceso',color:PASTEL[Math.floor(Math.random()*PASTEL.length)],desc:'',sub:[],steps:[]}); 
  selPid=data[data.length-1].id; ctxSubId=null; render(); 
}
function renderLeft(){
  const box=byId('procList'); box.innerHTML='';
  let list=data.slice();
  if(q) list=list.filter(p=>p.name.toLowerCase().includes(q)||(p.desc||'').toLowerCase().includes(q));

  list.forEach(function(p,idxInList){
    const row=document.createElement('div');
    row.className='procRow'+(p.id===selPid?' active':'');
    row.style.background='linear-gradient(180deg,#fdfefe,'+lighten(p.color,.9)+')';
    row.style.borderColor=p.color; row.style.borderLeft='6px solid '+p.color;

    /* Drag & drop robusto con b√∫squeda: mapear a √≠ndices reales en data */
    row.draggable=!(!canEdit());
    row.addEventListener('dragstart',function(e){ 
      if(!canEdit()){ e.preventDefault(); return; } 
      dragCtx={ type:'process', id:p.id, from:data.findIndex(function(pp){return pp.id===p.id}) };
    });
    row.addEventListener('dragover',function(e){ e.preventDefault(); });
    row.addEventListener('drop',function(e){
      e.preventDefault();
      if(!canEdit()) return;
      if(!dragCtx || dragCtx.type!=='process') return;
      const from = dragCtx.from;
      const to   = data.findIndex(function(pp){ return pp.id===p.id; });
      if(from===-1 || to===-1 || from===to) return;
      const it=data.splice(from,1)[0];
      data.splice(to,0,it);
      render();
    });

    const title=document.createElement('input');
    title.className='pTitle';
    title.value=p.name;
    title.oninput=function(e){ if(!canEdit()) return; p.name=e.target.value; save(); };
    row.appendChild(title);

    const tiny=document.createElement('div'); tiny.className='tiny';

    const editIco=ico('üñâ','Editar',function(){ if(!canEdit()) return; title.focus(); title.select(); }, true);
    const detailIco=ico('‚ñæ','Detalle',function(){ toggleDesc(p.id,'toggle'); }, false);

    const delIco=ico('‚àí','Eliminar',function(){
      if(!canEdit()) return;
      if(confirm('¬øEliminar proceso?')){
        /* eliminaci√≥n por id (robusta) */
        const idx = data.findIndex(function(pp){return pp.id===p.id});
        if(idx>-1){
          data.splice(idx,1);
          selPid = data[0] ? data[0].id : null;
          ctxSubId=null;
          render();
        }
      }
    }, true);
    delIco.classList.add('del');
    delIco.style.display='none';

    title.addEventListener('focus',function(){ if(canEdit()) delIco.style.display='inline-flex'; });
    title.addEventListener('blur', function(){ setTimeout(function(){ delIco.style.display='none'; },120); });

    tiny.append(editIco,detailIco,delIco);
    row.appendChild(tiny);

    row.onclick=function(){
      selPid=p.id; ctxSubId=null; renderRight();
      document.querySelectorAll('.procRow').forEach(function(el){ el.classList.remove('active'); });
      row.classList.add('active');
      document.querySelectorAll('[id^="d_"]').forEach(function(el){ el.style.display='none'; });
      const det=byId('d_'+p.id);
      if(det){ det.style.display='block'; const ta=det.querySelector('textarea'); autoGrow(ta); }
    };

    box.appendChild(row);

    const detail=document.createElement('div');
    detail.id='d_'+p.id;
    detail.style.display=(p.id===selPid)?'block':'none';
    detail.style.margin='4px 0 6px';
    detail.style.background=lighten(p.color,.94);
    detail.style.border='1px solid '+lighten(p.color,.8);
    detail.style.borderRadius='8px';

    const ta=document.createElement('textarea');
    ta.style.width='100%'; ta.style.minHeight='96px';
    ta.style.border='1px solid #e6e6e6'; ta.style.borderRadius='8px'; ta.style.padding='6px';
    ta.value=p.desc||'';
    ta.oninput=function(ev){ if(!canEdit()) return; p.desc=ev.target.value; autoGrow(ta); save(); };
    autoGrow(ta);

    detail.appendChild(ta);
    box.appendChild(detail);
  });
}
function toggleDesc(pid,mode){
  const el=byId('d_'+pid); if(!el) return;
  if(mode==='toggle') el.style.display=(el.style.display==='block')?'none':'block';
  else if(mode==='close') el.style.display='none';
  else el.style.display='block';
  if(el.style.display==='block'){ const ta=el.querySelector('textarea'); autoGrow(ta); }
}

/* ======= Derecha ======= */
function addSub(){ if(!canEdit()) return alert('Modo lectura. Desbloquea con PIN.'); const p=data.find(function(x){return x.id===selPid}); if(!p) return alert('Selecciona un proceso'); p.sub.push({id:uid(),title:'Nuevo subproceso',desc:'',resp:ROLES[0],steps:[]}); ctxSubId=p.sub[p.sub.length-1].id; renderRight(); }
function addStepProcess(){ if(!canEdit()) return alert('Modo lectura. Desbloquea con PIN.'); const p=data.find(function(x){return x.id===selPid}); if(!p) return alert('Selecciona un proceso'); p.steps.push({id:uid(),name:'Nuevo paso',desc:'',resp:ROLES[0],yes:[],no:[]}); ctxSubId=null; renderRight(); }

function renderRight(){
  const body=byId('rightBody'); body.innerHTML='';
  const p=data.find(function(x){return x.id===selPid}); if(!p)return;
  try{ body.style.background = 'linear-gradient(180deg,'+lighten(p.color,.985)+',#f1f3f8)'; body.style.borderLeft='4px solid '+lighten(p.color,.78); }catch(e){}
  const sub=ctxSubId ? p.sub.find(function(s){return s.id===ctxSubId}) : null;

  if(sub){
    const header=document.createElement('div'); header.className='rowSub';
    const chip=document.createElement('div'); chip.className='chip';
    const tag=document.createElement('span'); tag.className='tag'; tag.textContent='Sub-proceso';
    const t=document.createElement('input'); t.className='title subTitle'; t.value=sub.title||'Subproceso'; t.oninput=function(e){ if(!canEdit()) return; sub.title=e.target.value; save(); };
    const right=document.createElement('div'); right.className='rightPack';
    const detailSub=document.createElement('div'); detailSub.className='detail';
    const txSub=document.createElement('textarea'); txSub.value=sub.desc||''; txSub.oninput=function(e){ if(!canEdit()) return; sub.desc=e.target.value; autoGrow(txSub); save(); }; autoGrow(txSub); detailSub.appendChild(txSub);
    const iDetailSub=ico('‚ñæ','Detalle del subproceso',function(){const open=detailSub.style.display!=='block';detailSub.style.display=open?'block':'none'; if(open){autoGrow(txSub);} }, false);
    const role=miniSel(sub);
    right.append(iDetailSub,role);
    chip.append(tag,t,right); header.appendChild(chip); header.appendChild(detailSub);
    const inlineAdd=document.createElement('button'); inlineAdd.className='adder editOnly'; inlineAdd.textContent='+'; inlineAdd.title='A√±adir paso al subproceso'; inlineAdd.style.margin='4px 0 0 26px'; a11y(inlineAdd,function(){ if(!canEdit()) return; (sub.steps||(sub.steps=[])).push({id:uid(),name:'Nuevo paso',resp:ROLES[0],yes:[],no:[]}); save(); renderRight(); });
    header.appendChild(inlineAdd);
    body.appendChild(header);
  }

  const card=document.createElement('div'); card.className='card flow'; card.style.padding='5px';
  try{ card.style.setProperty('--line', '#c6c9d3'); }catch(_e){}
  card.style.background = 'linear-gradient(180deg,#ffffff, var(--card))'; 
  card.style.borderColor = '#dcdfe7';
  const list=sub ? (sub.steps||[]) : p.steps; list.forEach(function(st,i){ card.appendChild(stepRow(p,sub,st,i)); });
  const tail=document.createElement('div'); tail.style.display='flex'; tail.style.justifyContent='flex-end'; tail.style.margin='8px 0 2px';
  const btn=document.createElement('button'); btn.className='btnTop bigFinish editOnly'; btn.textContent='üéØ Cerrar caso'; btn.title='Marca meta y pliega detalles';
  a11y(btn,function(){ if(!canEdit()) return; saveMeta(); body.querySelectorAll('.detail').forEach(function(d){d.style.display='none'}); updateLastSaved(); });
  tail.appendChild(btn); card.appendChild(tail); body.appendChild(card);

  if(!sub && p.sub.length){
    const g=document.createElement('div'); g.className='card green'; g.style.marginTop='6px';
    g.style.borderColor = '#cfe9df';
    p.sub.forEach(function(s,idx){g.appendChild(subMini(p,s,idx))});
    body.appendChild(g);
  }
  alignConnectors(card);
  setTimeout(function(){ alignConnectors(card); },0);
  requestAnimationFrame(function(){ requestAnimationFrame(function(){ alignConnectors(card); }); });
}

/* ======= Paso ======= */
function normalize(list){if(!Array.isArray(list))return [];return list.map(function(x){return typeof x==='string'?{id:uid(),text:x}:(x.id?x:{id:uid(),...x})});}
function badge(pid,prefix){ prefix = (typeof prefix==='string'?prefix:'IR AL PROCESO: '); const tgt=data.find(function(p){return p.id===pid});if(!tgt)return null;const el=document.createElement('span');el.className='nextBadge';el.textContent=prefix+tgt.name;el.style.background=lighten(tgt.color,.55);el.style.border='1px solid '+lighten(tgt.color,.35);return el;}

/* Eliminar punto Si/No por id (DFS) */
function removePointFromStep(step, targetId){
  function rec(list){
    if(!Array.isArray(list)) return false;
    var i=list.findIndex(function(n){ return n && n.id===targetId; });
    if(i>-1){ list.splice(i,1); return true; }
    for(var k=0;k<list.length;k++){
      var node=list[k];
      if(node && node.children && rec(node.children)) return true;
    }
    return false;
  }
  return rec(step.yes)||rec(step.no);
}

function stepRow(proc,sub,st,i){
  const list=sub?(sub.steps||[]):proc.steps;
  const row=document.createElement('div'); row.className='row'; row.draggable=!(!canEdit()); row.style.borderColor='#dcdfe7';
  row.addEventListener('dragstart',function(e){ if(!canEdit()){ e.preventDefault(); return; } dragCtx={type:'step',pid:proc.id,subId:(sub?sub.id:null),index:i}; });
  row.addEventListener('dragover',function(e){ e.preventDefault(); });
  row.addEventListener('drop',function(e){ e.preventDefault(); if(!canEdit()) return; if(!dragCtx||dragCtx.type!=='step')return; const same=dragCtx.pid===proc.id&&(dragCtx.subId||null)===(sub?sub.id:null); if(!same)return; const from=dragCtx.index,to=i; if(from===to)return; const it=list.splice(from,1)[0]; list.splice(to,0,it); renderRight(); });

  const chip=document.createElement('div'); chip.className='chip';
  chip.style.background = 'linear-gradient(180deg,#ffffff,#f1f3f7)';
  const num=document.createElement('div'); num.className='bubble'; num.textContent=i+1;
  const title=document.createElement('input'); title.className='title'; title.value=st.name||'Paso'; title.oninput=function(e){ if(!canEdit()) return; st.name=e.target.value; save(); };
  const right=document.createElement('div'); right.className='rightPack';

  const iGoto=ico('üö©','Pr√≥ximo proceso',function(){ if(!canEdit()) return; pick(st.nextPid,function(v){st.nextPid=v;save();renderRight();}); }, true);
  const iSiNo=ico('‚ùì','Si/No',function(){ /* despliegue s√≥lo (permitido en lectura) */ }, false);
  const iDel=ico('‚àí','Eliminar',function(){ if(!canEdit()) return; if(confirm('¬øEliminar paso?')){const pos=list.indexOf(st);list.splice(pos,1);renderRight();} }, true);
  right.append(iGoto,iDel,iSiNo);
  iDel.style.background='#fecaca'; iDel.style.color='#1f2937';
  const role=miniSel(st); right.append(role);
  if(st.nextPid){const b=badge(st.nextPid); if(b) right.append(b);} if(st.meta){const meta=ico('üéØ','Meta cumplida',null,false); meta.style.background='#ffe3a6'; right.append(meta);} 

  chip.append(num,title,right); row.appendChild(chip);

  /* Si/No + detalle */
  st.yes=normalize(st.yes); st.no=normalize(st.no);
  const condWrap=document.createElement('div'); condWrap.className='condWrap'; row.appendChild(condWrap);
  function buildCond(){ if(condWrap.dataset.inited==='1') return; condWrap.innerHTML=''; condWrap.appendChild(condBlock(st, i+1)); condWrap.dataset.inited='1'; }
  function ensureCondVisible(){ buildCond(); condWrap.style.display='block'; }
  const hasActive=((st.yes&&st.yes.length)>0)||((st.no&&st.no.length)>0);
  if(hasActive){ ensureCondVisible(); }
  iSiNo.addEventListener('click',function(e){
    const active=((st.yes&&st.yes.length)>0)||((st.no&&st.no.length)>0);
    if(active){ ensureCondVisible(); return; }
    if(condWrap.style.display==='block'){ condWrap.style.display='none'; }
    else { ensureCondVisible(); }
  });

  const detail=document.createElement('div'); detail.className='detail';
  const tx=document.createElement('textarea'); tx.value=st.desc||''; tx.oninput=function(e){ if(!canEdit()) return; st.desc=e.target.value; autoGrow(tx); save(); }; autoGrow(tx); detail.appendChild(tx);
  const tools=document.createElement('div'); tools.className='detailTools'; tools.style.display='flex'; tools.style.gap='6px'; tools.style.alignItems='center'; tools.style.marginTop='6px';
  const linkInput=document.createElement('input'); linkInput.type='url'; linkInput.placeholder='üîó Enlace‚Ä¶'; linkInput.value=st.link||''; linkInput.style.flex='1'; linkInput.style.border='1px solid #dfe3ea'; linkInput.style.borderRadius='8px'; linkInput.style.padding='4px 6px'; linkInput.oninput=function(e){ if(!canEdit()) return; st.link=e.target.value; save(); };
  const up=document.createElement('input'); up.type='file'; up.style.display='none'; up.addEventListener('change',function(e){ if(!canEdit()) return; const f=e.target.files&&e.target.files[0]; if(f){ st.doc=f.name; save(); renderRight(); }});
  const upBtn=document.createElement('button'); upBtn.className='btnTop editOnly'; upBtn.textContent='üìé Adjuntar'; a11y(upBtn,function(){ if(!canEdit()) return; up.click(); });
  if(st.doc){ const docTag=document.createElement('span'); docTag.className='nextBadge'; docTag.textContent='Doc: '+st.doc; tools.appendChild(docTag); }
  tools.append(linkInput,upBtn); detail.appendChild(tools);

  function toggleDetail(){const open=detail.style.display!=='block'; detail.style.display=open?'block':'none'; if(open) autoGrow(tx); }
  const iDetail=ico('‚ñæ','Detalle',toggleDetail,false); right.prepend(iDetail);
  chip.addEventListener('click',function(e){ if(e.target.closest('.ico')|| e.target.tagName==='SELECT' || e.target===title) return; toggleDetail(); });
  chip.addEventListener('dblclick',toggleDetail);
  num.addEventListener('click',toggleDetail); title.ondblclick=toggleDetail;
  row.appendChild(detail);
  return row;
}
function miniSel(obj){const sel=document.createElement('select');sel.className='miniSel';ROLES.forEach(function(r){const o=document.createElement('option');o.value=r;o.textContent=r;sel.appendChild(o);});sel.value=obj.resp||ROLES[0];sel.addEventListener('change',function(e){ if(!canEdit()) return; obj.resp=e.target.value;save();});return sel;}
function ico(g,t,fn,editOnly){
  const b=document.createElement('button');
  b.className='ico sm';
  if(editOnly) b.classList.add('editOnly');
  b.title=t;b.textContent=g;
  a11y(b, fn || function(){});  /* reforzado: click + Enter/Espacio */
  return b;
}

/* Si/No */
function condBlock(st, stepNum){
  const wrap=document.createElement('div'); wrap.className='condBox';
  wrap.append(oneSide('Si NO‚Ä¶','no',st,stepNum));
  wrap.append(oneSide('Si S√ç‚Ä¶','yes',st,stepNum));
  return wrap;
}
function oneSide(title,branch,st,stepNum){
  const b=document.createElement('div');
  b.classList.add(branch==='yes' ? 'branch-yes' : 'branch-no');

  const hdr=document.createElement('div'); hdr.className='condHdr';
  const t=document.createElement('div'); t.className='condTitle'; t.textContent=title;
  const plus=document.createElement('button'); plus.className='adder editOnly'; plus.textContent='+'; plus.title='A√±adir punto a '+title;
  const list=(st[branch]||(st[branch]=[]));
  a11y(plus,function(){ if(!canEdit()) return; list.push({id:uid(),text:'',children:[]}); save(); renderRight(); });
  hdr.append(t,plus); b.appendChild(hdr);

  function renderPoints(arr, base, container){
    (arr||[]).forEach(function(it,idx){
      it.children = it.children || [];
      const numStr = base + '.' + (idx+1);
      const r=document.createElement('div'); r.className='condItem';
      const num=document.createElement('span'); num.className='condNum'; num.textContent=numStr;
      const tx=document.createElement('textarea'); tx.className='condText'; tx.placeholder='Escribe‚Ä¶'; tx.value=it.text||''; tx.oninput=function(e){ if(!canEdit()) return; it.text=e.target.value; autoGrow(tx); save(); }; autoGrow(tx);
      const flagItem=ico('üö©','Pr√≥ximo proceso de este punto',function(){ if(!canEdit()) return; pick(it.nextPid, function(v){ it.nextPid=v; save(); renderRight(); }); }, true);
      flagItem.style.background='#eef0f3'; flagItem.style.color='#1f2937';
      const addChild=ico('+','A√±adir subpunto',function(){ if(!canEdit()) return; it.children.push({id:uid(),text:'',children:[]}); save(); renderRight(); }, true);
      const del=document.createElement('button'); del.className='condDel editOnly'; del.textContent='‚àí';
      a11y(del,function(){ if(!canEdit()) return; if(removePointFromStep(st, it.id)){ save(); renderRight(); } });
      r.append(num,tx,flagItem,addChild,del);
      if(it.nextPid){ const bb=badge(it.nextPid,'IR AL PROCESO: '); if(bb) r.appendChild(bb); }
      container.appendChild(r);
      if(it.children && it.children.length){ const kids=document.createElement('div'); kids.className='condChildren'; container.appendChild(kids); renderPoints(it.children, numStr, kids); }
    });
  }
  renderPoints(list, String(stepNum), b);
  return b;
}

/* Subprocesos */
function subMini(proc,s,idx){
  const row=document.createElement('div'); row.className='row'; row.draggable=!(!canEdit());
  row.addEventListener('dragstart',function(e){ if(!canEdit()){ e.preventDefault(); return; } dragCtx={type:'sub',pid:proc.id,index:idx};});
  row.addEventListener('dragover',function(e){e.preventDefault();});
  row.addEventListener('drop',function(e){e.preventDefault(); if(!canEdit()) return; if(!dragCtx||dragCtx.type!=='sub'||dragCtx.pid!==proc.id)return; const it=proc.sub.splice(dragCtx.index,1)[0]; proc.sub.splice(idx,0,it); renderRight();});
  const chip=document.createElement('div'); chip.className='chip';
  const b=document.createElement('div'); b.className='bubble'; b.textContent=idx+1;
  const t=document.createElement('input'); t.className='title subTitle'; t.value=s.title||'Subproceso'; t.oninput=function(e){ if(!canEdit()) return; s.title=e.target.value; save(); };
  const right=document.createElement('div'); right.className='rightPack';
  const edit=ico('üñâ','Editar',function(){ if(!canEdit()) return; t.focus();t.select(); }, true);
  const del=ico('‚àí','Eliminar',function(){ if(!canEdit()) return; if(confirm('¬øEliminar subproceso?')){proc.sub=proc.sub.filter(function(x){return x!==s}); if(ctxSubId===s.id)ctxSubId=null; renderRight();} }, true);
  const role=miniSel(s);
  right.append(edit,del,role);
  chip.append(b,t,right); row.appendChild(chip);
  const add=document.createElement('button'); add.textContent='+ Paso'; add.className='adder editOnly'; add.style.margin='5px 0 0 26px';
  a11y(add,function(){ if(!canEdit()) return; (s.steps||(s.steps=[])).push({id:uid(),name:'Nuevo paso',resp:ROLES[0],yes:[],no:[]}); ctxSubId=s.id; save(); renderRight(); });
  row.appendChild(add);
  chip.addEventListener('click',function(){ ctxSubId=s.id; renderRight(); });
  return row;
}

/* Selector de proceso destino */
function pick(current,onPick){
  const o=document.createElement('div'); Object.assign(o.style,{position:'fixed',inset:0,background:'rgba(0,0,0,.45)',display:'grid',placeItems:'center',zIndex:9990});
  const card=document.createElement('div'); Object.assign(card.style,{background:'#fff',padding:'12px',borderRadius:'10px',boxShadow:'0 14px 38px rgba(0,0,0,.2)',width:'min(92vw,420px)'});
  const h=document.createElement('div'); h.textContent='Selecciona proceso de destino'; h.style.fontWeight='800'; h.style.marginBottom='6px';
  const sel=document.createElement('select'); sel.style.width='100%'; sel.style.padding='8px'; sel.style.border='1px solid #ddd'; sel.style.borderRadius='8px';
  data.forEach(function(p){const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name; opt.dataset.color=p.color; sel.appendChild(opt);});
  sel.value=current||data[0].id;
  const preview=document.createElement('div'); preview.style.display='flex'; preview.style.alignItems='center'; preview.style.gap='8px'; preview.style.margin='8px 0 4px';
  const dot=document.createElement('span'); Object.assign(dot.style,{display:'inline-block',width:'14px',height:'14px',borderRadius:'999px',border:'1px solid #bbb'});
  const badgePreview=document.createElement('span'); badgePreview.className='nextBadge';
  function updatePreview(){ const id=sel.value; const tgt=data.find(function(p){return p.id===id}) || data[0]; if(!tgt) return; dot.style.background=tgt.color; badgePreview.textContent='IR AL PROCESO: '+tgt.name; badgePreview.style.background=lighten(tgt.color,.55); badgePreview.style.border='1px solid '+lighten(tgt.color,.35); }
  sel.addEventListener('change',updatePreview); updatePreview(); preview.append(dot,badgePreview);
  const bar=document.createElement('div'); bar.style.display='flex'; bar.style.justifyContent='flex-end'; bar.style.gap='8px'; bar.style.marginTop='8px';
  const cancel=document.createElement('button'); cancel.textContent='Cancelar'; cancel.className='btnTop'; cancel.style.background='#ddd'; cancel.style.color='#000'; a11y(cancel,function(){document.body.removeChild(o)});
  const ok=document.createElement('button'); ok.textContent='Aceptar'; ok.className='btnTop'; ok.style.background='#b63a3a'; ok.style.color='#fff'; a11y(ok,function(){onPick(sel.value); document.body.removeChild(o);});
  bar.append(cancel,ok);
  card.append(h,sel,preview,bar); o.appendChild(card); document.body.appendChild(o);
} 

/* Meta */
function saveMeta(){
  if(!canEdit()) return alert('Modo lectura. Desbloquea con PIN.');
  const p=data.find(function(x){return x.id===selPid});if(!p)return;
  const list=ctxSubId?((p.sub.find(function(s){return s.id===ctxSubId})||{}).steps||[]):p.steps;
  if(list.length){list.forEach(function(s,k){s.meta=(k===list.length-1)});}
  save();renderRight();
}

/* Impresi√≥n */
function printAll(){
  const wrap=byId('printDoc'); wrap.innerHTML=''; const root=document.createElement('div');
  data.forEach(function(proc,pi){
    const pBox=document.createElement('div');
    const h2=document.createElement('h2'); h2.textContent=(pi+1)+'. '+proc.name; h2.style.margin='0 0 6px'; h2.style.borderBottom='2px solid #000'; pBox.appendChild(h2);
    if(proc.desc){ const d=document.createElement('p'); d.textContent='Descripci√≥n: '+proc.desc; pBox.appendChild(d); }
    if(proc.steps.length){ const h=document.createElement('h3'); h.textContent='Pasos'; pBox.appendChild(h); proc.steps.forEach(function(st,si){pBox.appendChild(printStep(st,si))}); }
    if(proc.sub.length){ const h=document.createElement('h3'); h.textContent='Subprocesos'; pBox.appendChild(h); proc.sub.forEach(function(sp,qi){ const sb=document.createElement('div'); const sh=document.createElement('h4'); sh.textContent=(pi+1)+'.S'+(qi+1)+' '+sp.title; sb.appendChild(sh); (sp.steps||[]).forEach(function(st,si){sb.appendChild(printStep(st,si))}); pBox.appendChild(sb); }); }
    if(pi < data.length-1){ const cut=document.createElement('div'); cut.className='pbreak'; pBox.appendChild(cut); }
    root.appendChild(pBox);
  });
  wrap.appendChild(root); wrap.style.display='block'; setTimeout(function(){ window.print(); wrap.style.display='none'; wrap.innerHTML=''; },40);
}
function printStep(st,si){
  const box=document.createElement('div'); box.style.border='1px solid #ddd'; box.style.borderRadius='8px'; box.style.padding='6px 8px'; box.style.margin='4px 0';
  const h=document.createElement('div'); h.style.fontWeight='800'; h.textContent='Paso '+(si+1)+': '+(st.name||''); box.appendChild(h);
  const r=document.createElement('div'); r.textContent='Responsable: '+(st.resp||'‚Äî'); r.style.fontSize='12px'; r.style.opacity='.85'; box.appendChild(r);
  if(st.desc){const d=document.createElement('div');d.textContent='Descripci√≥n: '+st.desc;box.appendChild(d);} 
  if(st.link){const l=document.createElement('div');l.textContent='Enlace: '+st.link;box.appendChild(l);} 
  if(st.doc){const d2=document.createElement('div');d2.textContent='Documento: '+st.doc;box.appendChild(d2);} 
  if(st.nextPid){const b=badge(st.nextPid); if(b){const w=document.createElement('div');w.appendChild(b);box.appendChild(w);}}
  if(st.no && st.no.length){ const t=document.createElement('div'); t.textContent='Si NO:'; box.appendChild(t); st.no.forEach(function(i){ const li=document.createElement('div'); li.textContent='- '+i.text; box.appendChild(li); }); }
  if(st.yes && st.yes.length){ const t2=document.createElement('div'); t2.textContent='Si S√ç:'; box.appendChild(t2); st.yes.forEach(function(i){ const li2=document.createElement('div'); li2.textContent='- '+i.text; box.appendChild(li2); }); }
  if(st.meta){const m=document.createElement('span');m.textContent='  üéØ';h.appendChild(m);} return box;
}

/* Render + conectores */
function render(){renderLeft();renderRight();applyLockState();save();}
function alignConnectors(container){
  const rows=container.querySelectorAll('.row');
  if(!rows.length) return;
  if(rows.length===1){ rows[0].style.setProperty('--conn-len','22px'); return; }
  rows.forEach(function(row,idx){
    const b=row.querySelector('.bubble'); if(!b) return;
    const rr=row.getBoundingClientRect(); const br=b.getBoundingClientRect();
    row.style.setProperty('--line-x', (br.left - rr.left + br.width/2) + 'px');
    const next=rows[idx+1];
    if(next){
      const nb=next.querySelector('.bubble');
      if(nb){
        const nbb=nb.getBoundingClientRect();
        const len=Math.max(10, Math.round((nbb.top + nbb.height/2) - (br.bottom)));
        row.style.setProperty('--conn-len', len + 'px');
      } else {
        row.style.setProperty('--conn-len','22px');
      }
    } else {
      row.style.setProperty('--conn-len','0px');
    }
  });
}
render();

/* Sello inicial + estado PIN */
document.addEventListener('DOMContentLoaded',function(){
  const s=localStorage.getItem(LS+'_STAMP');
  if(s){ const el=byId('lastSaved'); if(el) el.textContent='√öltima actualizaci√≥n: '+s; }
  byId('pinBtn').textContent = canEdit() ? 'üîì' : 'üîí';
  applyLockState();
});

/* Enter = guardar y salir de edici√≥n */
window.addEventListener('keydown',function(e){
  if(e.key==='Enter'){
    const a=document.activeElement;
    if(a&&(a.tagName==='INPUT'||a.tagName==='TEXTAREA')){
      e.preventDefault();a.blur();if(canEdit()) save();
    }
  }
});

/* Tests m√≠nimos */
(function(){
  try{
    const ok=(n,b)=>console[b?'log':'error']('TEST '+(b?'‚úî':'‚úñ')+' '+n);
    ok('uid',typeof uid==='function');
    ok('sin docWrite', !document.documentElement.outerHTML.includes('document.'+'write'));
  }catch(e){ console.error(e); }
})();
</script>
</body>
</html>
