<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PROCESOS</title>
<style>
  :root{
    --radius:16px; --bg:#f4f5f7; --ink:#111;
    --hdr1:#000; --hdr2:#5a0000;   /* cabecera negroâ†’rojo oscuro */
    --head:#0b0b0b;                /* encabezados panel */
    --chipShadow:0 3px 0 #cfd4da, 0 10px 22px rgba(0,0,0,.10);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

  /* TOP */
  .top{display:flex;gap:8px;align-items:center;padding:10px 12px;background:linear-gradient(90deg,var(--hdr1),var(--hdr2));color:#fff}
  .top h1{margin:0;font-size:20px;font-weight:900}
  .search{flex:1;border:none;border-radius:999px;background:rgba(255,255,255,.14);padding:6px 12px;color:#fff}
  .btn{border:none;border-radius:999px;background:rgba(255,255,255,.14);color:#fff;padding:6px 12px;font-size:12px;cursor:pointer}

  /* LAYOUT 2 PANELES */
  .layout{display:grid;grid-template-columns:360px 1fr;gap:10px;padding:10px;min-height:calc(100vh - 56px)}
  @media(max-width:1024px){.layout{grid-template-columns:1fr}}
  .panel{background:#fff;border-radius:var(--radius);box-shadow:0 10px 28px rgba(0,0,0,.08);display:flex;flex-direction:column;min-width:0}
  .panel>header{padding:10px 12px;background:var(--head);color:#fff;display:flex;justify-content:space-between;align-items:center;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}
  .panel .body{padding:10px;overflow:auto;flex:1}

  /* IZQUIERDA: PROCESOS + conmutadores */
  .header-left-actions{display:flex;gap:6px;align-items:center}
  .view-toggle{border:none;border-radius:10px;background:#1b1b1b;color:#fff;padding:6px 10px;cursor:pointer;font-size:12px;opacity:.7}
  .view-toggle.active{opacity:1;outline:2px solid rgba(255,255,255,.25)}

  .p-card{border:1px solid #e8eaee;border-radius:14px;padding:8px;margin-bottom:8px;display:flex;gap:8px;align-items:flex-start;cursor:pointer}
  .p-card.active{outline:2px solid rgba(0,0,0,.12);background:#fff}
  .p-num{font-weight:800;font-size:11px;margin-top:2px}
  .p-main{flex:1}
  .p-name{border:none;background:transparent;font-weight:800;font-size:14px;width:100%}
  .pill{font-size:11px;border:none;border-radius:999px;background:rgba(0,0,0,.1);padding:2px 8px;cursor:pointer;margin-left:6px}
  .p-desc{display:none;margin-top:6px}
  .p-desc textarea{width:100%;min-height:52px;border:1px solid #e6e6e6;border-radius:8px;padding:6px}
  .del{width:24px;height:24px;border:none;border-radius:999px;background:rgba(0,0,0,.12);color:#000;cursor:pointer}

  /* DERECHA header gradiente + guardar */
  #rHeader{background:linear-gradient(90deg,#000,#5a0000)}
  .right-actions{display:flex;gap:6px;align-items:center}

  /* SECCIONES */
  .section{margin-bottom:14px}
  .sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .sec-head h3{margin:0;font-size:14px}
  .sec-btn{border:none;border-radius:10px;background:#eef0f3;padding:6px 10px;cursor:pointer}

  /* FILA PASO/SUBPROCESO (2 mitades) */
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center;border:1px solid #f3cbd1;background:#fff;border-radius:12px;padding:8px 10px;margin-bottom:6px}
  .leftPart{display:flex;align-items:center;gap:8px;min-width:0}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:linear-gradient(180deg,#fff,#f2f3f5);border:1px solid #e6e8ec;box-shadow:var(--chipShadow);min-width:0;flex:1}
  .n{font-weight:900;font-size:12px;background:#000;color:#fff;border-radius:999px;padding:2px 7px;flex:0 0 auto}
  .title{border:none;background:transparent;font-weight:700;width:100%;min-width:0}
  .icon{border:none;background:#f1f2f4;border-radius:999px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .toggle{border:none;background:#f1f2f4;border-radius:999px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer}

  .rightPart{display:grid;grid-template-columns:64px 1fr;align-items:start;gap:8px}
  .yn{display:flex;flex-direction:column;gap:10px}
  .pillYN{border:1px solid #ddd;border-radius:12px;padding:4px 10px;background:#fff;font-weight:700;width:fit-content}
  .colYN{border-left:2px dashed #ddd;padding-left:10px}
  .ynRow{display:flex;align-items:flex-start;gap:6px;margin:6px 0}
  .ynText{flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;min-height:38px}
  .ynAdd{border:1px dashed #bbb;background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}
  .ynDel{border:none;background:#f1f2f4;border-radius:999px;width:26px;height:26px;cursor:pointer}

  /* DETALLE (siempre oculto por defecto) */
  .detail{display:none;border:1px dashed #e5e7eb;border-radius:12px;padding:10px;margin:-2px 0 8px 10px;background:#fff}
  .label{font-size:11px;opacity:.75;margin:6px 0 4px}
  .input{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px}
  textarea.input{min-height:60px;resize:vertical}

  /* Flecha vertical entre pasos */
  .arrowV{opacity:.35;text-align:center;margin:-4px 0 8px}

  /* chips resumidos (opcional) */
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chipMini{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:linear-gradient(180deg,#fff,#f2f3f5);border:1px solid #e6e8ec;box-shadow:var(--chipShadow)}
  .chipMini .n{padding:1px 6px}
  .tag{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:12px;color:#111;background:#eef0f3}
</style>
</head>
<body>
  <div class="top">
    <h1>PROCESOS</h1>
    <input class="search" placeholder="Buscarâ€¦" oninput="doSearch(this.value)"/>
    <div class="right-actions">
      <button class="btn" onclick="saveMeta()">ðŸ’¾ Guardar</button>
    </div>
  </div>

  <div class="layout">
    <!-- IZQUIERDA -->
    <div class="panel">
      <header>
        <span>Procesos</span>
        <div class="header-left-actions">
          <button id="btnBoth" class="view-toggle active" onclick="setView('both')">SUBPROCESOS + PASOS</button>
          <button id="btnSteps" class="view-toggle" onclick="setView('steps')">SOLO PASOS</button>
        </div>
      </header>
      <div class="body" id="procList"></div>
    </div>

    <!-- DERECHA -->
    <div class="panel">
      <header id="rHeader">
        <span id="rTitle">Selecciona un proceso</span>
        <div class="right-actions">
          <button class="btn" onclick="addSub()">+ Subproceso</button>
          <button class="btn" onclick="addStepProcess()">+ Paso</button>
          <button class="btn" onclick="saveMeta()">ðŸ’¾ Guardar</button>
        </div>
      </header>
      <div class="body" id="rightBody"></div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const LS='PROC_SI_NO_V1';
const PASTEL=['#ffd1dc','#c6e2ff','#caffb7','#ffeec6','#e0c6ff','#ffecd1','#c2f0e8','#fff9c6'];
const ROLES=['AudiÃ³logo','Responsable','Otros'];

/* ===== STATE ===== */
let data = JSON.parse(localStorage.getItem(LS) || 'null') || [
  {id:uid(), name:'Reparaciones', color:PASTEL[0], desc:'', sub:[], steps:[]},
  {id:uid(), name:'Ajuste remoto', color:PASTEL[1], desc:'', sub:[], steps:[]},
];
let selPid = data[0]?.id || null;
let q=''; let viewMode=localStorage.getItem(LS+'_view') || 'both';

/* ===== UTIL ===== */
function uid(){ return Math.random().toString(36).slice(2,9); }
function save(){ localStorage.setItem(LS, JSON.stringify(data)); }
function doSearch(v){ q=v.toLowerCase(); render(); }
function lighten(hex,f=.86){const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16); const nr=Math.round(r+(255-r)*f),ng=Math.round(g+(255-g)*f),nb=Math.round(b+(255-b)*f); return `rgb(${nr},${ng},${nb})`; }
function setView(m){ viewMode=m; localStorage.setItem(LS+'_view',m); btn('btnBoth').classList.toggle('active',m==='both'); btn('btnSteps').classList.toggle('active',m==='steps'); renderRight(); }
const btn=id=>document.getElementById(id);

/* ===== RENDER ROOT ===== */
function render(){ renderLeft(); renderRight(); save(); }

/* ===== IZQUIERDA ===== */
function renderLeft(){
  btn('btnBoth').classList.toggle('active',viewMode==='both');
  btn('btnSteps').classList.toggle('active',viewMode==='steps');

  const box=document.getElementById('procList'); box.innerHTML='';
  let list=data.slice();
  if(q) list=list.filter(p=>p.name.toLowerCase().includes(q)||(p.desc||'').toLowerCase().includes(q));
  list.sort((a,b)=>(b.sub.length>0)-(a.sub.length>0));

  list.forEach((p,i)=>{
    const row=document.createElement('div'); row.className='p-card'+(p.id===selPid?' active':'');
    row.style.background=lighten(p.color,.9); row.style.borderColor=p.color;
    row.onclick=()=>{ selPid=p.id; renderRight(); };

    const num=document.createElement('div'); num.className='p-num'; num.textContent=(i+1)+'.';
    const main=document.createElement('div'); main.className='p-main';
    const name=document.createElement('input'); name.className='p-name'; name.value=p.name;
    name.onclick=e=>e.stopPropagation(); name.oninput=e=>{ p.name=e.target.value; if(p.id===selPid) document.getElementById('rTitle').textContent=p.name; save(); };

    const pill=document.createElement('button'); pill.className='pill'; pill.textContent='â–¼ Desc';
    const dWrap=document.createElement('div'); dWrap.className='p-desc';
    const ta=document.createElement('textarea'); ta.value=p.desc||''; ta.oninput=e=>{ p.desc=e.target.value; save(); };
    dWrap.appendChild(ta);
    pill.onclick=(ev)=>{ ev.stopPropagation(); const open=dWrap.style.display!=='block'; dWrap.style.display=open?'block':'none'; pill.textContent=open?'â–² Desc':'â–¼ Desc'; };

    const del=document.createElement('button'); del.className='del'; del.textContent='âˆ’';
    del.onclick=(ev)=>{ ev.stopPropagation(); if(confirm('Â¿Eliminar proceso?')){ data=data.filter(x=>x.id!==p.id); if(selPid===p.id) selPid=data[0]?.id||null; render(); } };

    main.appendChild(name); main.appendChild(pill);
    row.appendChild(num); row.appendChild(main); row.appendChild(del); row.appendChild(dWrap);
    box.appendChild(row);
  });
}

/* ===== DERECHA ===== */
function renderRight(){
  const body=document.getElementById('rightBody'); const title=document.getElementById('rTitle'); const hdr=document.getElementById('rHeader');
  body.innerHTML='';
  const p=data.find(x=>x.id===selPid);
  if(!p){ title.textContent='Selecciona un proceso'; hdr.style.background='linear-gradient(90deg,#000,#5a0000)'; return; }
  title.textContent=p.name; hdr.style.background=`linear-gradient(90deg,#000,${lighten(p.color,.55)})`;

  if(viewMode==='both'){
    body.appendChild(subprocessList(p));
    body.appendChild(stepsList(p,true)); // true = pinta flechas verticales tambiÃ©n
  }else{
    body.appendChild(stepsList(p,true));
  }
}

/* ===== SUBPROCESOS ===== */
function subprocessList(proc){
  const wrap=document.createElement('div'); wrap.className='section';
  const head=document.createElement('div'); head.className='sec-head';
  const h=document.createElement('h3'); h.textContent='Subprocesos';
  const add=document.createElement('button'); add.className='sec-btn'; add.textContent='+ Subproceso'; add.onclick=addSub;
  head.appendChild(h); head.appendChild(add); wrap.appendChild(head);

  proc.sub.forEach((s,idx)=>{
    wrap.appendChild(stepRow({
      idx: idx+1,
      title: s.title || 'Subproceso',
      onTitle: v=>{ s.title=v; save(); },
      resp: s.resp || ROLES[0],
      onResp: v=>{ s.resp=v; save(); },
      link: s.link, doc: s.doc, nextPid: s.nextPid,
      onLink: v=>{ s.link=v; save(); renderRight(); },
      onDoc: v=>{ s.doc=v; save(); renderRight(); },
      onNext: v=>{ s.nextPid=v; save(); renderRight(); },
      onDelete: ()=>{ if(confirm('Â¿Eliminar subproceso?')){ proc.sub=proc.sub.filter(x=>x!==s); renderRight(); } },
      desc: s.desc||'',
      onDesc: v=>{ s.desc=v; save(); },
      yes: s.yes||[], no: s.no||[],
      onAddYes: ()=>{ (s.yes||(s.yes=[])).push({id:uid(),text:''}); renderRight(); },
      onAddNo : ()=>{ (s.no ||(s.no =[])).push({id:uid(),text:''}); renderRight(); },
      onYesChange: (id,v)=>{ const it=s.yes.find(x=>x.id===id); if(it){ it.text=v; save(); } },
      onNoChange : (id,v)=>{ const it=s.no .find(x=>x.id===id); if(it){ it.text=v; save(); } },
      onYesDel   : (id)=>{ s.yes=s.yes.filter(x=>x.id!==id); renderRight(); },
      onNoDel    : (id)=>{ s.no =s.no .filter(x=>x.id!==id); renderRight(); },
      color: proc.color
    }));
  });

  return wrap;
}

/* ===== PASOS ===== */
function stepsList(proc, drawArrows){
  const wrap=document.createElement('div'); wrap.className='section';
  const head=document.createElement('div'); head.className='sec-head';
  const h=document.createElement('h3'); h.textContent='Pasos del proceso';
  const add=document.createElement('button'); add.className='sec-btn'; add.textContent='+ Paso'; add.onclick=addStepProcess;
  head.appendChild(h); head.appendChild(add); wrap.appendChild(head);

  proc.steps.forEach((st,i)=>{
    wrap.appendChild(stepRow({
      idx:i+1,
      title: st.name||'Paso',
      onTitle: v=>{ st.name=v; save(); },
      resp: st.resp||ROLES[0],
      onResp: v=>{ st.resp=v; save(); },
      link: st.link, doc: st.doc, nextPid: st.nextPid,
      onLink: v=>{ st.link=v; save(); renderRight(); },
      onDoc: v=>{ st.doc=v; save(); renderRight(); },
      onNext: v=>{ st.nextPid=v; save(); renderRight(); },
      onDelete: ()=>{ if(confirm('Â¿Eliminar paso?')){ proc.steps=proc.steps.filter(x=>x!==st); renderRight(); } },
      desc: st.desc||'',
      onDesc: v=>{ st.desc=v; save(); },
      yes: st.yes||[], no: st.no||[],
      onAddYes: ()=>{ (st.yes||(st.yes=[])).push({id:uid(),text:''}); renderRight(); },
      onAddNo : ()=>{ (st.no ||(st.no =[])).push({id:uid(),text:''}); renderRight(); },
      onYesChange: (id,v)=>{ const it=st.yes.find(x=>x.id===id); if(it){ it.text=v; save(); } },
      onNoChange : (id,v)=>{ const it=st.no .find(x=>x.id===id); if(it){ it.text=v; save(); } },
      onYesDel   : (id)=>{ st.yes=st.yes.filter(x=>x.id!==id); renderRight(); },
      onNoDel    : (id)=>{ st.no =st.no .filter(x=>x.id!==id); renderRight(); },
      color: proc.color,
      isLast: (i===proc.steps.length-1) && st.meta
    }));

    if(drawArrows && i<proc.steps.length-1){
      const a=document.createElement('div'); a.className='arrowV'; a.textContent='â¬‡'; wrap.appendChild(a);
    }
  });

  return wrap;
}

/* ===== ROW BUILDER (comÃºn a subproceso/paso) ===== */
function stepRow(cfg){
  const row=document.createElement('div'); row.className='row';
  /* MITAD IZQUIERDA */
  const left=document.createElement('div'); left.className='leftPart';
  const chip=document.createElement('div'); chip.className='chip';
  const n=document.createElement('span'); n.className='n'; n.textContent=cfg.idx;
  const title=document.createElement('input'); title.className='title'; title.value=cfg.title; title.oninput=e=>cfg.onTitle(e.target.value);
  chip.appendChild(n); chip.appendChild(title);

  // iconos alineados junto al nombre
  const edit=document.createElement('button'); edit.className='icon'; edit.title='Editar'; edit.textContent='ðŸ–‰'; edit.onclick=()=>{ title.focus(); title.select(); };
  const del=document.createElement('button'); del.className='icon'; del.title='Eliminar'; del.textContent='âˆ’'; del.onclick=cfg.onDelete;

  const linkBtn=document.createElement('button'); linkBtn.className='icon'; linkBtn.title='Adjuntar enlace'; linkBtn.textContent='ðŸ”—';
  linkBtn.onclick=()=>{ const u=prompt('Pega el enlace', cfg.link||''); if(u!==null){ cfg.onLink(u); } };

  const fileInput=document.createElement('input'); fileInput.type='file'; fileInput.style.display='none';
  fileInput.onchange=e=>{ const f=e.target.files?.[0]; if(f){ cfg.onDoc(f.name); } };
  const docBtn=document.createElement('button'); docBtn.className='icon'; docBtn.title='Adjuntar documento'; docBtn.textContent='ðŸ“Ž'; docBtn.onclick=()=>fileInput.click();

  const flagBtn=document.createElement('button'); flagBtn.className='icon'; flagBtn.title='PrÃ³ximo proceso'; flagBtn.textContent='ðŸš©';
  flagBtn.onclick=()=>openProcessPicker(cfg.nextPid,(val)=>cfg.onNext(val));

  // detalle oculto (flecha)
  const tgl=document.createElement('button'); tgl.className='toggle'; tgl.title='Detalle'; tgl.textContent='â–¶';

  left.appendChild(chip); left.appendChild(edit); left.appendChild(linkBtn); left.appendChild(docBtn); left.appendChild(flagBtn); left.appendChild(del); left.appendChild(tgl); left.appendChild(fileInput);

  /* MITAD DERECHA: Responsable + SÃ­/No */
  const right=document.createElement('div'); right.className='rightPart';

  const sideYN=document.createElement('div'); sideYN.className='yn';
  const noP=document.createElement('div'); noP.className='pillYN'; noP.textContent='No';
  const siP=document.createElement('div'); siP.className='pillYN'; siP.textContent='SÃ­';
  sideYN.appendChild(noP); sideYN.appendChild(siP);

  const col=document.createElement('div'); col.className='colYN';

  // fila NO (lista + +)
  const noBlock=document.createElement('div');
  const addNo=document.createElement('button'); addNo.className='ynAdd'; addNo.textContent='+';
  addNo.onclick=cfg.onAddNo;
  noBlock.appendChild(addNo);
  (cfg.no||[]).forEach(item=>{
    const r=document.createElement('div'); r.className='ynRow';
    const tx=document.createElement('textarea'); tx.className='ynText'; tx.placeholder='Si NOâ€¦'; tx.value=item.text||''; tx.oninput=e=>cfg.onNoChange(item.id,e.target.value);
    const rm=document.createElement('button'); rm.className='ynDel'; rm.textContent='âˆ’'; rm.onclick=()=>cfg.onNoDel(item.id);
    r.appendChild(tx); r.appendChild(rm); noBlock.appendChild(r);
  });

  // fila SI (lista + +)
  const siBlock=document.createElement('div'); siBlock.style.marginTop='8px';
  const addSi=document.createElement('button'); addSi.className='ynAdd'; addSi.textContent='+';
  addSi.onclick=cfg.onAddYes;
  siBlock.appendChild(addSi);
  (cfg.yes||[]).forEach(item=>{
    const r=document.createElement('div'); r.className='ynRow';
    const tx=document.createElement('textarea'); tx.className='ynText'; tx.placeholder='Si SÃâ€¦'; tx.value=item.text||''; tx.oninput=e=>cfg.onYesChange(item.id,e.target.value);
    const rm=document.createElement('button'); rm.className='ynDel'; rm.textContent='âˆ’'; rm.onclick=()=>cfg.onYesDel(item.id);
    r.appendChild(tx); r.appendChild(rm); siBlock.appendChild(r);
  });

  col.appendChild(noBlock); col.appendChild(siBlock);

  // selector responsable en la parte superior derecha del bloque
  const sel=document.createElement('select'); sel.className='select'; sel.style.position='absolute'; sel.style.transform='translateY(-40px)'; sel.style.right='22px';
  ROLES.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o); });
  sel.value=cfg.resp; sel.onchange=e=>cfg.onResp(e.target.value);

  right.style.position='relative';
  right.appendChild(sideYN); right.appendChild(col); right.appendChild(sel);

  /* AÃ±adir partes al row */
  row.appendChild(left); row.appendChild(right);

  /* DETALLE (siempre oculto) */
  const det=document.createElement('div'); det.className='detail';
  const l1=document.createElement('div'); l1.className='label'; l1.textContent='DescripciÃ³n';
  const ta=document.createElement('textarea'); ta.className='input'; ta.value=cfg.desc||''; ta.oninput=e=>cfg.onDesc(e.target.value);
  det.appendChild(l1); det.appendChild(ta);

  if(cfg.link){ const t=document.createElement('span'); t.className='tag'; t.textContent='ðŸ”— '+cfg.link; det.appendChild(t); }
  if(cfg.doc ){ const t=document.createElement('span'); t.className='tag'; t.textContent='ðŸ“„ '+cfg.doc ; det.appendChild(t); }
  if(cfg.nextPid){ const tgt=data.find(p=>p.id===cfg.nextPid); if(tgt){ const t=document.createElement('span'); t.className='tag'; t.style.background=lighten(tgt.color,.55); t.textContent='â†’ '+tgt.name; det.appendChild(t); } }
  if(cfg.isLast){ const t=document.createElement('span'); t.className='tag'; t.textContent='ðŸ Meta'; det.appendChild(t); }

  // toggle detalle
  tgl.onclick=()=>{ const open=det.style.display!=='block'; det.style.display=open?'block':'none'; tgl.textContent=open?'â–¼':'â–¶'; };

  const wrap=document.createElement('div');
  wrap.appendChild(row); wrap.appendChild(det);
  return wrap;
}

/* ===== Picker de procesos destino (ðŸš©) ===== */
function openProcessPicker(current, onPick){
  const overlay=document.createElement('div');
  Object.assign(overlay.style,{position:'fixed',inset:'0',background:'rgba(0,0,0,.45)',display:'grid',placeItems:'center',zIndex:9990});
  const card=document.createElement('div');
  Object.assign(card.style,{background:'#fff',padding:'14px',borderRadius:'12px',boxShadow:'0 14px 38px rgba(0,0,0,.2)',width:'min(92vw,420px)'});
  const h=document.createElement('div'); h.textContent='Selecciona proceso destino'; h.style.fontWeight='800'; h.style.marginBottom='8px';

  const sel=document.createElement('select'); sel.style.width='100%'; sel.style.padding='8px'; sel.style.border='1px solid #ddd'; sel.style.borderRadius='8px';
  data.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o); });
  sel.value=current || data[0].id;

  const bar=document.createElement('div'); bar.style.display='flex'; bar.style.justifyContent='flex-end'; bar.style.gap='8px'; bar.style.marginTop='10px';
  const cancel=document.createElement('button'); cancel.textContent='Cancelar'; cancel.className='sec-btn'; cancel.onclick=()=>document.body.removeChild(overlay);
  const ok=document.createElement('button'); ok.textContent='Aceptar'; ok.className='sec-btn'; ok.style.background='#5a0000'; ok.style.color='#fff';
  ok.onclick=()=>{ onPick(sel.value); document.body.removeChild(overlay); };

  bar.appendChild(cancel); bar.appendChild(ok);
  card.appendChild(h); card.appendChild(sel); card.appendChild(bar);
  overlay.appendChild(card); document.body.appendChild(overlay);
}

/* ===== ACTIONS ===== */
function addSub(){
  const p=data.find(x=>x.id===selPid); if(!p) return;
  p.sub.push({id:uid(), title:'Nuevo subproceso', desc:'', resp:ROLES[0], yes:[], no:[]});
  renderRight();
}
function addStepProcess(){
  const p=data.find(x=>x.id===selPid); if(!p) return;
  p.steps.push({id:uid(), name:'Nuevo paso', desc:'', resp:ROLES[0], yes:[], no:[]});
  renderRight();
}
function saveMeta(){
  const p=data.find(x=>x.id===selPid); if(!p) return;
  if(p.steps.length){ p.steps.forEach((s,k)=> s.meta=(k===p.steps.length-1)); }
  save(); renderRight();
}

/* ===== INIT ===== */
render();

/* Enter = blur/guardar */
window.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const a=document.activeElement;
    if(a && (a.tagName==='INPUT'||a.tagName==='TEXTAREA')){ e.preventDefault(); a.blur(); save(); }
  }
});
</script>
</body>
</html>
