<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PROCESOS AUDIO</title>
<style>
:root{
  --bg:#0b0f14;            /* se sobrescribe en modo claro */
  --bg-soft:#121820;       /* se sobrescribe en modo claro */
  --panel:#151c24;         /* se sobrescribe en modo claro */
  --ink:#eef3fa;           /* se sobrescribe en modo claro */
  --muted:#98a2ad;         /* se sobrescribe en modo claro */
  --btn-grad-a:#1b2430;    /* se sobrescribe en modo claro */
  --btn-grad-b:#121820;    /* se sobrescribe en modo claro */
  --shadow:0 10px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
  --radius:14px;
  --accent:#e25a5a;
}

/* ========= LIGHT THEME (gris claro) ========= */
body.light{
  --bg:#f5f6f9;         /* fondo general casi blanco */
  --bg-soft:#eef0f4;    /* panel gris clarito */
  --panel:#ffffff;      /* tarjetas en blanco */
  --ink:#1f2328;        /* texto oscuro */
  --muted:#6b717c;      /* texto sutil */
  --btn-grad-a:#ffffff; /* botones 3D claros */
  --btn-grad-b:#eceff3;
  --shadow:0 6px 18px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.9);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}

/* ---------- APLICACI√ìN ---------- */
.app{display:flex;flex-direction:column;height:100%}

/* Header degradado rojo */
.header{
  padding:14px 18px;
  background:linear-gradient(90deg,#915b5b 0,#c74f4f 25%,#9a3a3a 50%,#7e2e2e 100%);
  display:flex;gap:14px;align-items:center;position:sticky;top:0;z-index:10;
}
.h-title{display:flex;align-items:center;gap:10px;font-weight:800;font-size:26px;letter-spacing:.5px}
.h-title .ear{width:28px;height:28px;border-radius:50%;display:inline-grid;place-items:center;background:#fff2;box-shadow:var(--shadow)}
.search{flex:1;max-width:620px}
.search input{
  width:100%;padding:10px 14px;border-radius:999px;border:1px solid #0000;
  background:#ffffff22;color:#fff;outline:none;box-shadow:inset 0 1px 0 #fff4,0 4px 10px rgba(0,0,0,.2)
}
.btn{
  padding:10px 16px;border-radius:999px;border:1px solid #00000028;
  background:linear-gradient(180deg,var(--btn-grad-a),var(--btn-grad-b));
  box-shadow:var(--shadow);color:var(--ink);display:inline-flex;gap:10px;align-items:center;cursor:pointer;
  user-select:none
}
.btn.primary{background:linear-gradient(180deg,#fffc,#eef2f7);border-color:#d9dee6}
.btn .dot{width:10px;height:10px;border-radius:50%}
.badge{opacity:.85}

/* layout columnas */
.body{display:grid;grid-template-columns:360px 1fr;gap:18px;padding:14px}
.left{background:var(--bg-soft);border-right:1px solid #dde2ea;border-radius:12px;padding:14px;overflow:auto}
.right{background:var(--bg);border-radius:12px;padding:0;overflow:auto}

/* ---------- PROCESOS (izq) ---------- */
.left h3{margin:0 0 10px 0;font-size:18px}
.proc{
  background:var(--panel);border-radius:14px;padding:12px 12px;border:1px solid #e6ebf2;
  display:flex;flex-direction:column;gap:8px;margin-bottom:12px;box-shadow:var(--shadow)
}
.proc .top{display:flex;align-items:center;gap:10px}
.proc .dot{width:10px;height:10px;border-radius:50%;box-shadow:inset 0 1px 0 #fff}
.proc .name{flex:1;font-weight:700}
.proc .acts{display:flex;gap:6px}
.ico{width:26px;height:26px;border-radius:8px;display:grid;place-items:center;cursor:pointer;
  background:#0000000a;border:1px solid #00000014;color:var(--ink)}
.ico:hover{filter:brightness(1.1)}
.proc .min{font-size:12px;color:var(--muted)}

/* ---------- HOJA (derecha) ---------- */
.sheet-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;background:var(--bg-soft);border-bottom:1px solid #e6ebf2;border-radius:12px 12px 0 0
}
.sheet-title{font-weight:800;font-size:18px}
.head-actions{display:flex;gap:10px;align-items:center}
.pill{
  padding:8px 12px;border-radius:999px;border:1px solid #d9dee6;
  background:linear-gradient(180deg,var(--btn-grad-a),var(--btn-grad-b));
  box-shadow:var(--shadow);display:inline-flex;gap:8px;align-items:center;color:var(--ink);cursor:pointer
}

.sheet-body{padding:14px}

/* tarjeta de subproceso */
.sub{background:var(--panel);border-radius:14px;margin-bottom:16px;box-shadow:var(--shadow);border:1px solid #e6ebf2}
.sub-head{
  display:flex;align-items:center;gap:10px; padding:10px 12px;
  background:linear-gradient(180deg,#f9fafc,#eef1f6);
  border-bottom:1px solid #e3e7ee;border-radius:14px 14px 0 0
}
.sub-name{
  flex:1; font-weight:800; padding:8px 10px;border-radius:10px;border:1px solid #dfe4ec;background:#fff
}
.sub-acts{display:flex;gap:8px;align-items:center}

/* pasos */
.sub-body{padding:10px 12px}
.step{
  position:relative;background:#fff;border:1px solid #e9edf3;border-radius:14px;padding:12px 12px 12px 58px;
  margin:10px 0;box-shadow:0 6px 16px rgba(0,0,0,.06), inset 0 1px 0 rgba(255,255,255,.9)
}
/* l√≠nea vertical gruesa (color de proceso en --line) */
.step:before{
  content:"";position:absolute;left:36px;top:-8px;bottom:-8px;width:6px;border-radius:999px;
  background:var(--line);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.35), 0 1px 0 rgba(0,0,0,.05)
}
.bubble{
  position:absolute;left:16px;top:10px;width:36px;height:36px;border-radius:50%;
  display:grid;place-items:center;background:#fff;border:1px solid #d9dee6;color:#111;
  box-shadow:0 8px 14px rgba(0,0,0,.05), inset 0 1px 0 #fff;font-weight:800
}

.step-row{display:flex;gap:8px;align-items:center}
.step-title{font-weight:800}
.btn-icon{
  padding:6px 8px;border-radius:10px;border:1px solid #00000018;background:#00000008;color:var(--ink);
  display:inline-grid;place-items:center;cursor:pointer
}
.detail{margin-top:8px}
.detail textarea{
  width:100%;min-height:64px;border-radius:10px;border:1px solid #00000018;background:#00000006;padding:10px;color:var(--ink);
  resize:vertical
}
.attach{display:flex;gap:8px;margin-top:8px;align-items:center}
.attach .pill{font-size:12px}

/* selector responsable */
.resp{margin-left:auto;padding:6px 10px;border-radius:999px;border:1px solid #00000018;background:#00000006}

/* dock inferior (opcional) */
.dock{
  position:sticky;bottom:0;padding:10px;border-top:1px solid #e6ebf2;background:#ffffffd9;
  display:flex;gap:8px;justify-content:flex-end
}

/* Edit mode: oculta/visualiza iconos */
.hide-icons .ico, .hide-icons .btn-icon, .hide-icons .pill.icon-only{display:none}

/* utilidades */
.row{display:flex;gap:10px;align-items:center}
.mt8{margin-top:8px}
.mt12{margin-top:12px}
.w100{width:100%}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body class="light">
<div class="app" id="app">

  <!-- HEADER -->
  <div class="header">
    <div class="h-title">
      <span class="ear">üéß</span> PROCESOS AUDIO
    </div>
    <div class="search"><input id="q" placeholder="Buscar‚Ä¶"></div>

    <button class="btn" id="btnAddProc"><span class="dot" style="background:#ffd1d1"></span> + Procesos</button>
    <button class="btn primary" id="btnAddSubStep">+ Subproceso + Paso</button>
    <button class="btn" id="btnSave">üíæ Guardar subproceso</button>
    <div class="badge small" id="last"></div>
  </div>

  <!-- BODY -->
  <div class="body">
    <!-- LEFT -->
    <div class="left">
      <h3>Procesos</h3>
      <div id="procList"></div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div id="sheet"></div>
    </div>
  </div>

  <!-- DOCK -->
  <div class="dock">
    <button class="pill" id="btnToggleEdit">‚úèÔ∏è Editar</button>
    <button class="pill" id="btnCompact">üß© Compacto</button>
  </div>
</div>

<script>
/* ================== DATA ================== */
const LSKEY='pa_data_v4';
let data = JSON.parse(localStorage.getItem(LSKEY)||'null') || {
  selected:null,
  processes:[{
    id: uid(), name:'Revisi√≥n auditiva', color:'#ffc9c9',
    sub:[]
  }]
};
if(data.selected==null) data.selected=data.processes[0]?.id||null;

/* ================== UTILS ================== */
function uid(){return Math.random().toString(36).slice(2,9)}
function save(){ localStorage.setItem(LSKEY,JSON.stringify(data)); stamp() }
function stamp(){
  const el=document.getElementById('last');
  el.textContent='√öltima actualizaci√≥n '+new Date().toLocaleString();
}

/* pastel auto (varios tonos) */
const PALETTE=['#ffc9c9','#ffe0c9','#fff3bf','#e9fac8','#d2f4ea','#c5f6fa','#e7f5ff','#e5dbff','#ffd6e8','#ffe5cc'];

/* ================== RENDER LEFT ================== */
function renderLeft(){
  const box=document.getElementById('procList'); box.innerHTML='';
  const q=document.getElementById('q').value.toLowerCase();
  data.processes.forEach((p,idx)=>{
    if(q && !p.name.toLowerCase().includes(q)) return;
    const card=document.createElement('div'); card.className='proc'; card.style.setProperty('--line', p.color);
    card.innerHTML=`
      <div class="top">
        <span class="dot" style="background:${p.color}"></span>
        <div class="name">${p.name}</div>
        <div class="acts">
          <span class="ico" title="Editar" onclick="editProcess('${p.id}')">‚úèÔ∏è</span>
          <span class="ico" title="Eliminar" onclick="delProcess('${p.id}')">üóëÔ∏è</span>
        </div>
      </div>
      <div class="min">${p.sub.length} subprocesos</div>
    `;
    card.onclick=(e)=>{ if(e.target.closest('.acts')) return; data.selected=p.id; renderRight(); save(); }
    if(p.id===data.selected) card.style.outline=`2px solid ${p.color}`;
    box.appendChild(card);
  });
}

/* ================== RENDER RIGHT ================== */
function current(){ return data.processes.find(p=>p.id===data.selected) }

function renderRight(){
  const p=current(); const sheet=document.getElementById('sheet'); sheet.innerHTML='';
  if(!p){sheet.innerHTML='<div class="sheet-head"><div class="sheet-title">Selecciona un proceso</div></div>'; return;}

  /* HEAD */
  const head=document.createElement('div'); head.className='sheet-head';
  head.innerHTML=`
    <div class="sheet-title">Proceso: ${p.name}</div>
    <div class="head-actions">
      <span class="pill" onclick="cycleColor()"><b>Color</b> <span class="dot" style="background:${p.color}"></span></span>
      <span class="pill" onclick="addSubStep()">+ Subproceso + Paso</span>
    </div>
  `;
  sheet.appendChild(head);

  /* BODY */
  const body=document.createElement('div'); body.className='sheet-body';
  p.sub.forEach((s,si)=>{
    const sub=document.createElement('div'); sub.className='sub';
    sub.innerHTML=`
      <div class="sub-head">
        <input class="sub-name" value="${s.name}" oninput="s.name=this.value; save()">
        <div class="sub-acts">
          <span class="btn-icon" title="Paso +" onclick="addStep('${s.id}')">‚ûï</span>
          <select class="resp" onchange="s.resp=this.value; save()">
            ${['Audi√≥logo','Responsable','Otros'].map(r=>`<option ${s.resp===r?'selected':''}>${r}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="sub-body" id="sub-${s.id}"></div>
    `;
    body.appendChild(sub);

    const list=sub.querySelector(`#sub-${s.id}`);
    s.steps.forEach((st,i)=>{
      const step=document.createElement('div'); step.className='step'; step.style.setProperty('--line',p.color);
      step.innerHTML=`
        <div class="bubble">${i+1}</div>
        <div class="step-row">
          <div class="step-title w100"><input value="${st.title}" oninput="st.title=this.value; save()" class="w100" style="border:0;background:#0000;font-weight:800"></div>
          <select class="resp" onchange="st.resp=this.value; save()">
            ${['Audi√≥logo','Responsable','Otros'].map(r=>`<option ${st.resp===r?'selected':''}>${r}</option>`).join('')}
          </select>
          <span class="btn-icon" title="Eliminar paso" onclick="delStep('${s.id}','${st.id}')">üóëÔ∏è</span>
        </div>

        <!-- Detalle SIEMPRE debajo del t√≠tulo -->
        <div class="detail">
          <textarea placeholder="Descripci√≥n‚Ä¶" oninput="st.desc=this.value; save()">${st.desc||''}</textarea>
        </div>

        <div class="attach">
          <span class="pill icon-only" onclick="addLink('${s.id}','${st.id}')">üîó Enlace</span>
          <span class="pill icon-only" onclick="addDoc('${s.id}','${st.id}')">üìé Documento</span>
          <span class="small" id="meta-${st.id}"></span>
        </div>
      `;
      list.appendChild(step);
      refreshMeta(st);
    });
  });
  sheet.appendChild(body);

  /* color vertical para este proceso */
  document.documentElement.style.setProperty('--line', p.color);
}

/* ========= helpers de attachments ========= */
function refreshMeta(st){
  const meta=document.getElementById('meta-'+st.id);
  const tags=[];
  if(st.link) tags.push(`<a href="${st.link}" target="_blank">üîó</a>`);
  if(st.doc)  tags.push(`<a href="${st.doc}" target="_blank">üìé</a>`);
  meta.innerHTML=tags.join(' ');
}

/* ================== ACTIONS ================== */
function addProcess(){
  const name=prompt('Nombre del proceso','Nuevo proceso'); if(!name) return;
  const color=PALETTE[(data.processes.length)%PALETTE.length];
  data.processes.push({id:uid(), name, color, sub:[]});
  data.selected=data.processes[data.processes.length-1].id;
  renderLeft(); renderRight(); save();
}
function editProcess(id){
  const p=data.processes.find(x=>x.id===id); if(!p) return;
  const name=prompt('Editar nombre', p.name); if(!name) return;
  p.name=name; renderLeft(); renderRight(); save();
}
function delProcess(id){
  if(!confirm('¬øEliminar proceso y su contenido?')) return;
  const i=data.processes.findIndex(x=>x.id===id); if(i>-1) data.processes.splice(i,1);
  if(data.selected===id) data.selected=data.processes[0]?.id||null;
  renderLeft(); renderRight(); save();
}

function cycleColor(){
  const p=current(); if(!p) return;
  const i=PALETTE.indexOf(p.color); p.color=PALETTE[(i+1)%PALETTE.length];
  renderLeft(); renderRight(); save();
}

/* Subproceso + Paso anclado */
function addSubStep(){
  const p=current(); if(!p) return;
  const s={id:uid(), name:'Nuevo subproceso', resp:'Audi√≥logo', steps:[]};
  p.sub.push(s);
  addStep(s.id);
  renderLeft(); renderRight(); save();
}
function addStep(subId){
  const p=current(); const s=p.sub.find(x=>x.id===subId); if(!s) return;
  s.steps.push({id:uid(), title:'Nuevo paso', desc:'', resp:'Audi√≥logo'});
  renderRight(); save();
}
function delStep(subId,stepId){
  const p=current(); const s=p.sub.find(x=>x.id===subId); if(!s) return;
  const i=s.steps.findIndex(t=>t.id===stepId); if(i>-1) s.steps.splice(i,1);
  renderRight(); save();
}

function addLink(subId,stepId){
  const p=current(); const s=p.sub.find(x=>x.id===subId); const st=s.steps.find(t=>t.id===stepId);
  const v=prompt('URL del enlace', st.link||''); if(v==null) return;
  st.link=v.trim(); save(); refreshMeta(st);
}
function addDoc(subId,stepId){
  const p=current(); const s=p.sub.find(x=>x.id===subId); const st=s.steps.find(t=>t.id===stepId);
  const v=prompt('URL del documento', st.doc||''); if(v==null) return;
  st.doc=v.trim(); save(); refreshMeta(st);
}

/* edici√≥n compacta / mostrar iconos */
let editMode=false;
function toggleEdit(){
  editMode=!editMode;
  document.getElementById('app').classList.toggle('hide-icons', !editMode);
}
let compact=true;
function toggleCompact(){
  compact=!compact;
  document.body.style.setProperty('letter-spacing', compact? '0' : '.2px');
}

/* ================== INIT ================== */
document.getElementById('btnAddProc').onclick=addProcess;
document.getElementById('btnAddSubStep').onclick=addSubStep;
document.getElementById('btnSave').onclick=save;
document.getElementById('btnToggleEdit').onclick=toggleEdit;
document.getElementById('btnCompact').onclick=toggleCompact;
document.getElementById('q').oninput=renderLeft;

/* vista limpia por defecto (iconos ocultos) */
document.getElementById('app').classList.add('hide-icons');

renderLeft(); renderRight(); stamp();

/* ACTIVAR MODO CLARO SI NO EST√Å */
document.body.classList.add('light');
</script>
</body>
</html>
