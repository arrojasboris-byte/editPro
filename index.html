<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PROCESOS AUDIO</title>
<style>
  :root{
    --bg:#0e0f12;
    --panel:#14161c;
    --ink:#e8eaee;
    --muted:#b9bfcc;
    --stroke:#2a2f3a;
    --chip:#1b1f27;
    --ok:#00c2a8;
    --warn:#ffb100;
    --bad:#ff5c6c;
    --btn:#1e2230;
    --shadow:0 6px 18px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:500 14px/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  /* Layout */
  header{
    background:linear-gradient(90deg,#5b6169,#9c2f35 32%,#6d3437);
    padding:10px 14px; display:flex; align-items:center; gap:10px;
    position:sticky; top:0; z-index:20; border-bottom:1px solid #5a3033;
  }
  header h1{margin:0; font-size:18px; letter-spacing:.5px; display:flex; align-items:center; gap:10px}
  header h1 .headset{font-size:20px}
  header .spacer{flex:1}
  header input[type=search]{min-width:320px; max-width:620px; width:40vw; border:1px solid #70353a; background:#ffffff1a; color:#fff; border-radius:12px; padding:8px 12px; outline:none}
  header .hbtn{border:1px solid #70353a;background:#ffffff1a;color:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
  header .hbtn:active{transform:translateY(1px)}

  .grid{display:grid; grid-template-columns: 34% 66%; gap:0}
  .left{background:linear-gradient(180deg,#2a2d33,#1b1d24); border-right:1px solid var(--stroke); min-height:calc(100vh - 56px); padding:10px}
  .right{background:var(--panel); min-height:calc(100vh - 56px); padding:10px 12px}

  /* Botones */
  .btn{border:1px solid var(--stroke); background:var(--btn); color:#fff; border-radius:12px; padding:8px 12px; cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.pastel{background:#ffffff22}

  /* Procesos (izquierda) */
  .procHead{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
  .procAdd{background:linear-gradient(90deg,#7d2b31,#b33b41); border:1px solid #7d2b31; color:#fff; border-radius:12px; padding:8px 12px; cursor:pointer}
  .plist{display:flex; flex-direction:column; gap:10px}
  .pCard{
    background:#ffffff10; border:1px solid var(--stroke); border-radius:14px;
    box-shadow: var(--shadow);
    padding:10px; position:relative; user-select:none;
  }
  .pCard[draggable="true"]{cursor:grab}
  .pTop{display:flex; align-items:center; gap:8px}
  .dot{width:10px;height:10px;border-radius:50%}
  .pName{font-weight:700; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .pAct{display:flex; gap:6px}
  .iconBtn{width:28px;height:28px;border:1px solid var(--stroke); background:var(--chip); color:#fff; border-radius:50%; display:grid; place-items:center; cursor:pointer}
  .iconBtn.trash{box-shadow:none} /* sin sombra para papelera */
  .pDesc{margin-top:6px; display:none}
  .pDesc textarea{
    width:100%; min-height:110px; resize:vertical; border:1px dashed var(--stroke); border-radius:10px;
    background:#0f1320; color:#fff; padding:8px 10px;
  }
  .pCard.active{outline:2px solid #ffffff35}

  /* Encabezado derecho */
  .rHead{display:flex; align-items:center; gap:8px; margin-bottom:10px}
  .tag{padding:6px 10px;border-radius:10px;background:#ffffff18;border:1px solid var(--stroke)}
  .pill{padding:4px 10px;border-radius:999px;background:#ffffff10;border:1px solid var(--stroke)}
  .rBtns{margin-left:auto; display:flex; gap:8px}

  /* Subprocesos (derecha) */
  .spBlock{
    background:#ffffff0f; border:1px solid var(--stroke); border-radius:14px; box-shadow:var(--shadow);
    margin-bottom:12px; overflow:hidden;
  }
  .spTitle{
    background:linear-gradient(90deg,#1d1f26,#434851); color:#fff; padding:10px 12px;
    display:flex; align-items:center; gap:8px;
  }
  .spTitle input{
    background:transparent; border:0; border-bottom:1px dashed #6d747e; color:#fff; outline:none; font-weight:700; width:40%;
  }
  .spBody{padding:10px 12px}
  .spDetail{display:none; margin:8px 0}
  .spDetail textarea{
    width:100%; min-height:100px; background:#0f1320; color:#fff; border:1px dashed var(--stroke); border-radius:10px; padding:8px 10px;
  }

  /* Pasos */
  .step{position:relative; background:#ffffff08; border:1px solid var(--stroke); border-radius:12px; margin:8px 0 12px; padding:10px 12px 12px 56px}
  .bubble{
    position:absolute; left:14px; top:12px; width:26px; height:26px; border-radius:50%; display:grid; place-items:center;
    background:#0d111a; color:#fff; border:2px solid #ffffff40; font-weight:800; z-index:2;
  }
  .connector{ /* l√≠nea vertical detr√°s de la burbuja */
    position:absolute; left:27px; top:0; bottom:0; width:2px; border-radius:2px; background:#ff5c6c33; z-index:1;
  }
  .sTop{display:flex; align-items:center; gap:8px}
  .sTitle{
    background:transparent; border:0; border-bottom:1px dashed #69707c; color:#fff; outline:none; font-weight:700; width:46%;
  }
  .sDetail{display:none; margin:6px 0}
  .sDetail textarea{
    width:100%; min-height:80px; background:#0f1320; color:#fff; border:1px dashed var(--stroke); border-radius:10px; padding:8px 10px;
  }

  /* chips Si / No (No m√°s grande) */
  .chips{display:flex; gap:10px; align-items:center; margin:6px 0}
  .chip{border:1px solid var(--stroke); background:var(--chip); color:#fff; border-radius:999px; padding:5px 10px; display:inline-flex; align-items:center; gap:6px}
  .chip.no{font-weight:800; padding:6px 13px; background:#000; border-color:#333}
  .chip.si{font-weight:700; padding:4px 9px; background:#0a2c3a}
  .chip small{opacity:.7}
  .subpoints{margin-left:10px; display:flex; flex-direction:column; gap:6px}
  .pRow{display:flex; gap:6px; align-items:center}
  .pRow input[type=text]{flex:1; border:1px dashed var(--stroke); background:#0f1320; color:#fff; border-radius:8px; padding:6px 8px; outline:none}
  .flag{padding:4px 8px;border:1px solid var(--stroke);border-radius:10px;background:#ffffff12}
  .goto{font-weight:800}
  .helpers{display:flex; gap:8px; align-items:center; margin-top:6px}
  .linkShow, .docShow{display:none; gap:6px; align-items:center; padding:4px 8px; border:1px dashed var(--stroke); border-radius:10px; background:#ffffff0d}
  .linkShow a, .docShow a{color:#8ad2ff; text-decoration:none}
  .endRow{display:flex; justify-content:flex-end; margin-top:10px}

  /* Impresi√≥n por proceso */
  @media print{
    header, .procHead, .rBtns, .helpers, .endRow{display:none !important}
    .grid{grid-template-columns:100%}
    .left{display:none}
    .spBlock{break-inside:avoid}
    .pBreak{page-break-after:always}
  }
</style>
</head>
<body>

<header>
  <h1><span class="headset">üéß</span>PROCESOS AUDIO</h1>
  <div class="spacer"></div>
  <input type="search" id="search" placeholder="Buscar‚Ä¶"/>
  <button class="hbtn" id="toHtml">‚¨á HTML</button>
  <button class="hbtn" id="toPdf" onclick="window.print()">üñ® PDF</button>
  <button class="hbtn" id="saveCloud">‚òÅ Guardar</button>
</header>

<div class="grid">
  <!-- LEFT -->
  <aside class="left">
    <div class="procHead">
      <button class="procAdd" id="addProc">+ Procesos</button>
    </div>
    <div class="plist" id="plist"></div>
  </aside>

  <!-- RIGHT -->
  <main class="right">
    <div class="rHead">
      <div id="currentProcTag" class="tag">Sin proceso</div>
      <div class="pill" id="updatedAt">‚Äì</div>
      <div class="rBtns">
        <button class="btn pastel" id="addPair">‚ûï Subproceso + Paso</button>
        <button class="btn" id="addSp">+ Subproceso</button>
        <button class="btn" id="addStep">+ Paso</button>
        <button class="btn" id="saveSub">üíæ Guardar subproceso</button>
      </div>
    </div>
    <div id="rlist"></div>
  </main>
</div>

<script>
/* ================== DATA =================== */
const PALETTE = [
  '#ffd9d9','#ffe8d1','#fff8c7','#e6ffd2','#d8fff3','#d9f0ff','#e6d9ff','#ffd9f0',
  '#ffe0db','#f3ffd9','#d9fff5','#d9f3ff','#f2d9ff','#ffe5f6'
];
const state = JSON.parse(localStorage.getItem('pa_data_v3')||'null') || {
  seq:1,
  processes: [{
    id: 1, name:'Revisi√≥n auditiva', color: PALETTE[0], desc:'', subflows:[]
  }]
};
let currentPid = state.processes[0].id;
let workingSubId = null; // subproceso ‚Äúabierto‚Äù para anclar pasos

/* =========== HELPERS =========== */
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const save = ()=>{
  localStorage.setItem('pa_data_v3', JSON.stringify(state));
  $('#updatedAt').textContent = '√öltima actualizaci√≥n ' + new Date().toLocaleString();
};
const uid = ()=> Math.random().toString(36).slice(2,9);
const currentProc = ()=> state.processes.find(p=>p.id===currentPid);

/* Unique pastel per process */
const nextPastel = ()=>{
  const used = new Set(state.processes.map(p=>p.color));
  for(const c of PALETTE){ if(!used.has(c)) return c; }
  return '#ffe8d1';
};

/* =========== LEFT RENDER & INTERACTIONS =========== */
function renderLeft(){
  const list = $('#plist');
  list.innerHTML = '';
  state.processes.forEach((p,i)=>{
    const card = document.createElement('div');
    card.className='pCard';
    card.draggable = true;
    card.dataset.id=p.id;
    card.style.setProperty('--pc', p.color);
    card.style.background = p.color + '33';

    const top = document.createElement('div'); top.className='pTop';
    const dot = document.createElement('div'); dot.className='dot'; dot.style.background=p.color;
    const name = document.createElement('div'); name.className='pName'; name.textContent = `${i+1}. ${p.name}`;
    const act = document.createElement('div'); act.className='pAct';

    const btnEdit = iconBtn('‚úèÔ∏è'); // lapiz
    const btnDetail = iconBtn('‚ñæ'); // despliegue
    const btnTrash = iconBtn('üóë'); btnTrash.classList.add('trash');

    act.append(btnEdit, btnDetail, btnTrash);
    top.append(dot,name,act);
    card.append(top);

    const detail = document.createElement('div'); detail.className='pDesc';
    const ta = document.createElement('textarea'); ta.value = p.desc||'';
    detail.append(ta);
    card.append(detail);

    if(p.id===currentPid) card.classList.add('active');

    /* clicks */
    card.addEventListener('click',(e)=>{
      if(e.target.closest('.iconBtn')) return;
      currentPid = p.id; workingSubId = null;
      highlightCurrent();
      renderRight();
    });
    btnDetail.addEventListener('click',(e)=>{
      e.stopPropagation();
      detail.style.display = detail.style.display==='block' ? 'none' : 'block';
    });
    btnEdit.addEventListener('click', (e)=>{
      e.stopPropagation();
      const newName = prompt('Nombre del proceso:', p.name) || p.name;
      p.name = newName;
      save(); renderLeft(); renderRight();
    });
    btnTrash.addEventListener('click', (e)=>{
      e.stopPropagation();
      if(!confirm('¬øBorrar proceso?')) return;
      const idx = state.processes.findIndex(x=>x.id===p.id);
      state.processes.splice(idx,1);
      if(state.processes.length===0){
        state.processes.push({id: ++state.seq, name:'Nuevo proceso', color:nextPastel(), desc:'', subflows:[]});
      }
      currentPid = state.processes[0].id;
      save(); renderLeft(); renderRight();
    });
    ta.addEventListener('input',()=>{ p.desc = ta.value; save(); });

    /* drag */
    card.addEventListener('dragstart',(e)=>{ e.dataTransfer.setData('text/plain',p.id); card.style.opacity=.5; });
    card.addEventListener('dragend',()=>{ card.style.opacity=1; });
    card.addEventListener('dragover',(e)=>{ e.preventDefault(); card.style.outline='2px dashed #fff3'; });
    card.addEventListener('dragleave',()=> card.style.outline='');
    card.addEventListener('drop',(e)=>{
      e.preventDefault();
      card.style.outline='';
      const dragId = +e.dataTransfer.getData('text/plain');
      if(dragId===p.id) return;
      const arr = state.processes;
      const from = arr.findIndex(x=>x.id===dragId);
      const to = arr.findIndex(x=>x.id===p.id);
      const [m]=arr.splice(from,1);
      arr.splice(to,0,m);
      save(); renderLeft(); renderRight();
    });

    list.append(card);
  });
}

function iconBtn(ch){
  const b = document.createElement('button');
  b.className='iconBtn';
  b.textContent = ch;
  return b;
}
function highlightCurrent(){
  $$('#plist .pCard').forEach(el=>{
    el.classList.toggle('active', +el.dataset.id===currentPid);
  });
}

/* =========== RIGHT (SUBPROCESOS + PASOS) =========== */
function renderRight(){
  const p = currentProc();
  $('#currentProcTag').textContent = p ? p.name : 'Sin proceso';
  const r = $('#rlist'); r.innerHTML='';

  // pintar todos los subprocesos
  p.subflows.forEach((sp,idx)=>{
    r.append(renderSubBlock(p, sp, idx));
  });
}

function renderSubBlock(proc, sp, idx){
  const block = document.createElement('section');
  block.className='spBlock';
  // t√≠tulo oscurecido degradado (menos duro)
  const title = document.createElement('div');
  title.className='spTitle';
  title.style.background = 'linear-gradient(90deg,#1d1f26,#3a3f49)';
  const dot = document.createElement('span'); dot.textContent='‚óè'; dot.style.color=proc.color;
  const inpt = document.createElement('input'); inpt.value=sp.title||'Nuevo subproceso';
  const show = iconBtn('‚ñæ');
  const edit = iconBtn('‚úèÔ∏è');
  const resp = selectResp(sp.owner||'Audi√≥logo');
  const del  = iconBtn('‚Äì');
  title.append(dot, inpt, show, edit, resp, del);
  block.append(title);

  const body = document.createElement('div'); body.className='spBody'; block.append(body);

  // detalle (siempre debajo del t√≠tulo; oculto por defecto)
  const sdet = document.createElement('div'); sdet.className='spDetail';
  const tda = document.createElement('textarea'); tda.placeholder='Descripci√≥n del subproceso‚Ä¶'; tda.value=sp.desc||'';
  sdet.append(tda);
  body.append(sdet);

  // pasos
  sp.steps.forEach((st, i)=> body.append(renderStep(proc, sp, st, i)) );

  // ‚ÄúGuardar subproceso‚Äù al final si es el subproceso ‚Äúworking‚Äù
  if(workingSubId===sp.id){
    const end = document.createElement('div'); end.className='endRow';
    const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='üéØ Guardar';
    saveBtn.onclick = ()=>{ workingSubId=null; save(); renderRight(); };
    end.append(saveBtn); body.append(end);
  }

  // handlers
  show.onclick = ()=>{ sdet.style.display = sdet.style.display==='block' ? 'none':'block'; };
  edit.onclick = ()=>{ inpt.focus(); inpt.select(); };
  inpt.oninput = ()=>{ sp.title = inpt.value; save(); };
  tda.oninput = ()=>{ sp.desc = tda.value; save(); };
  del.onclick = ()=>{
    if(!confirm('¬øBorrar subproceso y sus pasos?')) return;
    const arr = proc.subflows;
    const pos = arr.findIndex(x=>x.id===sp.id);
    arr.splice(pos,1);
    if(workingSubId===sp.id) workingSubId=null;
    save(); renderRight();
  };

  return block;
}

function renderStep(proc, sp, st, idx){
  const wrap = document.createElement('div'); wrap.className='step';
  // l√≠nea vertical detr√°s del n√∫mero
  const line = document.createElement('div'); line.className='connector'; line.style.background = proc.color+'99';
  wrap.append(line);

  const bub = document.createElement('div'); bub.className='bubble'; bub.textContent = (idx+1);
  wrap.append(bub);

  // fila superior
  const top = document.createElement('div'); top.className='sTop';
  const title = document.createElement('input'); title.className='sTitle'; title.value=st.title||'Nuevo paso';
  const show = iconBtn('‚ñæ');
  const del  = iconBtn('‚Äì');
  const q    = iconBtn('?'); // bot√≥n ‚Äúsi/no‚Äù
  const who  = selectResp(st.owner||'Audi√≥logo');
  top.append(title, show, del, q, who);
  wrap.append(top);

  // detalle (inmediatamente tras el t√≠tulo)
  const det = document.createElement('div'); det.className='sDetail';
  const ta = document.createElement('textarea'); ta.placeholder='Detalle‚Ä¶'; ta.value=st.detail||'';
  det.append(ta);
  wrap.append(det);

  // SI / NO (despu√©s del detalle)
  const chips = document.createElement('div'); chips.className='chips';
  const no = document.createElement('span'); no.className='chip no'; no.textContent='NO';
  const noPlus = iconBtn('+'); noPlus.style.borderRadius='10px';
  const si = document.createElement('span'); si.className='chip si'; si.innerHTML='S√ç';
  const siPlus = iconBtn('+'); siPlus.style.borderRadius='10px';
  chips.append(no, noPlus, si, siPlus);
  wrap.append(chips);

  // contenedores de puntos 10.1 etc.
  const noBox = document.createElement('div'); noBox.className='subpoints';
  const siBox = document.createElement('div'); siBox.className='subpoints';
  wrap.append(noBox, siBox);

  // helpers (adjuntos)
  const helpers = document.createElement('div'); helpers.className='helpers';
  const pickLink = iconBtn('üîó');
  const pickDoc  = iconBtn('üìÑ');
  const linkShow = document.createElement('div'); linkShow.className='linkShow'; linkShow.innerHTML='üîó <a target="_blank"></a>';
  const docShow  = document.createElement('div'); docShow.className='docShow'; docShow.innerHTML='üìÑ <a target="_blank"></a>';
  helpers.append(pickLink, pickDoc, linkShow, docShow);
  wrap.append(helpers);

  /* bindings */
  title.oninput = ()=>{ st.title = title.value; save(); };
  show.onclick  = ()=>{ det.style.display = det.style.display==='block'?'none':'block'; };
  del.onclick   = ()=>{ if(!confirm('¬øBorrar paso?')) return; const i=sp.steps.indexOf(st); sp.steps.splice(i,1); save(); renderRight(); };
  q.onclick     = ()=>{ // NO recoge; queda visible hasta terminar edici√≥n
    det.style.display = 'block';
    chips.scrollIntoView({behavior:'smooth',block:'nearest'});
  };
  who.onchange  = ()=>{ st.owner = who.value; save(); };
  ta.oninput    = ()=>{ st.detail = ta.value; save(); };

  /* puntos yes/no numeraci√≥n 10.1 etc */
  st.yes = st.yes||[]; st.no = st.no||[];
  const baseN = (idx+1);

  function addPoint(arr, box){
    const item = { id: uid(), text:'', next:null, kind: (box===siBox?'S':'N') };
    arr.push(item); drawPoints();
  }
  function rmPoint(arr, it){ const i=arr.indexOf(it); if(i>-1){ arr.splice(i,1); drawPoints(); } }

  function drawPoints(){
    noBox.innerHTML=''; siBox.innerHTML='';
    st.no.forEach((it, i)=>{
      const row = document.createElement('div'); row.className='pRow';
      const lab = document.createElement('span'); lab.className='flag'; lab.textContent = `${baseN}.${i+1}`;
      const input=document.createElement('input'); input.type='text'; input.placeholder='Si NO‚Ä¶'; input.value=it.text;
      const linkBtn = iconBtn('üö©'); linkBtn.title='Vincular pr√≥ximo proceso';
      const delBtn  = iconBtn('‚Äì');
      row.append(lab,input,linkBtn,delBtn);
      if(it.next){
        const goto = document.createElement('span'); goto.className='goto'; goto.style.color=proc.color;
        goto.textContent = ` ‚Üí Ir al proceso: ${it.next}`;
        row.append(goto);
      }
      input.oninput=()=>{ it.text=input.value; save(); };
      delBtn.onclick=()=>rmPoint(st.no,it);
      linkBtn.onclick=()=> pickNextProcess(it);
      noBox.append(row);
    });
    st.yes.forEach((it, i)=>{
      const row = document.createElement('div'); row.className='pRow';
      const lab = document.createElement('span'); lab.className='flag'; lab.textContent = `${baseN}.${i+1}`;
      const input=document.createElement('input'); input.type='text'; input.placeholder='Si S√ç‚Ä¶'; input.value=it.text;
      const linkBtn = iconBtn('üö©'); linkBtn.title='Vincular pr√≥ximo proceso';
      const delBtn  = iconBtn('‚Äì');
      row.append(lab,input,linkBtn,delBtn);
      if(it.next){
        const goto = document.createElement('span'); goto.className='goto'; goto.style.color=proc.color;
        goto.textContent = ` ‚Üí Ir al proceso: ${it.next}`;
        row.append(goto);
      }
      input.oninput=()=>{ it.text=input.value; save(); };
      delBtn.onclick=()=>rmPoint(st.yes,it);
      linkBtn.onclick=()=> pickNextProcess(it);
      siBox.append(row);
    });
    // adjuntos visibles
    linkShow.style.display = st.link ? 'inline-flex':'none';
    docShow.style.display  = st.doc  ? 'inline-flex':'none';
    if(st.link){ linkShow.querySelector('a').href=st.link; linkShow.querySelector('a').textContent=st.link; }
    if(st.doc ){ docShow.querySelector('a').href=st.doc;  docShow.querySelector('a').textContent=st.doc;  }
    save();
  }
  function pickNextProcess(target){
    const names = state.processes.map(p=>p.name);
    const sel = prompt('Ir al proceso‚Ä¶\n'+names.map((n,i)=>`${i+1}. ${n}`).join('\n'), target.next||'');
    if(sel){ target.next=sel; drawPoints(); }
  }

  noPlus.onclick = ()=> addPoint(st.no, noBox);
  siPlus.onclick = ()=> addPoint(st.yes, siBox);

  pickLink.onclick = ()=>{
    const v = prompt('Pega un enlace http(s)://', st.link||'');
    if(v!==null){ st.link=v.trim(); drawPoints(); }
  };
  pickDoc.onclick = ()=>{
    const v = prompt('Pega URL de documento', st.doc||'');
    if(v!==null){ st.doc=v.trim(); drawPoints(); }
  };

  drawPoints();
  return wrap;
}

function selectResp(val){
  const s = document.createElement('select');
  ['Audi√≥logo','Responsable','Otros'].forEach(v=>{
    const o=document.createElement('option'); o.value=v; o.textContent=v; s.append(o);
  });
  s.value = val||'Audi√≥logo';
  return s;
}

/* =========== COMMANDS =========== */
$('#addProc').onclick = ()=>{
  state.processes.push({id:++state.seq,name:'Nuevo proceso',color:nextPastel(),desc:'',subflows:[]});
  currentPid = state.processes[state.processes.length-1].id;
  save(); renderLeft(); renderRight(); highlightCurrent();
};

$('#addSp').onclick = ()=>{
  const p = currentProc();
  const sp = {id:uid(), title:'Nuevo subproceso', desc:'', owner:'Audi√≥logo', steps:[]};
  p.subflows.push(sp);
  workingSubId = sp.id;
  save(); renderRight();
};

$('#addPair').onclick = ()=>{
  $('#addSp').click();
  setTimeout(()=>$('#addStep').click(), 20);
};

$('#addStep').onclick = ()=>{
  const p = currentProc();
  if(!p.subflows.length){ $('#addSp').click(); }
  const target = workingSubId ? p.subflows.find(s=>s.id===workingSubId) : p.subflows[p.subflows.length-1];
  if(!target){ return; }
  target.steps.push({id:uid(),title:'Nuevo paso',detail:'',owner:'Audi√≥logo',yes:[],no:[],link:'',doc:''});
  save(); renderRight();
};
$('#saveSub').onclick = ()=>{
  workingSubId = null;
  save(); renderRight();
};

/* =========== SEARCH =========== */
$('#search').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase().trim();
  $$('#plist .pCard').forEach(card=>{
    const nm = card.querySelector('.pName').textContent.toLowerCase();
    card.style.display = nm.includes(q) ? '' : 'none';
  });
});

/* Export HTML (simple) */
$('#toHtml').onclick = ()=>{
  const data = localStorage.getItem('pa_data_v3')||'';
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'procesos-audio-data.json';
  a.click();
  URL.revokeObjectURL(a.href);
};
/* ‚ÄúGuardar nube‚Äù ‚Üí s√≥lo marca hora (puedes conectar backend cuando quieras) */
$('#saveCloud').onclick = ()=>{ save(); alert('Guardado local. (Conecta tu backend si quieres subirlo a la nube)'); };

/* Init */
renderLeft(); highlightCurrent(); renderRight();
$('#updatedAt').textContent = '√öltima actualizaci√≥n ' + new Date().toLocaleString();
</script>
</body>
</html>
