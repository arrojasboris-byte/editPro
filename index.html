<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PROCESOS AUDIO ‚Äî visor estable</title>
<style>
  :root{--panel:#1b1d21;--stroke:#2e333c;--ink:#e5e7eb;--btn:#242833}
  html,body{height:100%;margin:0;background:var(--panel);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  #wrap{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto}
  iframe{width:100%;height:100%;border:0;background:#1b1d21}
  /* Fallback (primera carga sin cach√©) */
  #fallback{position:absolute;inset:0;display:none;place-items:center}
  .drop{border:1px dashed var(--stroke);border-radius:12px;padding:22px 24px;background:#20242d;color:#b9c0d0;max-width:720px;text-align:center}
  .btn{margin-top:10px;border:1px solid var(--stroke);background:linear-gradient(180deg,#2d323c,#20252d);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 8px 18px rgba(0,0,0,.35)}
  .bottom{display:flex;gap:10px;align-items:center;justify-content:center;padding:10px;border-top:1px solid var(--stroke);background:#191b20}
  .bbtn{border:1px solid var(--stroke);background:linear-gradient(180deg,#2d323c,#20252d);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 8px 18px rgba(0,0,0,.35)}
  .bbtn:active{transform:translateY(1px)}
  .pinwrap{display:flex;gap:6px;align-items:center}
  .pinwrap input{background:#151922;color:#fff;border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;min-width:160px;outline:none}
</style>
</head>
<body>
  <div id="wrap">
    <iframe id="view" title="PROCESOS AUDIO"></iframe>
    <div id="fallback">
      <div class="drop">
        Arrastra aqu√≠ tu <b>HTML original</b> o
        <button id="pick" class="btn">Seleccionar archivo</button>
        <input id="file" type="file" accept=".html,.htm" hidden>
      </div>
    </div>
    <div class="bottom">
      <button id="pairBtn" class="bbtn">‚ûï Subproceso + Paso</button>
      <button id="savePairBtn" class="bbtn">üíæ Guardar subproceso</button>
      <button id="editToggle" class="bbtn">‚úè Editar</button>
      <button id="compactToggle" class="bbtn">üß© Compacto</button>
      <span class="pinwrap">
        <input id="pinField" placeholder="PIN (p. ej. AR4321)"/>
        <button id="pinBtn" class="bbtn">üîê PIN</button>
      </span>
      <button id="clearCacheBtn" class="bbtn">üßπ Vaciar cach√©</button>
    </div>
  </div>
<script>
(function(){
  const view = document.getElementById('view');
  const cacheKey = 'pa_viewer_last';
  const cached   = localStorage.getItem(cacheKey);

  // === PARCHES + LOOK (gris, compacto, 3D, l√≠nea gruesa, burbuja grande) ===
  function applyOrderingPatch(win){
    const doc = win.document;
    (function injectLook(){
      try{
        const id='_pa_compact_style';
        if(doc.getElementById(id)) return;
        const st=doc.createElement('style'); st.id=id; st.textContent=`
          :root{--pa-gray:#1b1d21}
          html,body{background:var(--pa-gray)!important}
          .spBlock{margin-bottom:10px!important}
          .spBody{padding:8px 10px!important}
          .step{margin:6px 0 10px!important;padding:10px 12px 12px 92px!important;}
          .bubble{width:38px!important;height:38px!important;font-size:15px!important;border-width:2px!important;left:18px!important}
          .connector{left:36px!important;width:6px!important;border-radius:4px!important}
          .sTop,.sDetail,.chips,.subpoints,.helpers{margin-left:0!important}
          body:not(.pa-edit) .iconBtn{display:none!important}
          .btn,.iconBtn,button{background:linear-gradient(180deg,#2d323c,#20252d)!important;border:1px solid #2e333c!important;border-radius:12px!important;box-shadow:inset 0 1px 0 rgba(255,255,255,.06),0 8px 18px rgba(0,0,0,.35)!important}
        `; (doc.head||doc.documentElement).appendChild(st);
        doc.body.classList.add('pa-compact');
      }catch(e){}
    })();

    const byId   = (id)=>doc.getElementById(id);
    const qAll   = (sel,root=doc)=>Array.from((root||doc).querySelectorAll(sel));
    const textOf = (el)=> (el && (el.textContent||'').trim()) || '';
    const findBtnByText=(labels,root)=>{ const btns=qAll('button',root); for(const b of btns){ const t=textOf(b); if(labels.some(l=>t.includes(l))) return b; } return null; };

    function clickAddStepInsideLastSub(){
      const blocks = qAll('*').filter(n=>/subproceso/i.test(textOf(n)) && n.querySelector('button'));
      const last   = blocks[blocks.length-1];
      if(!last) return false;
      const plus = findBtnByText(['+ Paso','Paso','+','A√±adir paso'], last);
      if(plus){ plus.click(); return true; }
      return false;
    }
    function ensureFirstStepAfterNewSub(){ setTimeout(()=>{ if(!clickAddStepInsideLastSub()){ setTimeout(clickAddStepInsideLastSub,150); } }, 120); }

    function bind(){
      const btnSub  = byId('addSub') || findBtnByText(['Subproceso','Sub-proceso','Sub proceso']);
      const btnStep = byId('addStep')|| byId('addStepProcess') || findBtnByText(['+ Paso','Paso']);
      if(btnSub && !btnSub.__pa_patch){ btnSub.__pa_patch = true; btnSub.addEventListener('click', ensureFirstStepAfterNewSub, true); }
      if(btnStep && !btnStep.__pa_patch){ btnStep.__pa_patch = true; btnStep.addEventListener('click', ()=>{ setTimeout(()=>{ clickAddStepInsideLastSub(); }, 120); }, false); }
    }
    bind();

    const mo = new win.MutationObserver((muts)=>{ bind(); for(const m of muts){ for(const n of m.addedNodes){ if(n.nodeType===1){ const txt=textOf(n); if(/subproceso/i.test(txt)) ensureFirstStepAfterNewSub(); } } } });
    mo.observe(doc.body,{childList:true,subtree:true});

    win.__PA_ORDER_PATCH__={
      unbind:()=>mo.disconnect(),
      clear:()=>{},
      addPair:()=>{ try{ const btnSub  = byId('addSub') || findBtnByText(['Subproceso','Sub-proceso','Sub proceso']); if(btnSub) btnSub.click(); ensureFirstStepAfterNewSub(); }catch(_){} },
      toggleEdit:()=>{ doc.body.classList.toggle('pa-edit'); },
      toggleCompact:()=>{ doc.body.classList.toggle('pa-compact'); }
    };
  }

  function bootWithHTML(html){
    view.srcdoc = html;
    view.addEventListener('load', ()=>{
      try{ applyOrderingPatch(view.contentWindow); }catch(e){}
    }, {once:true});
  }

  if(cached && String(cached).trim().length>50){
    bootWithHTML(cached);
  }else{
    const fb   = document.getElementById('fallback');
    const pick = document.getElementById('pick');
    const file = document.getElementById('file');
    fb.style.display='grid';
    pick.onclick = ()=>file.click();
    file.onchange = (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = (ev)=>{
        const html = String(ev.target.result||'');
        localStorage.setItem('pa_viewer_last', html);
        fb.style.display='none';
        bootWithHTML(html);
      };
      r.readAsText(f);
    };
  }
})();
</script>
<script>
// Barra inferior ‚Üí llamadas p√∫blicas al visor
(function(){
  function bindBar(){
    try{
      const v = document.getElementById('view');
      const pair  = document.getElementById('pairBtn');
      const save  = document.getElementById('savePairBtn');
      const clear = document.getElementById('clearCacheBtn');
      const pinBtn = document.getElementById('pinBtn');
      const pinField = document.getElementById('pinField');
      const edit = document.getElementById('editToggle');
      const compact = document.getElementById('compactToggle');
      const call  = (fn)=>{ try{ const api=v.contentWindow && v.contentWindow.__PA_ORDER_PATCH__; if(api && typeof api[fn]==='function') api[fn](); }catch(e){} };

      function applyPIN(){
        try{
          const w=v.contentWindow; const d=w && w.document; if(!w||!d) return;
          const val=(pinField && pinField.value ? pinField.value.trim() : 'AR4321');
          v.focus();

          const tryOpenUI = ()=>{
            try{
              const clickables=[...d.querySelectorAll('button,a,[role="button"],.btn,.action')];
              const wanted = /pin|acceso|desbloquear|introducir|privado/i;
              const cand = clickables.find(el=> wanted.test(((el.textContent||el.value||'')+'' ).trim()));
              if(cand){ cand.click(); return true; }
            }catch(_){ }
            return false;
          };

          const findInput = ()=>{
            try{
              const all=[...d.querySelectorAll('input, [contenteditable="true"]')];
              const re=/pin|c√≥digo|codigo|clave/i;
              let best = all.find(i=>{
                const name=((i.name||'')+' '+(i.id||'')+' '+(i.placeholder||'')+' '+(i.getAttribute('aria-label')||''));
                return (i.tagName==='INPUT' && (i.type==='password' || i.type==='tel' || i.type==='number' || re.test(name))) || (i.getAttribute && i.getAttribute('contenteditable')==='true' && re.test(name));
              });
              if(!best){ best = all.find(i=> i.tagName==='INPUT' && /text|search/.test(i.type||'') && /pin/i.test(i.placeholder||'')); }
              return best || null;
            }catch(_){ return null; }
          };

          const fillAndSubmit = (target)=>{
            try{
              if(!target) return false;
              if(target.getAttribute && target.getAttribute('contenteditable')==='true'){
                target.focus(); target.textContent = val;
              }else{
                target.focus(); target.value = val;
                target.dispatchEvent(new Event('input',{bubbles:true}));
                target.dispatchEvent(new Event('change',{bubbles:true}));
                try{ target.setSelectionRange(val.length,val.length); }catch(_){ }
              }
              const btns=[...d.querySelectorAll('button,input[type=submit]')];
              const ok=btns.find(b=>/entrar|acceder|desbloquear|aceptar|ok|validar|enviar/i.test(((b.value||b.textContent||'')+'')));
              if(ok){ ok.click(); }
              else if(target.form){ if(target.form.requestSubmit) target.form.requestSubmit(); else target.form.submit(); }
              if(typeof w.checkPin==='function') try{ w.checkPin(val); }catch(_){}
              if(typeof w.validatePin==='function') try{ w.validatePin(val); }catch(_){}
              w.PIN=val;
              return true;
            }catch(_){ return false; }
          };

          let tries=0;
          const loop=()=>{
            tries++;
            let input = findInput();
            if(input){ fillAndSubmit(input); return; }
            const opened = tryOpenUI();
            setTimeout(()=>{
              let input2 = findInput();
              if(input2){ fillAndSubmit(input2); }
              else if(tries<3){ loop(); }
            }, opened? 180 : 120);
          };
          loop();
        }catch(e){}
      }

      if(pair && !pair.__b){ pair.__b=true; pair.addEventListener('click', ()=>call('addPair')); }
      if(save && !save.__b){ save.__b=true; save.addEventListener('click', ()=>call('clear')); }
      if(clear && !clear.__b){ clear.__b=true; clear.addEventListener('click', ()=>{ try{ 
        localStorage.removeItem('pa_viewer_last');
        var fb=document.getElementById('fallback'); if(fb) fb.style.display='grid';
        var ifr=document.getElementById('view'); if(ifr) ifr.srcdoc='';
        var pick=document.getElementById('pick'); if(pick) pick.click();
      }catch(e){} }); }
      if(edit && !edit.__b){ edit.__b=true; edit.addEventListener('click', ()=>call('toggleEdit')); }
      if(compact && !compact.__b){ compact.__b=true; compact.addEventListener('click', ()=>call('toggleCompact')); }
      if(pinBtn && !pinBtn.__b){ pinBtn.__b=true; pinBtn.addEventListener('click', applyPIN); }
      if(pinField && !pinField.__b){ pinField.__b=true; pinField.addEventListener('keydown', (e)=>{ if(e.key==='Enter') applyPIN(); }); }
    }catch(e){}
  }
  bindBar();
  document.getElementById('view').addEventListener('load', bindBar);
})();
</script>
<script>(function(){try{var v=document.getElementById('view');function inject(){try{var w=v.contentWindow;var d=w.document;if(!w||!d) return; if(w.__PA_MODULES__) return; var css='._pa_toolbar{position:fixed;right:8px;top:8px;z-index:999999;display:flex;gap:6px}._pa_btn{border:1px solid #444;background:#1b1f2a;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}._pa_grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:10px;align-content:start;padding:8px}._pa_card{background:#0f1420;border:1px solid #2a3242;border-radius:12px;box-shadow:0 1px 0 rgba(255,255,255,.04) inset}._pa_wrap{padding:8px}._pa_title{font-weight:600;border-bottom:1px dashed #3a4151;padding:6px 8px;margin:0;color:#e5e7eb}._pa_ph{display:none}'; if(!d.getElementById('_pa_style')){var st=d.createElement('style'); st.id='_pa_style'; st.textContent=css; (d.head||d.documentElement).appendChild(st);} function txt(el){return (el&&(el.textContent||'').trim())||'';} function host(){return d.querySelector('#rightBody')||d.querySelector('[data-panel="right"]')||d.querySelector('.right')||d.querySelector('.flow')||null;} function isHeader(el){if(!el||el.nodeType!==1) return false; var t=txt(el).toLowerCase(); if(t.indexOf('subproceso')>-1||t.indexOf('sub-proceso')>-1) return true; var cn=(el.className||''); return /subproc|sub-proc|sub_pro/i.test(cn);} function group(c){var kids=[].slice.call(c.children); var groups=[]; var cur=null; for(var i=0;i<kids.length;i++){var node=kids[i]; if(isHeader(node)){cur={nodes:[node]}; groups.push(cur);} else if(cur){cur.nodes.push(node);} } return groups.length?groups:null;} var state={active:false,map:[],grid:null,host:null,phStart:null}; function toModules(){var h=host(); if(!h||state.active) return; var groups=group(h); if(!groups) return; state.active=true; state.map=[]; var grid=d.createElement('div'); grid.className='_pa_grid'; var phStart=d.createComment('_pa_start'); h.parentNode.insertBefore(phStart,h); for(var gi=0;gi<groups.length;gi++){var g=groups[gi]; var card=d.createElement('div'); card.className='_pa_card'; var wrap=d.createElement('div'); wrap.className='_pa_wrap'; var ph=d.createComment('_pa_ph'); state.map.push({ph:ph,nodes:g.nodes}); h.insertBefore(ph,g.nodes[0]); for(var j=0;j<g.nodes.length;j++){card.appendChild(g.nodes[j]);} var title=d.createElement('div'); title.className='_pa_title'; title.textContent=(txt(card.firstChild)||'Subproceso'); card.insertBefore(title,card.firstChild); card.appendChild(wrap); while(card.childNodes.length>1){ wrap.appendChild(card.childNodes[1]); } grid.appendChild(card);} h.style.display='none'; phStart.parentNode.insertBefore(grid,phStart.nextSibling); state.grid=grid; state.host=h; state.phStart=phStart;} function toLineal(){ if(!state.active) return; var h=state.host; if(!h) return; for(var k=0;k<state.map.length;k++){var entry=state.map[k]; var ph=entry.ph; var nodes=entry.nodes; for(var t=0;t<nodes.length;t++){ h.insertBefore(nodes[t],ph);} ph.parentNode&&ph.parentNode.removeChild(ph);} if(state.grid&&state.grid.parentNode) state.grid.parentNode.removeChild(state.grid); h.style.display=''; if(state.phStart&&state.phStart.parentNode) state.phStart.parentNode.removeChild(state.phStart); state={active:false,map:[],grid:null,host:null,phStart:null}; } w.__PA_MODULES__={on:toModules,off:toLineal,toggle:function(){state.active?toLineal():toModules();}}; if(!d.getElementById('_pa_toolbar')){var tb=d.createElement('div'); tb.id='_pa_toolbar'; tb.className='._pa_toolbar'.slice(1); var b1=d.createElement('button'); b1.className='._pa_btn'.slice(1); b1.textContent='M√≥dulos'; b1.onclick=toModules; var b2=d.createElement('button'); b2.className='._pa_btn'.slice(1); b2.textContent='Lineal'; b2.onclick=toLineal; tb.appendChild(b1); tb.appendChild(b2); d.body.appendChild(tb);} }catch(e){}} function ensureOuterToggle(){var bottom=document.querySelector('.bottom'); if(!bottom) return; if(!document.getElementById('toggleModulesBtn')){var b=document.createElement('button'); b.id='toggleModulesBtn'; b.className='bbtn'; b.textContent='üìê Vista m√≥dulos'; var clear=document.getElementById('clearCacheBtn'); if(clear&&clear.parentNode){ clear.parentNode.insertBefore(b,clear);} else { bottom.appendChild(b);} } var btn=document.getElementById('toggleModulesBtn'); if(btn&&!btn.__b){ btn.__b=true; btn.addEventListener('click',function(){ try{ var w=v.contentWindow; if(w&&w.__PA_MODULES__) w.__PA_MODULES__.toggle(); }catch(e){} }); } } ensureOuterToggle(); v.addEventListener('load',function(){ inject(); ensureOuterToggle(); }); inject(); }catch(e){}})();</script></body>
</html>
