<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PROCESOS AUDIO</title>
<style>
  :root{
    --bg:#0f1115; --ink:#e5e7eb; --muted:#a1a7b3; --stroke:#2b3444;
    --panel:#141824; --panel2:#0f1420; --pill:linear-gradient(180deg,#2a3345,#161b26);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  .app{display:grid;grid-template-rows:auto 1fr;min-height:100%}

  /* Header */
  .hdr{background:linear-gradient(90deg,#7f1d1d,#374151 45%,#111827 85%);
       padding:10px 12px;border-bottom:1px solid #3a4151;
       display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .brand{display:flex;gap:8px;align-items:center}
  .icon{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#1f2937;border:1px solid #334155}
  .icon svg{width:18px;height:18px;fill:#e5e7eb}
  .title{font-weight:800}
  .hdr-actions{display:flex;gap:8px;align-items:center}
  .btn{background:var(--pill);border:1px solid #3a4151;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .search{max-width:520px;display:flex;gap:6px;align-items:center}
  .search input{flex:1;min-width:260px;padding:8px 10px;border-radius:10px;border:1px solid #3a4151;background:#0f1320;color:#fff}

  /* Main split */
  .main{display:grid;grid-template-columns:1.2fr 1.8fr;min-height:0}
  .left{min-width:0;border-right:1px solid var(--stroke);display:flex;flex-direction:column}
  .right{min-width:0;display:flex;flex-direction:column}
  .panel-h{display:flex;align-items:center;gap:8px;padding:10px;background:var(--panel);border-bottom:1px solid var(--stroke)}
  .panel-b{padding:10px;overflow:auto;flex:1}

  /* Procesos */
  .hbtn{background:var(--pill);border:1px solid #3a4151;color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer}
  .plist{display:flex;flex-direction:column;gap:8px}
  .proc{background:var(--panel2);border:1px solid var(--stroke);border-radius:12px;padding:6px 8px;display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
  .proc.drag{opacity:.6}
  .swatch{width:14px;height:14px;border-radius:50%;border:1px solid #111}
  .pname{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .ptitle{min-width:0;display:flex;align-items:center;gap:6px}
  .ptitle input{width:100%;background:#0f1320;border:1px solid #3a4151;border-radius:8px;color:#fff;padding:4px 6px}
  .picons{display:flex;gap:4px}
  .ic{width:24px;height:24px;border:1px solid #3a4151;border-radius:8px;background:#1c2433;display:grid;place-items:center;cursor:pointer;font-size:12px}
  .ic:hover{filter:brightness(1.06)}
  .pdesc{grid-column:1 / -1;display:none;margin-top:6px}
  .pdesc textarea{width:100%;min-height:56px;border-radius:10px;border:1px solid #3a4151;background:#0f1320;color:#fff;padding:8px}

  /* Right side */
  .stamp{font-size:12px;color:var(--muted)}
  .sub{background:linear-gradient(180deg,#212734,#141824);border:1px solid #2d3748;border-radius:12px;margin-bottom:8px}
  .sub-h{display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px dashed #3a4151}
  .sub-name{flex:1;display:flex;gap:6px;align-items:center}
  .sub-name input{flex:1;background:#0f1320;border:1px solid #3a4151;border-radius:8px;padding:6px 8px;color:#fff}
  .sel{background:#0f1320;border:1px solid #3a4151;border-radius:8px;color:#fff;padding:6px 8px}
  .sub-body{padding:6px 10px}

  .steps{position:relative;padding-left:26px}
  .line{position:absolute;left:14px;top:0;bottom:0;width:2px;background:#334155;opacity:.95;pointer-events:none}
  .step{display:grid;grid-template-columns:auto 1fr auto;gap:6px;align-items:center;padding:4px 0;border-bottom:1px dashed #2a3242}
  .snum{min-width:24px;text-align:center;font-weight:700;font-size:12px;position:relative;z-index:2}
  .stitle input{width:100%;background:#0f1320;border:1px solid #3a4151;border-radius:8px;padding:6px 8px;color:#fff}
  .sicons{display:flex;gap:4px;align-items:center}
  .detail{grid-column:1 / -1;display:none}
  .detail textarea{width:100%;min-height:68px;background:#0f1320;border:1px solid #3a4151;border-radius:10px;color:#fff;padding:8px}

  .cond{grid-column:1 / -1;display:none;margin-top:6px;padding:6px;border:1px dashed #3a4151;border-radius:10px;background:#0e1320}
  .cond-h{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .chip{border:1px solid #3a4151;border-radius:999px;background:#1c2433;color:#fff;padding:2px 8px;font-size:12px}
  .chip.no{font-weight:800}
  .points{display:flex;flex-direction:column;gap:6px}
  .pitem{display:grid;grid-template-columns:auto 1fr auto;gap:6px;align-items:center}
  .pnum{font-size:11px;min-width:38px;text-align:right;opacity:.9}
  .ptext input{width:100%;background:#0f1320;border:1px solid #3a4151;border-radius:8px;color:#fff;padding:6px 8px}
  .tag{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:2px 8px;border:1px solid #374151;background:#111827;font-size:12px;margin:4px 0}

  .attach{margin:8px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .alnk,.adoc{display:inline-flex;gap:6px;align-items:center;border:1px solid #3a4151;background:#1c2433;color:#fff;border-radius:10px;padding:6px 8px}
  .alnk a{color:#93c5fd;text-decoration:none}

  @media (max-width: 980px){ .main{grid-template-columns:1fr} }
  @media print{
    .btn,.hbtn,.ic,.sel,.search,.attach .alnk,.attach .adoc{display:none!important}
    .detail,.cond{display:block!important}
    .main{grid-template-columns:1fr}
  }

  /* PIN overlay */
  .gate{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(2px);display:grid;place-items:center;z-index:9999}
  .card{background:#0f1420;border:1px solid #3a4151;border-radius:14px;padding:16px 18px;min-width:280px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
  .row{display:flex;gap:8px}
  .row input{flex:1;background:#0f1320;border:1px solid #3a4151;border-radius:10px;padding:10px;color:#fff}
  .mut{color:#9ca3af;font-size:12px;margin-top:8px}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="hdr">
    <div class="brand">
      <div class="icon" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M3 10a7 7 0 0 1 14 0v7a2 2 0 0 1-2 2h-1a1 1 0 0 1-1-1v-7a5 5 0 0 0-10 0v7a1 1 0 0 1-1 1H1v-2h1z"/></svg>
      </div>
      <div class="title">PROCESOS AUDIO</div>
    </div>
    <div class="search">
      <input id="search" placeholder="Buscar en todo‚Ä¶"/>
    </div>
    <div class="hdr-actions">
      <button class="btn" id="downloadHtml">‚¨áÔ∏è HTML</button>
      <button class="btn" id="printAll">üñ®Ô∏è PDF</button>
      <button class="btn" id="saveCloud">‚òÅÔ∏è Guardar</button>
      <button class="btn" id="loadCloud">‚òÅÔ∏è‚§¥ Actualizar</button>
    </div>
  </div>

  <div class="main">
    <!-- Izquierda: Procesos -->
    <div class="left">
      <div class="panel-h">
        <button class="hbtn" id="addProcess">+Procesos</button>
      </div>
      <div class="panel-b">
        <div id="plist" class="plist" aria-label="Procesos"></div>
      </div>
    </div>

    <!-- Derecha: Sub-procesos + Pasos -->
    <div class="right">
      <div class="panel-h">
        <div class="stamp" id="stamp">√öltima actualizaci√≥n: ‚Äî</div>
        <div style="flex:1"></div>
        <button class="hbtn" id="addSub">Sub-proceso +</button>
        <button class="hbtn" id="addStep">Paso +</button>
        <button class="hbtn" id="saveNow">Guardar</button>
      </div>
      <div class="panel-b" id="rightBody"></div>
    </div>
  </div>
</div>

<!-- PIN -->
<div class="gate" id="gate">
  <div class="card">
    <h3>Acceso con PIN</h3>
    <div class="row">
      <input id="pin" placeholder="C√≥digo PIN (AR4321)"/>
      <button class="btn" id="enterPin">Entrar</button>
    </div>
    <div class="mut">Pulsa <b>Enter</b> para confirmar.</div>
  </div>
</div>

<script>
(function(){
  // ========== Estado ==========
  const storeKey = 'PA_APP_V2';
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const uid = () => Math.random().toString(36).slice(2,10);
  const pastel = ['#fca5a5','#fdba74','#fde68a','#a7f3d0','#93c5fd','#c4b5fd','#f9a8d4','#fcd34d','#86efac','#a5b4fc','#fca5c0','#f59e0b'];
  let colorUsed = new Set();
  const nextColor = () => {
    for (const c of pastel){ if(!colorUsed.has(c)){ colorUsed.add(c); return c; } }
    return pastel[Math.floor(Math.random()*pastel.length)];
  };

  const defaultProc = () => ({ id:uid(), title:'Nuevo proceso', desc:'', color:nextColor(), subprocs:[], steps:[], links:[], files:[] });
  const defaultSub  = () => ({ id:uid(), title:'Sub-proceso', desc:'', resp:'Audi√≥logo', steps:[] });
  const defaultStep = (n)=> ({ id:uid(), title:'Paso '+n, desc:'', resp:'Audi√≥logo', next:null, yes:[], no:[] });

  const state = { processes:[], sel:null, updatedAt:null };

  // ========== PIN ==========
  const gate=qs('#gate'), pin=qs('#pin'), enterPin=qs('#enterPin');
  function unlock(){ gate.style.display='none'; pin.value=''; }
  function checkPIN(){ ((pin.value||'').trim().toUpperCase()==='AR4321') ? unlock() : (pin.focus(), pin.select()); }
  enterPin.onclick = checkPIN;
  pin.addEventListener('keydown', e=>{ if(e.key==='Enter') checkPIN(); });

  // ========== Persistencia ==========
  function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); touchStamp(); }
  function load(){
    try{
      const raw=localStorage.getItem(storeKey);
      if(raw){
        const data=JSON.parse(raw);
        if(data && Array.isArray(data.processes)){
          Object.assign(state, data);
          colorUsed = new Set(state.processes.map(p=>p.color));
        }
      }
    }catch(e){}
  }
  function touchStamp(){
    state.updatedAt = new Date().toISOString();
    qs('#stamp').textContent = '√öltima actualizaci√≥n: ' + new Date(state.updatedAt).toLocaleString();
  }

  // ========== Render Procesos (izquierda) ==========
  const plist=qs('#plist');
  function renderLeft(filter=''){
    plist.innerHTML='';
    const f=filter.toLowerCase();
    state.processes
      .filter(p=>!f || p.title.toLowerCase().includes(f) || (p.desc||'').toLowerCase().includes(f))
      .forEach((p,i)=> plist.appendChild(procItem(p,i)));
    enableDrag();
  }

  function procItem(p,i){
    const el=document.createElement('div'); el.className='proc'; el.draggable=true; el.dataset.id=p.id;
    const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=p.color;
    const mid=document.createElement('div'); mid.className='ptitle';
    const name=document.createElement('div'); name.className='pname'; name.textContent=(i+1)+'. '+p.title; name.title=p.title;
    mid.appendChild(name);
    const icons=document.createElement('div'); icons.className='picons';
    icons.appendChild(ic('‚úèÔ∏è','Editar',()=>editProcess(p,el)));
    icons.appendChild(ic('‚ñæ','Detalles',()=>toggleDesc(el)));
    icons.appendChild(ic('üóëÔ∏è','Eliminar',()=>delProcess(p.id)));
    el.append(sw,mid,icons);

    const d=document.createElement('div'); d.className='pdesc';
    const ta=document.createElement('textarea'); ta.value=p.desc||''; ta.placeholder='Descripci√≥n del proceso‚Ä¶';
    ta.oninput=()=>{ p.desc=ta.value; save(); };
    d.appendChild(ta);
    el.appendChild(d);

    el.addEventListener('click',e=>{ if(e.target.closest('.ic')) return; selectProcess(p.id); });
    if(p.id===state.sel) el.style.outline='2px solid '+p.color;
    return el;
  }
  function ic(txt,title,on){ const b=document.createElement('button'); b.className='ic'; b.title=title; b.textContent=txt; b.onclick=(e)=>{ e.stopPropagation(); on&&on(); }; return b; }
  function editProcess(p,row){
    const mid=row.querySelector('.ptitle'); mid.innerHTML='';
    const inp=document.createElement('input'); inp.value=p.title;
    inp.onkeydown = e=>{ if(e.key==='Enter'){ p.title=inp.value.trim()||p.title; save(); renderLeft(qs('#search').value); renderRight(); }};
    inp.onblur    = ()=>{ p.title=inp.value.trim()||p.title; save(); renderLeft(qs('#search').value); renderRight(); };
    mid.appendChild(inp); inp.focus(); inp.select();
  }
  function toggleDesc(row){
    const d=row.querySelector('.pdesc'); d.style.display=(d.style.display==='block'?'none':'block');
  }
  function delProcess(id){
    const i=state.processes.findIndex(x=>x.id===id);
    if(i>-1){ state.processes.splice(i,1); if(state.sel===id) state.sel = state.processes[0]?.id || null; save(); renderLeft(qs('#search').value); renderRight(); }
  }

  // Drag & drop ordenar
  function enableDrag(){
    let dragId=null;
    plist.querySelectorAll('.proc').forEach(el=>{
      el.addEventListener('dragstart',e=>{ dragId=el.dataset.id; el.classList.add('drag'); e.dataTransfer.effectAllowed='move'; });
      el.addEventListener('dragend',()=>{ el.classList.remove('drag'); dragId=null; });
      el.addEventListener('dragover',e=>{
        e.preventDefault();
        const dragging=qs('.proc.drag'); if(!dragging) return;
        const els=[...plist.children]; const iFrom=els.indexOf(dragging); const iTo=els.indexOf(el);
        if(iTo<iFrom) plist.insertBefore(dragging,el); else plist.insertBefore(dragging,el.nextSibling);
      });
    });
    plist.addEventListener('drop',()=>{
      const ids=[...plist.querySelectorAll('.proc')].map(x=>x.dataset.id);
      state.processes.sort((a,b)=> ids.indexOf(a.id)-ids.indexOf(b.id));
      save(); renderLeft(qs('#search').value); renderRight();
    });
  }

  // ========== Derecha ==========
  const rb=qs('#rightBody');

  function renderRight(){
    const p = state.processes.find(x=>x.id===state.sel);
    rb.innerHTML='';
    if(!p){ rb.innerHTML='<div style="opacity:.75">Crea un proceso para empezar‚Ä¶</div>'; return; }

    // Adjuntos (√∫nica zona por proceso)
    const at=document.createElement('div'); at.className='attach';
    const lnk=document.createElement('label'); lnk.className='alnk'; lnk.innerHTML='üîó Adjuntar enlace <input type="url" hidden>';
    const doc=document.createElement('label'); doc.className='adoc'; doc.innerHTML='üìé Adjuntar documento <input type="file" hidden>';
    const list=document.createElement('div'); list.style.display='flex'; list.style.gap='6px'; list.style.flexWrap='wrap';
    function paintAtt(){
      list.innerHTML='';
      (p.links||[]).forEach((u,i)=>{ const a=document.createElement('a'); a.href=u; a.target='_blank'; a.textContent='Enlace '+(i+1); a.className='alnk'; list.appendChild(a); });
      (p.files||[]).forEach((f,i)=>{ const span=document.createElement('span'); span.textContent='Doc '+(i+1); span.className='adoc'; list.appendChild(span); });
    }
    lnk.querySelector('input').addEventListener('change',e=>{ const v=e.target.value.trim(); if(v){ (p.links||(p.links=[])).push(v); save(); paintAtt(); e.target.value=''; }});
    doc.querySelector('input').addEventListener('change',e=>{ const file=e.target.files[0]; if(file){ (p.files||(p.files=[])).push(file.name); save(); paintAtt(); e.target.value=''; }});
    at.append(lnk,doc,list); rb.appendChild(at); paintAtt();

    // Si no hay subprocesos y hay pasos -> pasos directos
    if((p.subprocs||[]).length===0 && (p.steps||[]).length>0){
      rb.appendChild(renderStepsList(p, null));
    }

    // Cada sub-proceso + sus pasos
    (p.subprocs||[]).forEach(s=>{
      const card=document.createElement('div'); card.className='sub';
      const h=document.createElement('div'); h.className='sub-h';
      const nm=document.createElement('div'); nm.className='sub-name';
      const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=p.color; sw.title='Color proceso';
      const inp=document.createElement('input'); inp.value=s.title; inp.oninput=()=>{ s.title=inp.value; save(); };
      const sel=document.createElement('select'); sel.className='sel';
      ['Audi√≥logo','Responsable','Otros'].forEach(o=>{ const op=document.createElement('option'); op.value=op.textContent=o; if(o===s.resp) op.selected=true; sel.appendChild(op); });
      sel.onchange=()=>{ s.resp=sel.value; save(); };
      const del=ic('üóëÔ∏è','Eliminar sub-proceso',()=>{ const i=p.subprocs.indexOf(s); if(i>-1){ p.subprocs.splice(i,1); save(); renderRight(); }});
      nm.append(sw,inp); h.append(nm,sel,del); card.appendChild(h);

      card.appendChild(renderStepsList(p,s));
      rb.appendChild(card);
    });

    // color de la l√≠nea vertical
    rb.style.setProperty('--line', p.color);
  }

  function renderStepsList(proc, sub){
    const wrap=document.createElement('div'); wrap.className='sub-body';
    const steps = sub ? (sub.steps||(sub.steps=[])) : (proc.steps||(proc.steps=[]));
    const box=document.createElement('div'); box.className='steps';
    const line=document.createElement('div'); line.className='line'; line.style.background=proc.color; box.appendChild(line);

    steps.forEach((st,i)=> box.appendChild(stepRow(proc, sub, steps, st, i)) );

    // bot√≥n de cierre/meta al final
    const end=document.createElement('div'); end.style.marginTop='6px';
    const finish=document.createElement('button'); finish.className='hbtn'; finish.textContent='üéØ Guardar (cerrar pasos)';
    finish.onclick=()=>{ save(); touchStamp(); };
    end.appendChild(finish); box.appendChild(end);

    wrap.appendChild(box);
    return wrap;
  }

  function stepRow(proc, sub, arr, st, idx){
    const row=document.createElement('div'); row.className='step';
    const sn=document.createElement('div'); sn.className='snum'; sn.textContent=(idx+1);
    const ti=document.createElement('div'); ti.className='stitle';
    const inp=document.createElement('input'); inp.value=st.title; inp.oninput=()=>{ st.title=inp.value; save(); }; ti.appendChild(inp);
    const icz=document.createElement('div'); icz.className='sicons';

    const resp=document.createElement('select'); resp.className='sel';
    ['Audi√≥logo','Responsable','Otros'].forEach(o=>{ const op=document.createElement('option'); op.value=op.textContent=o; if(o===st.resp) op.selected=true; resp.appendChild(op); });
    resp.onchange=()=>{ st.resp=resp.value; save(); };

    const btnDet = ic('‚ñæ','Detalle',()=>{ det.style.display = det.style.display==='block'?'none':'block'; });
    const btnYN  = ic('¬ø','S√≠ / NO',()=>{ cond.style.display='block'; }); // se queda abierto hasta terminar
    const btnFlag= ic('üö©','Pr√≥ximo proceso',()=> openFlag(proc, st, tag));
    const btnDel = ic('üóëÔ∏è','Eliminar paso',()=>{ const i=arr.indexOf(st); if(i>-1){ arr.splice(i,1); save(); renderRight(); }});

    icz.append(resp,btnDet,btnYN,btnFlag,btnDel);

    // Detalle (siempre inmediatamente despu√©s del t√≠tulo)
    const det=document.createElement('div'); det.className='detail';
    const ta=document.createElement('textarea'); ta.placeholder='Detalle‚Ä¶'; ta.value=st.desc||''; ta.oninput=()=>{ st.desc=ta.value; save(); };
    det.appendChild(ta);

    // S√≠ / No (siempre despu√©s del detalle)
    const cond=document.createElement('div'); cond.className='cond';
    const ch=document.createElement('div'); ch.className='cond-h';
    const chipY=document.createElement('span'); chipY.className='chip'; chipY.textContent='s√≠';
    const chipN=document.createElement('span'); chipN.className='chip no'; chipN.textContent='S√ç/NO'; chipN.style.fontWeight='800';
    ch.append(chipY,chipN);
    const pts=document.createElement('div'); pts.className='points';
    const addBar=document.createElement('div'); addBar.style.margin='4px 0 2px';
    const addY=document.createElement('button'); addY.className='hbtn'; addY.textContent='+ s√≠'; addY.onclick=()=>{ st.yes.push({id:uid(),text:'',next:null}); save(); paintPts(); };
    const addN=document.createElement('button'); addN.className='hbtn'; addN.textContent='+ NO'; addN.onclick=()=>{ st.no.push({id:uid(),text:'',next:null}); save(); paintPts(); };
    addBar.append(addY,addN);

    function paintPts(){
      pts.innerHTML='';
      const base=(idx+1);
      const mk=(arr,label)=>arr.map((it,k)=>{
        const r=document.createElement('div'); r.className='pitem';
        const n=document.createElement('div'); n.className='pnum'; n.textContent = base + '.' + (k+1);
        const t=document.createElement('div'); t.className='ptext';
        const ii=document.createElement('input'); ii.value=it.text; ii.placeholder=(label==='yes'?'S√≠ ':'NO ')+(k+1);
        ii.oninput=()=>{ it.text=ii.value; save(); };
        t.appendChild(ii);
        const a=document.createElement('div'); a.className='flag';
        const tg=document.createElement('span'); tg.className='tag'; tg.style.display='none';
        const bFlag=ic('üö©','Pr√≥ximo proceso',()=> openFlag(proc,it,tg));
        const bDel=ic('üóëÔ∏è','Eliminar punto',()=>{ const arr2=(label==='yes'?st.yes:st.no); const i2=arr2.indexOf(it); if(i2>-1){ arr2.splice(i2,1); save(); paintPts(); }});
        a.append(bFlag,bDel,tg);
        r.append(n,t,a); return r;
      });
      mk(st.yes,'yes').forEach(x=>pts.appendChild(x));
      mk(st.no,'no').forEach(x=>pts.appendChild(x));
    }
    paintPts();

    cond.append(ch,addBar,pts);

    const tag=document.createElement('span'); tag.className='tag'; tag.style.display='none';

    row.append(sn,ti,icz,det,cond,tag);
    return row;
  }

  function openFlag(proc, obj, tagEl){
    const list=document.createElement('select'); list.className='sel';
    state.processes.forEach(p=>{ const op=document.createElement('option'); op.value=p.id; op.textContent=p.title; list.appendChild(op); });
    const ok=document.createElement('button'); ok.className='hbtn'; ok.textContent='Vincular';
    const dlg=document.createElement('div'); dlg.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;z-index:9999';
    const card=document.createElement('div'); card.style.cssText='background:#0f1420;border:1px solid #3a4151;border-radius:12px;padding:12px;display:flex;gap:8px;align-items:center';
    ok.onclick=()=>{ obj.next=list.value; const p2=state.processes.find(x=>x.id===obj.next);
      if(p2){ tagEl.style.display='inline-flex'; tagEl.innerHTML='üö© Ir al proceso: <b>'+p2.title+'</b>'; tagEl.style.margin='4px 0'; }
      save(); document.body.removeChild(dlg);
    };
    card.append('Ir al proceso:',list,ok); dlg.appendChild(card); document.body.appendChild(dlg);
  }

  // ========== Acciones ==========
  qs('#addProcess').onclick = ()=>{ const p=defaultProc(); state.processes.push(p); state.sel=p.id; save(); renderLeft(qs('#search').value); renderRight(); };
  qs('#addSub').onclick = ()=>{ const p=state.processes.find(x=>x.id===state.sel); if(!p) return; const s=defaultSub(); p.subprocs.push(s); save(); renderRight(); };
  qs('#addStep').onclick = ()=>{ const p=state.processes.find(x=>x.id===state.sel); if(!p) return; const arr=(p.subprocs.length? p.subprocs[p.subprocs.length-1].steps : p.steps); arr.push(defaultStep(arr.length+1)); save(); renderRight(); };
  qs('#saveNow').onclick = ()=>{ save(); };

  qs('#printAll').onclick = ()=>{ qsa('.detail').forEach(d=>d.style.display='block'); qsa('.cond').forEach(c=>c.style.display='block'); setTimeout(()=>window.print(),50); };
  qs('#saveCloud').onclick = ()=> save();
  qs('#loadCloud').onclick = ()=>{ load(); renderLeft(qs('#search').value); renderRight(); };
  qs('#downloadHtml').onclick = ()=>{ const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='procesos-audio.html'; a.click(); URL.revokeObjectURL(a.href); };
  qs('#search').oninput = e=> renderLeft(e.target.value);

  function selectProcess(id){ state.sel=id; save(); renderLeft(qs('#search').value); renderRight(); }

  // ========== Boot ==========
  load();
  if(!state.processes.length){
    const p=defaultProc(); p.title='Proceso 1';
    const s=defaultSub(); s.title='Sub-proceso 1';
    s.steps.push(defaultStep(1));
    p.subprocs.push(s);
    state.processes.push(p);
    state.sel=p.id;
  }
  touchStamp(); renderLeft(); renderRight();
})();
</script>
</body>
</html>
