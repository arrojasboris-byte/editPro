<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PROCESOS AUDIO</title>
<style>
  :root{
    --bg:#020617;
    --bg-soft:#0b1120;
    --panel:#020617;
    --surface:#0f172a;
    --ink:#f9fafb;
    --muted:#9ca3af;
    --accent:#ef4444;
    --accent-soft:#fecaca;
    --shadow:0 18px 40px rgba(0,0,0,.75);
    --ring:0 0 0 2px rgba(248,113,113,.5);
    --stepSide:#fed7aa;
    --stepBg:#f3f4f6;
    --yes:#22c55e;
    --no:#f97316;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    overflow:hidden;
    background:#e5e7eb;
    color:var(--ink);
  } 

  /* ===== Top bar ===== */
  .topbar{
    display:flex;
    align-items:center;
    gap:.6rem;
    padding:.45rem 1rem .6rem;
    background:linear-gradient(90deg,#020617,#020617 25%,#0b1120 70%,#020617 100%);
    box-shadow:0 10px 26px rgba(0,0,0,.85);
    z-index:40;
  }
  .logo{
    display:flex;
    align-items:center;
    gap:.45rem;
    font-weight:900;
    letter-spacing:.04em;
    font-size:20px;
    margin-right:.75rem;
  }
  .logo span.ear{font-size:26px;transform:translateY(1px)}
  .search{
    display:flex;
    align-items:center;
    gap:.3rem;
    background:#020617;
    border-radius:999px;
    padding:.25rem .7rem;
    box-shadow:inset 0 1px 0 rgba(148,163,184,.4),0 0 0 1px rgba(15,23,42,.9);
    max-width:320px;
    flex:1;
  }
  .search span{font-size:13px;opacity:.75}
  .search input{
    border:0;background:transparent;outline:0;color:var(--ink);
    font-size:13px;width:100%;
  }

  .btn3d{
    display:inline-flex;
    align-items:center;
    gap:.3rem;
    padding:.32rem .7rem;
    border-radius:999px;
    border:0;
    font-size:11px;
    font-weight:700;
    letter-spacing:.03em;
    cursor:pointer;
    color:#fee2e2;
    background:radial-gradient(circle at 20% 0,#f97373,#b91c1c);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.28),
      0 2px 0 rgba(127,29,29,1),
      0 9px 18px rgba(0,0,0,.9);
    white-space:nowrap;
  }
  .btn3d span.icon{font-size:13px}
  .btn3d:active{
    transform:translateY(1px);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.22),
      0 1px 0 rgba(127,29,29,1),
      0 6px 12px rgba(0,0,0,.85);
  }
  .btn3d-ghost{
    background:#020617;
    color:#e5e7eb;
    box-shadow:
      inset 0 1px 0 rgba(148,163,184,.35),
      0 2px 0 rgba(15,23,42,1),
      0 9px 18px rgba(0,0,0,.95);
  }

  .dept-wrap{
    display:flex;
    align-items:center;
    gap:.35rem;
    margin-left:.8rem;
  }
  .dept-select{
    border-radius:999px;
    border:1px solid rgba(148,163,184,.7);
    background:#020617;
    color:#e5e7eb;
    font-size:12px;
    padding:.28rem .7rem;
  }

  .top-right{
    margin-left:auto;
    display:flex;
    align-items:center;
    gap:.4rem;
  }
  .stamp{
    padding:.2rem .7rem;
    border-radius:999px;
    background:#020617;
    color:var(--muted);
    font-size:11px;
    box-shadow:inset 0 1px 0 rgba(148,163,184,.35);
  }

  /* ===== Layout ===== */
  .layout{
    height:calc(100% - 56px);
    display:grid;
    grid-template-columns:300px minmax(0,1fr);
  }
  @media (max-width:960px){
    .layout{grid-template-columns:1fr;grid-template-rows:260px minmax(0,1fr);}
  }
  .left{
    background:#f3f4f6;
    border-right:1px solid rgba(209,213,219,.9);
    padding:10px 10px 12px;
    overflow-y:auto;
    color:#020617;
  }
  .right{
    background:#f9fafb;
    padding:10px;
    overflow:auto;
    color:#020617;
  }

  /* ===== Departments & processes left ===== */
  .dept-block{
    margin-bottom:10px;
    border-radius:16px;
    background:#ffffff;
    box-shadow:0 6px 16px rgba(15,23,42,.12);
    padding:6px 6px 8px;
    border:1px solid rgba(209,213,219,.9);
  }
  .dept-head{
    display:flex;
    align-items:center;
    gap:.4rem;
    padding:.25rem .4rem .35rem;
  }
  .dept-title{
    flex:1;font-size:13px;font-weight:800;cursor:pointer;
  }
  .dept-tag{
    font-size:11px;
    padding:.2rem .65rem;
    border-radius:999px;
    background:#111827;
    color:#f9fafb;
    border:0;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:.25rem;
  }

  .proc-list{margin-top:4px;padding-top:4px;border-top:1px solid rgba(31,41,55,.9);}
  .proc-item{
    display:flex;flex-direction:column;gap:.2rem;
    padding:.35rem .45rem;
    margin-bottom:4px;
    border-radius:12px;
    background:#f9fafb;
    box-shadow:0 1px 0 rgba(148,163,184,.4);
    cursor:pointer;
    color:#020617;
  }
  .proc-item.active{
    box-shadow:var(--ring),0 1px 0 rgba(148,163,184,.9);
  }
  .proc-main{
    display:flex;align-items:center;gap:.4rem;
  }
  .dot{
    width:10px;height:10px;border-radius:999px;
    box-shadow:inset 0 0 0 2px rgba(15,23,42,.9);
  }
  .proc-name{flex:1;font-size:13px;font-weight:800;}
  .proc-actions{display:flex;align-items:center;gap:.25rem;}
  .icon-btn{
    width:26px;height:26px;border-radius:999px;border:0;
    background:#020617;color:#e5e7eb;
    cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(148,163,184,.35),0 2px 0 rgba(15,23,42,1);
    font-size:13px;
  }
  .icon-btn:active{transform:translateY(1px);}
  .proc-detail{display:none;margin-top:2px;}
  .proc-detail textarea{
    width:100%;min-height:60px;border-radius:10px;
    border:1px solid rgba(55,65,81,.9);
    background:#020617;color:#e5e7eb;font-size:12px;
    padding:.35rem .45rem;
  }

  /* ===== Right: header ===== */
  .board-head{
    display:flex;
    align-items:center;
    gap:.6rem;
    margin-bottom:10px;
  }
  .board-title{
    flex:1;
    background:transparent;
    padding:.3rem 0 .5rem;
    border-radius:0;
    display:flex;
    align-items:flex-end;
    gap:.4rem;
    box-shadow:none;
  }
  .board-title strong{font-size:18px;letter-spacing:.02em;color:#111827;}
  .board-title small{font-size:11px;color:var(--muted);display:none;}
  .board-head-controls{display:flex;align-items:center;gap:.4rem;}
  .pill-black{
    background:#020617;color:#e5e7eb;border-radius:999px;
    border:1px solid rgba(31,41,55,.95);
    padding:.35rem .75rem;font-size:12px;font-weight:700;
    display:inline-flex;align-items:center;gap:.3rem;
    cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(148,163,184,.3),0 2px 0 rgba(15,23,42,1),0 8px 18px rgba(0,0,0,.9);
  }
  .pill-black:active{transform:translateY(1px);}

  /* ===== Modules ===== */
  .modules{display:flex;flex-direction:column;gap:10px;padding-bottom:40px;}
  .module{
    position:relative;
    background:#ffffff;
    border-radius:18px;
    padding:8px 8px 10px;
    box-shadow:0 8px 20px rgba(15,23,42,.15);
    border:1px solid rgba(209,213,219,.9);
  }
  .module.sub-child{
    border:1px dashed rgba(148,163,184,.7);
    box-shadow:0 6px 16px rgba(15,23,42,.12);
  }
  .mod-head{
    display:flex;align-items:center;gap:.4rem;
    padding:.3rem .55rem .4rem;
    border-radius:14px;
    background:radial-gradient(circle at 0 0,#020617,#020617 55%,#020617 100%);
  }
  .mod-title{
    flex:1;border:0;outline:0;background:transparent;
    color:var(--ink);font-weight:800;font-size:13px;
  }
  .mod-select{
    border-radius:999px;border:1px solid rgba(55,65,81,.9);
    background:#020617;color:#e5e7eb;
    padding:.25rem .7rem;font-size:12px;
  }
  .mod-tools{display:flex;align-items:center;gap:.3rem;}
  .mod-detail{display:none;margin:6px 6px 8px;}
  .mod-detail textarea{
    width:100%;min-height:60px;border-radius:12px;
    border:1px solid rgba(55,65,81,.9);
    background:#020617;color:#e5e7eb;font-size:12px;
    padding:.4rem .55rem;
  }

  /* ===== Steps 3 por fila ===== */
  .steps{position:relative;margin-top:4px;}
  .steps-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:16px 18px;
    align-items:start;
  }
  @media(max-width:1180px){.steps-grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
  @media(max-width:860px){.steps-grid{grid-template-columns:1fr;}}

  .step-wrap{position:relative;}

  .step{
    position:relative;
    background:var(--stepBg);
    border-radius:18px;
    padding:9px 34px 10px 16px;
    min-height:70px;
    box-shadow:0 3px 0 rgba(148,163,184,.4),0 8px 16px rgba(15,23,42,.12);
    border:1px solid rgba(209,213,219,.9);
    display:flex;flex-direction:column;overflow:hidden;
  }
  .step::before{
    content:"";
    position:absolute;inset:0 auto 0 0;width:6px;
    background:var(--stepSide);
  }
  .step::after{
    content:"‚ûú";
    position:absolute;
    right:10px;
    top:50%;
    transform:translateY(-50%);
    font-size:16px;
    color:#9ca3af;
    opacity:.9;
  }

  .bubble{
    min-width:22px;height:22px;border-radius:999px;
    background:linear-gradient(90deg,#e5e7eb,#d1d5db);
    color:#020617;display:inline-flex;align-items:center;justify-content:center;
    font-size:11px;font-weight:900;box-shadow:0 1px 0 rgba(148,163,184,.6);margin-bottom:4px;
  }
  .step-title{
    border:0;outline:0;background:transparent;
    font-weight:800;font-size:13px;line-height:1.25;
    color:#020617;padding:0;white-space:normal;word-wrap:break-word;
  }
  .step-footer{
    margin-top:6px;display:flex;align-items:center;justify-content:flex-end;gap:.25rem;
  }
  .step-pencil{
    width:30px;height:30px;border-radius:999px;border:0;
    background:#020617;color:#e5e7eb;cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(148,163,184,.35),0 2px 0 rgba(15,23,42,1);
    font-size:15px;
  }
  .step-pencil:active{transform:translateY(1px);}
  .step-menu{
    position:absolute;right:10px;top:8px;
    display:flex;gap:.25rem;opacity:0;visibility:hidden;
    transition:opacity .15s;
  }
  .step-wrap:hover .step-menu{opacity:1;visibility:visible;}
  .step-menu button{
    width:26px;height:26px;border-radius:999px;border:0;
    background:#020617;color:#e5e7eb;cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(148,163,184,.35),0 2px 0 rgba(15,23,42,1);
    font-size:13px;
  }
  .step-menu button:active{transform:translateY(1px);}
  .meta-badge{
    position:absolute;right:10px;bottom:8px;
    padding:2px 8px;border-radius:999px;
    background:#020617;color:#facc15;font-size:11px;font-weight:800;
    display:flex;align-items:center;gap:.25rem;
    box-shadow:0 2px 4px rgba(15,23,42,.9);
  }

  /* ver m√°s */
  .more-tag{
    display:inline-flex;align-items:center;gap:.25rem;
    padding:2px 8px;border-radius:999px;
    background:#e5e7eb;color:#111827;font-size:11px;
    font-weight:800;margin-top:3px;cursor:pointer;
    box-shadow:0 2px 3px rgba(148,163,184,.7);
    align-self:flex-start;
  }
  .more-tag span.hand{font-size:12px;}

  /* Branch SI/NO */
  .branches{
    margin-top:5px;border-radius:14px;
    border:1px dashed rgba(148,163,184,.9);
    background:#f9fafb;padding:6px 8px 7px;
    box-shadow:0 4px 10px rgba(15,23,42,.2);
  }
  .branches.compact{display:none;}
  .branch-row{display:flex;align-items:flex-start;gap:6px;margin-bottom:4px;}
  .branch-label{
    min-width:34px;font-size:11px;font-weight:900;
    padding:2px 6px;border-radius:999px;text-align:center;color:#020617;
  }
  .branch-label.yes{background:#bbf7d0;}
  .branch-label.no{background:#fed7aa;}
  .branch-body{flex:1;display:flex;align-items:center;gap:4px;}
  .branch-text{
    flex:1;border-radius:999px;
    border:1px solid rgba(148,163,184,.85);
    padding:3px 8px;font-size:12px;
  }
  .branch-tools{display:flex;align-items:center;gap:4px;}
  .branch-tools button{
    width:22px;height:22px;border-radius:999px;border:0;
    background:#e5e7eb;color:#111827;font-size:12px;cursor:pointer;
  }
  .branch-chip{
    display:inline-flex;align-items:center;gap:4px;
    padding:2px 8px;border-radius:999px;
    background:#fee2e2;color:#b91c1c;font-size:11px;margin-top:4px;
  }

  /* Flechas de flujo */
  .flow-svg{
    position:absolute;inset:0;pointer-events:none;z-index:0;
  }

  /* Subproceso enlace punteado */
  .sub-link-line{
    position:absolute;border:1px dashed rgba(248,250,252,.7);border-right:none;
  }

  /* Toast */
  .pa-toast{
    position:fixed;right:14px;bottom:16px;
    background:#020617;color:#f9fafb;
    padding:.55rem .8rem;border-radius:10px;
    box-shadow:0 8px 20px rgba(0,0,0,.9);
    font-size:13px;opacity:0;transform:translateY(6px);
    pointer-events:none;transition:all .2s;z-index:80;
  }
  .pa-toast.show{opacity:1;transform:translateY(0);}

  /* PIN lectura */
  body.pa-locked .lock-target{pointer-events:none;opacity:.7;}

</style>
</head>
<body>
<div class="topbar">
  <div class="logo"><span class="ear">üéß</span><span>PROCESOS AUDIO</span></div>

  <div class="search">
    <span>üîç</span>
    <input id="q" placeholder="Buscar departamento, proceso, subproceso, pasos‚Ä¶">
  </div>

  <div class="dept-wrap">
    <select id="deptSelect" class="dept-select"></select>
    <button id="btnNewDept" class="btn3d"><span class="icon">üè¢</span><span>Nuevo departamento</span></button>
  </div>

  <button id="btnPin" class="btn3d"><span class="icon">üîí</span><span>PIN</span></button>
  <button id="btnPdf" class="btn3d"><span class="icon">üìÑ</span><span>PDF</span></button>
  <button id="btnHtml" class="btn3d"><span class="icon">‚¨áÔ∏è</span><span>HTML</span></button>
  <button id="btnCloudSave" class="btn3d"><span class="icon">‚òÅÔ∏è</span><span>Nube</span></button>

  <div class="top-right">
    <span id="stamp" class="stamp">‚Äî</span>
    <button id="btnGlobalSave" class="btn3d btn3d-ghost"><span class="icon">üíæ</span><span>Guardar todo</span></button>
  </div>
</div>

<div class="layout">
  <aside class="left">
    <div id="departmentsLeft"></div>
  </aside>
  <main class="right">
    <div class="board-head">
      <div class="board-title">
        <div>
          <strong id="boardTitle">‚Äî</strong>
          <div><small id="boardDeptLabel">Audiolog√≠a</small></div>
        </div>
      </div>
      <div class="board-head-controls">
        <button id="btnAddSubprocPaso" class="pill-black lock-target">+ Sub/subproceso</button>
        <button id="btnAddStepGlobal" class="pill-black lock-target">+ Paso</button>
        <button id="btnProcessSave" class="pill-black lock-target">üíæ Guardar proceso</button>
      </div>
    </div>

    <section id="modules" class="modules"></section>
  </main>
</div>

<div id="toast" class="pa-toast"></div>

<script>
/* ========= Estado / utilidades ========= */
const LSKEY='pa_v5_dept_3d';
const RESPONSABLES=['Audi√≥logo','Responsable','Otros'];
const colors=['#fde68a','#bfdbfe','#bbf7d0','#fecaca','#e9d5ff','#a5b4fc','#fed7aa','#fbcfe8','#cf9fff'];
const uid=()=> 'p'+Math.random().toString(36).slice(2,11);
const stamp=()=>{
  const d=new Date(),p=n=>String(n).padStart(2,'0');
  return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}, ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
};
const toast=(m)=>{
  const t=document.getElementById('toast');
  t.textContent=m;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
};

let state={departments:[],activeDeptId:null,activePid:null};

function makeEmptyStep(){
  return {id:uid(),title:'Nuevo paso',detail:'',yes:{text:'',pid:null},no:{text:'',pid:null},hasBranches:false,_open:false,isMeta:false,link:null,fileName:null};
}
function makeEmptyModule(){
  return {id:uid(),title:'Nuevo subproceso',responsable:RESPONSABLES[0],detail:'',steps:[makeEmptyStep()],parentId:null,_openDetail:false};
}
function makeEmptyProcess(name,color){
  return {id:uid(),name:name||'Nuevo proceso',color:color||colors[0],detail:'',modules:[makeEmptyModule()]};
}
function makeEmptyDepartment(name){
  return {id:uid(),name:name||'Audiolog√≠a',processes:[]};
}

/* ===== Persistencia ===== */
function migrateIfNeeded(raw){
  if(raw.departments) return raw;
  if(raw.processes){
    const d=makeEmptyDepartment('Audiolog√≠a');
    d.processes=raw.processes;
    return {departments:[d],activeDeptId:d.id,activePid:d.processes[0]?.id||null};
  }
  return raw;
}
function internalSave(){
  localStorage.setItem(LSKEY,JSON.stringify(state));
  document.getElementById('stamp').textContent='√öltima actualizaci√≥n '+stamp();
}
function load(){
  const raw=localStorage.getItem(LSKEY);
  if(raw){
    try{state=migrateIfNeeded(JSON.parse(raw));}
    catch(e){console.error(e);}
  }
  if(!state.departments || !state.departments.length){
    const d=makeEmptyDepartment('Audiolog√≠a');
    d.processes.push(makeEmptyProcess('Revisi√≥n auditiva',colors[0]));
    state.departments=[d];
  }
  if(!state.activeDeptId) state.activeDeptId=state.departments[0].id;
  const d=getActiveDept();
  if(!state.activePid && d.processes[0]) state.activePid=d.processes[0].id;
}
function getActiveDept(){
  return state.departments.find(d=>d.id===state.activeDeptId) || state.departments[0];
}
function getActiveProcess(){
  const d=getActiveDept();if(!d) return null;
  return d.processes.find(p=>p.id===state.activePid) || d.processes[0] || null;
}

/* ===== Render departamentos + procesos izquierda ===== */
function renderDeptSelector(){
  const sel=document.getElementById('deptSelect');
  sel.innerHTML='';
  state.departments.forEach(d=>{
    const opt=document.createElement('option');
    opt.value=d.id;opt.textContent=d.name;
    sel.appendChild(opt);
  });
  if(state.activeDeptId) sel.value=state.activeDeptId;
}
function renderLeft(){
  const box=document.getElementById('departmentsLeft');
  box.innerHTML='';
  state.departments.forEach(dept=>{
    const blk=document.createElement('div');
    blk.className='dept-block';

    const head=document.createElement('div');
    head.className='dept-head';
    const title=document.createElement('div');
    title.className='dept-title';
    title.textContent=dept.name;
    title.onclick=()=>{
      state.activeDeptId=dept.id;
      state.activePid=dept.processes[0]?.id||null;
      internalSave();renderAll();
    };
    title.ondblclick=()=>{
      const nn=prompt('Nombre del departamento',dept.name);
      if(nn){dept.name=nn.trim()||dept.name;internalSave();renderAll();}
    };
    const tag=document.createElement('button');
    tag.className='dept-tag lock-target';
    tag.textContent='Procesos ('+dept.processes.length+')  +';
    tag.onclick=()=>{
      const color=colors[dept.processes.length%colors.length];
      const p=makeEmptyProcess('Nuevo proceso',color);
      dept.processes.push(p);
      state.activeDeptId=dept.id;state.activePid=p.id;
      internalSave();renderAll();
    };
    head.appendChild(title);head.appendChild(tag);
    blk.appendChild(head);

    const plist=document.createElement('div');
    plist.className='proc-list';

    dept.processes.forEach(p=>{
      const item=document.createElement('div');
      item.className='proc-item'+(state.activePid===p.id && state.activeDeptId===dept.id?' active':'');

      const main=document.createElement('div');
      main.className='proc-main';
      const dot=document.createElement('span');
      dot.className='dot';dot.style.background=p.color||colors[0];
      const name=document.createElement('div');
      name.className='proc-name';
      name.textContent=p.name;
      const acts=document.createElement('div');
      acts.className='proc-actions';

      const bSave=document.createElement('button');
      bSave.className='icon-btn lock-target';bSave.textContent='üíæ';
      bSave.title='Guardar proceso';
      bSave.onclick=(e)=>{e.stopPropagation();internalSave();toast('Proceso guardado');};

      const bDet=document.createElement('button');
      bDet.className='icon-btn lock-target';bDet.textContent='‚úé';
      bDet.onclick=(e)=>{e.stopPropagation();p._openDetail=!p._openDetail;internalSave();renderAll();};

      const bDel=document.createElement('button');
      bDel.className='icon-btn lock-target';bDel.textContent='üóë';
      bDel.onclick=(e)=>{
        e.stopPropagation();
        if(!confirm('¬øEliminar proceso y todos sus subprocesos y pasos?'))return;
        const idx=dept.processes.findIndex(x=>x.id===p.id);
        if(idx>-1) dept.processes.splice(idx,1);
        if(state.activePid===p.id) state.activePid=dept.processes[0]?.id||null;
        internalSave();renderAll();
      };

      acts.appendChild(bSave);acts.appendChild(bDet);acts.appendChild(bDel);

      main.onclick=()=>{
        state.activeDeptId=dept.id;state.activePid=p.id;
        internalSave();renderAll();
      };

      main.appendChild(dot);main.appendChild(name);main.appendChild(acts);
      item.appendChild(main);

      const det=document.createElement('div');
      det.className='proc-detail';
      if(p._openDetail) det.style.display='block';
      const ta=document.createElement('textarea');
      ta.value=p.detail||'';
      ta.oninput=e=>{p.detail=e.target.value;};
      ta.onblur=()=>internalSave();
      det.appendChild(ta);
      item.appendChild(det);

      plist.appendChild(item);
    });

    blk.appendChild(plist);
    box.appendChild(blk);
  });
}

/* ===== Branch SI/NO ===== */
function stepHasExtra(st){
  return (st.detail && st.detail.trim()) ||
         (st.hasBranches && ((st.yes?.text||'').trim() || (st.no?.text||'').trim())) ||
         st.link || st.fileName;
}
function renderBranches(st,step){
  const branches=document.createElement('div');
  branches.className='branches lock-target';
  if(!st.hasBranches) branches.style.display='none';

  const yesRow=document.createElement('div');
  yesRow.className='branch-row';
  const yesLabel=document.createElement('div');
  yesLabel.className='branch-label yes';
  yesLabel.textContent='S√ç';
  const yesBody=document.createElement('div');
  yesBody.className='branch-body';
  const yesInput=document.createElement('input');
  yesInput.className='branch-text';
  yesInput.placeholder='Texto para S√ç‚Ä¶';
  yesInput.value=st.yes?.text||'';
  yesInput.oninput=e=>{st.yes=st.yes||{};st.yes.text=e.target.value;};
  yesInput.onblur=()=>internalSave();
  const yesTools=document.createElement('div');
  yesTools.className='branch-tools';
  const yesLink=document.createElement('button');
  yesLink.textContent='üîó';
  yesLink.title='Ir a pr√≥ximo proceso (S√ç)';
  yesLink.onclick=()=>{
    const d=getActiveDept();
    const list=d.processes.map(pr=>`${pr.name} (${pr.id})`).join('\n');
    const pid=prompt('ID de proceso destino S√ç.\n\n'+list,st.yes?.pid||'');
    if(!pid)return;
    st.yes=st.yes||{};st.yes.pid=pid;internalSave();renderAll();
  };
  yesTools.appendChild(yesLink);
  yesBody.appendChild(yesInput);yesBody.appendChild(yesTools);
  yesRow.appendChild(yesLabel);yesRow.appendChild(yesBody);
  branches.appendChild(yesRow);

  const noRow=document.createElement('div');
  noRow.className='branch-row';
  const noLabel=document.createElement('div');
  noLabel.className='branch-label no';noLabel.textContent='NO';
  const noBody=document.createElement('div');
  noBody.className='branch-body';
  const noInput=document.createElement('input');
  noInput.className='branch-text';
  noInput.placeholder='Texto para NO‚Ä¶';
  noInput.value=st.no?.text||'';
  noInput.oninput=e=>{st.no=st.no||{};st.no.text=e.target.value;};
  noInput.onblur=()=>internalSave();
  const noTools=document.createElement('div');
  noTools.className='branch-tools';
  const noLink=document.createElement('button');
  noLink.textContent='üîó';
  noLink.title='Ir a pr√≥ximo proceso (NO)';
  noLink.onclick=()=>{
    const d=getActiveDept();
    const list=d.processes.map(pr=>`${pr.name} (${pr.id})`).join('\n');
    const pid=prompt('ID de proceso destino NO.\n\n'+list,st.no?.pid||'');
    if(!pid)return;
    st.no=st.no||{};st.no.pid=pid;internalSave();renderAll();
  };
  noTools.appendChild(noLink);
  noBody.appendChild(noInput);noBody.appendChild(noTools);
  noRow.appendChild(noLabel);noRow.appendChild(noBody);
  branches.appendChild(noRow);

  if(st.yes?.pid || st.no?.pid){
    const chip=document.createElement('div');
    chip.className='branch-chip';
    chip.textContent='‚û° Pr√≥ximo proceso';
    branches.appendChild(chip);
  }

  step.appendChild(branches);
  if(!st._open) branches.classList.add('compact');
}

/* ===== Steps & m√≥dulos ===== */
/* flechas: paso i ‚Üí paso i+1 en el subproceso */
function drawFlowForSteps(container){
  const wraps=Array.from(container.querySelectorAll('.step-wrap'));
  if(wraps.length<2) return;

  const rect=container.getBoundingClientRect();

  let svg=container.querySelector('svg.flow-svg');
  if(svg) svg.remove();

  svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.classList.add('flow-svg');
  svg.setAttribute('width',rect.width);
  svg.setAttribute('height',rect.height);
  svg.setAttribute('viewBox','0 0 '+rect.width+' '+rect.height);

  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  const marker=document.createElementNS('http://www.w3.org/2000/svg','marker');
  marker.setAttribute('id','arrow');
  marker.setAttribute('viewBox','0 0 10 10');
  marker.setAttribute('refX','10');
  marker.setAttribute('refY','5');
  marker.setAttribute('markerWidth','6');
  marker.setAttribute('markerHeight','6');
  marker.setAttribute('orient','auto');
  const arrowPath=document.createElementNS('http://www.w3.org/2000/svg','path');
  arrowPath.setAttribute('d','M 0 0 L 10 5 L 0 10 z');
  arrowPath.setAttribute('fill','#9ca3af');
  marker.appendChild(arrowPath);
  defs.appendChild(marker);
  svg.appendChild(defs);

  for(let i=0;i<wraps.length-1;i++){
    const r1=wraps[i].getBoundingClientRect();
    const r2=wraps[i+1].getBoundingClientRect();
    const x1=r1.right-rect.left;
    const y1=r1.top+r1.height/2-rect.top;
    const x2=r2.left-rect.left;
    const y2=r2.top+r2.height/2-rect.top;
    const cx1=x1+40;
    const cx2=x2-40;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d','M '+x1+' '+y1+' C '+cx1+' '+y1+', '+cx2+' '+y2+', '+x2+' '+y2);
    path.setAttribute('stroke','#9ca3af');
    path.setAttribute('stroke-width','2');
    path.setAttribute('fill','none');
    path.setAttribute('marker-end','url(#arrow)');
    svg.appendChild(path);
  }

  container.appendChild(svg);
}

function renderStepsForModule(m,p,container){
  const grid=document.createElement('div');
  grid.className='steps-grid';

  m.steps.forEach((st,idx)=>{
    const wrap=document.createElement('div');
    wrap.className='step-wrap';

    const step=document.createElement('div');
    step.className='step lock-target';
    step.style.setProperty('--stepSide',p.color||colors[0]);

    const b=document.createElement('div');
    b.className='bubble';b.textContent=idx+1;
    step.appendChild(b);

    const title=document.createElement('textarea');
    title.className='step-title';
    title.value=st.title||'Nuevo paso';
    title.oninput=e=>{st.title=e.target.value;};
    title.onblur=()=>internalSave();
    step.appendChild(title);

    if(st.isMeta){
      const meta=document.createElement('div');
      meta.className='meta-badge';
      meta.textContent='üéØ META';
      step.appendChild(meta);
    }

    const menu=document.createElement('div');
    menu.className='step-menu';

    const btnPlay=document.createElement('button');
    btnPlay.textContent='‚ñ∂';btnPlay.title='Narrar paso';
    btnPlay.onclick=e=>{e.stopPropagation();toast('Narraci√≥n (futuro avatar)');};

    const btnHelp=document.createElement('button');
    btnHelp.textContent='?';btnHelp.title='Opciones S√ç / NO';
    btnHelp.onclick=e=>{
      e.stopPropagation();
      st.hasBranches=!st.hasBranches;
      if(!st.hasBranches){
        st.yes={text:'',pid:null};
        st.no={text:'',pid:null};
        st._open=false;
      }
      internalSave();renderAll();
    };

    const btnLink=document.createElement('button');
    btnLink.textContent='üîó';btnLink.title='Adjuntar enlace';
    btnLink.onclick=e=>{
      e.stopPropagation();
      const url=prompt('Enlace asociado a este paso',st.link||'');
      if(url!==null){st.link=url.trim()||null;internalSave();renderAll();}
    };

    const btnDoc=document.createElement('button');
    btnDoc.textContent='üìÑ';btnDoc.title='Adjuntar documento';
    btnDoc.onclick=e=>{
      e.stopPropagation();
      const input=document.createElement('input');
      input.type='file';
      input.onchange=()=>{
        const file=input.files[0];
        if(file){st.fileName=file.name;internalSave();renderAll();}
      };
      input.click();
    };

    const btnDel=document.createElement('button');
    btnDel.textContent='üóë';btnDel.title='Eliminar paso';
    btnDel.onclick=e=>{
      e.stopPropagation();
      if(!confirm('¬øEliminar SOLO este paso?'))return;
      const i=m.steps.findIndex(x=>x.id===st.id);
      if(i>-1){m.steps.splice(i,1);internalSave();renderAll();}
    };

    menu.appendChild(btnPlay);
    menu.appendChild(btnHelp);
    menu.appendChild(btnLink);
    menu.appendChild(btnDoc);
    menu.appendChild(btnDel);
    step.appendChild(menu);

    if(stepHasExtra(st)){
      const more=document.createElement('div');
      more.className='more-tag lock-target';
      more.innerHTML='<strong>ver m√°s</strong> <span class="hand">üëá</span>';
      more.onclick=()=>{
        st._open=!st._open;internalSave();renderAll();
      };
      step.appendChild(more);
    }

    if(st._open){
      const det=document.createElement('textarea');
      det.className='step-title';
      det.style.fontWeight='600';
      det.style.fontSize='12px';
      det.style.minHeight='44px';
      det.placeholder='Detalle del paso‚Ä¶';
      det.value=st.detail||'';
      det.oninput=e=>{st.detail=e.target.value;};
      det.onblur=()=>internalSave();
      step.appendChild(det);
    }

    renderBranches(st,step);

    if(st.fileName){
      const chip=document.createElement('div');
      chip.className='branch-chip';
      chip.textContent='üìÑ '+st.fileName;
      step.appendChild(chip);
    }

    const footer=document.createElement('div');
    footer.className='step-footer';
    const pencil=document.createElement('button');
    pencil.className='step-pencil';
    pencil.textContent='‚úèÔ∏è';
    pencil.onclick=()=>{
      st._open=!st._open;
      internalSave();renderAll();
    };
    footer.appendChild(pencil);
    step.appendChild(footer);

    wrap.appendChild(step);
    grid.appendChild(wrap);
  });

  container.appendChild(grid);
  if(typeof requestAnimationFrame!=='undefined'){
    requestAnimationFrame(function(){drawFlowForSteps(container);});
  }else{
    setTimeout(function(){drawFlowForSteps(container);},0);
  }
}

function deleteModuleCascade(p,mId){
  // misma l√≥gica de antes: borrar el subproceso, no todo el proceso
  const idx=p.modules.findIndex(m=>m.id===mId);
  if(idx===-1)return;
  const parentId=p.modules[idx].parentId||null;
  // reenganchar hijos directos al padre
  p.modules.forEach(mod=>{
    if(mod.parentId===mId) mod.parentId=parentId;
  });
  p.modules.splice(idx,1);
}

function renderModule(p,m,parent){
  const card=document.createElement('div');
  card.className='module';
  if(m.parentId) card.classList.add('sub-child');

  const head=document.createElement('div');
  head.className='mod-head';

  const title=document.createElement('input');
  title.className='mod-title lock-target';
  title.value=m.title||'Nuevo subproceso';
  title.oninput=e=>{m.title=e.target.value;};
  title.onblur=()=>internalSave();

  const sel=document.createElement('select');
  sel.className='mod-select lock-target';
  RESPONSABLES.forEach(r=>{
    const o=document.createElement('option');
    o.value=r;o.textContent=r;
    if(m.responsable===r)o.selected=true;
    sel.appendChild(o);
  });
  sel.onchange=e=>{
    m.responsable=e.target.value;
    if(m.responsable==='Otros'){
      const n=prompt('Nombre de esa persona','');
      if(n)m.responsable='Otros: '+n;
    }
    internalSave();renderAll();
  };

  const tools=document.createElement('div');
  tools.className='mod-tools';
  const bDet=document.createElement('button');
  bDet.className='pill-black lock-target';
  bDet.textContent='Detalle';
  bDet.onclick=()=>{m._openDetail=!m._openDetail;internalSave();renderAll();};

  const bStep=document.createElement('button');
  bStep.className='pill-black lock-target';
  bStep.textContent='+ Paso';
  bStep.onclick=()=>{m.steps.push(makeEmptyStep());internalSave();renderAll();};

  const bSub=document.createElement('button');
  bSub.className='pill-black lock-target';
  bSub.textContent='+ Sub/subproceso';
  bSub.onclick=()=>{
    const pAct=getActiveProcess();if(!pAct)return;
    const child=makeEmptyModule();
    child.title=m.title+' - Sub';
    child.parentId=m.id;
    pAct.modules.push(child);
    internalSave();renderAll();
  };

  const bSave=document.createElement('button');
  bSave.className='pill-black lock-target';
  bSave.textContent='üíæ';
  bSave.onclick=()=>{internalSave();toast('Subproceso guardado');};

  const bDel=document.createElement('button');
  bDel.className='pill-black lock-target';
  bDel.textContent='‚Äì';
  bDel.onclick=()=>{
    if(!confirm('¬øEliminar este subproceso y sus pasos? El resto del proceso no se borrar√°.'))return;
    const pAct=getActiveProcess();if(!pAct)return;
    deleteModuleCascade(pAct,m.id);
    internalSave();renderAll();
  };

  tools.appendChild(bDet);tools.appendChild(bStep);tools.appendChild(bSub);tools.appendChild(bSave);tools.appendChild(bDel);

  head.appendChild(title);head.appendChild(sel);head.appendChild(tools);
  card.appendChild(head);

  const det=document.createElement('div');
  det.className='mod-detail';
  if(m._openDetail) det.style.display='block';
  const ta=document.createElement('textarea');
  ta.value=m.detail||'';
  ta.oninput=e=>{m.detail=e.target.value;};
  ta.onblur=()=>internalSave();
  det.appendChild(ta);
  card.appendChild(det);

  const stepsBox=document.createElement('div');
  stepsBox.className='steps';
  renderStepsForModule(m,p,stepsBox);
  card.appendChild(stepsBox);

  parent.appendChild(card);
}

function renderRight(){
  const mods=document.getElementById('modules');
  mods.innerHTML='';
  const p=getActiveProcess();const dept=getActiveDept();
  document.getElementById('boardTitle').textContent=p?`${p.name} - Pasos`:'Sin proceso';
  document.getElementById('boardDeptLabel').textContent=dept?dept.name:'‚Äî';
  const bt=document.querySelector('.board-title');
  if(bt){
    bt.style.borderBottom = p ? ('3px solid ' + (p.color||colors[0])) : 'none';
  }
  if(!p)return;

  p.modules.filter(m=>!m.parentId).forEach(m=>{
    renderModule(p,m,mods);
    p.modules.filter(ch=>ch.parentId===m.id).forEach(ch=>{
      renderModule(p,ch,mods);
    });
  });
}

/* ===== Render maestro ===== */
function renderAll(){
  renderDeptSelector();
  renderLeft();
  renderRight();
}

/* ===== Acciones globales ===== */
document.getElementById('btnAddStepGlobal').onclick=()=>{
  const p=getActiveProcess();if(!p)return;
  let m=p.modules.find(x=>!x.parentId) || p.modules[0];
  if(!m){m=makeEmptyModule();p.modules.push(m);}
  m.steps.push(makeEmptyStep());
  internalSave();renderAll();
};
document.getElementById('btnAddSubprocPaso').onclick=()=>{
  const p=getActiveProcess();if(!p)return;
  const m=makeEmptyModule();
  p.modules.push(m);
  internalSave();renderAll();
};
document.getElementById('btnProcessSave').onclick=()=>{internalSave();toast('Proceso guardado');};
document.getElementById('btnGlobalSave').onclick=()=>{internalSave();toast('Todo guardado');};

document.getElementById('btnNewDept').onclick=()=>{
  const name=prompt('Nombre del nuevo departamento','Nuevo departamento');
  const d=makeEmptyDepartment(name||'Nuevo departamento');
  state.departments.push(d);
  state.activeDeptId=d.id;state.activePid=null;
  internalSave();renderAll();
};
document.getElementById('deptSelect').onchange=e=>{
  state.activeDeptId=e.target.value;
  const d=getActiveDept();
  state.activePid=d.processes[0]?.id||null;
  internalSave();renderAll();
};

/* Buscador global sencillo */
document.getElementById('q').addEventListener('input',(e)=>{
  const q=e.target.value.trim().toLowerCase();
  if(!q){
    renderAll();
    return;
  }

  let found=null;

  for(const dept of state.departments){
    for(const p of (dept.processes || [])){
      const matches =
        (p.name||'').toLowerCase().includes(q) ||
        (p.detail||'').toLowerCase().includes(q) ||
        (p.modules||[]).some(m=>
          (m.title||'').toLowerCase().includes(q) ||
          (m.steps||[]).some(st=>
            (st.title||'').toLowerCase().includes(q) ||
            (st.detail||'').toLowerCase().includes(q)
          )
        );
      if(matches){
        found={deptId:dept.id,pid:p.id};
        break;
      }
    }
    if(found) break;
  }

  if(found){
    state.activeDeptId=found.deptId;
    state.activePid=found.pid;
    internalSave();
    renderAll();
  }
});

/* PIN lectura */
document.getElementById('btnPin').onclick=()=>{
  const locked=document.body.classList.toggle('pa-locked');
  toast(locked?'Modo lectura: no editable':'Edici√≥n habilitada');
};

/* PDF / HTML / Nube */
document.getElementById('btnPdf').onclick=()=>window.print();
document.getElementById('btnHtml').onclick=()=>{
  const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='PROCESOS-AUDIO.html';
  a.click();
  URL.revokeObjectURL(a.href);
};
document.getElementById('btnCloudSave').onclick=()=>{
  try{
    localStorage.setItem(LSKEY+'_SNAP',JSON.stringify(state));
    toast('Copia guardada en nube local');
  }catch(e){toast('No se pudo guardar');}
};

/* ===== Inicio ===== */
load();
document.getElementById('stamp').textContent='√öltima actualizaci√≥n '+stamp();
renderAll();
</script>
</body>
</html>
