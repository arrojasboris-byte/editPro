<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PROCESOS AUDIO</title>
<style>
:root{
  --hdr-a:#9a3a3a;--hdr-b:#5f5b5b;
  --ink:#1a1a1a;--mut:#6b7280;--ok:#0ea5e9;--warn:#ef4444;--yes:#16a34a;
  --chip:#eef2ff;--chip-ink:#3730a3;
  --card:#f7f7f9;--panel:#f2f3f5;--ring:#e5e7eb;--shadow:0 6px 18px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:#ececef;color:var(--ink);font:14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
button{cursor:pointer}
.icon{width:18px;height:18px;display:inline-grid;place-items:center;border-radius:10px;background:#fff;border:1px solid var(--ring);box-shadow:var(--shadow)}
.icon.flat{background:transparent;border-color:transparent}
.icon.warn{color:#fff;background:var(--warn);border-color:#c62e2e}
.icon.ok{color:#fff;background:var(--ok);border-color:#0b8ec7}
.icon.gray{background:#f4f5f7;color:#555;border-color:#e5e7eb}
header{
  position:sticky;top:0;z-index:20;color:#fff;
  background:linear-gradient(90deg,var(--hdr-b) 0%,var(--hdr-a) 35%,var(--hdr-b) 100%);
  box-shadow:0 4px 14px rgba(0,0,0,.16)
}
.hrow{display:flex;gap:10px;align-items:center;padding:10px}
.hrow h1{display:flex;align-items:center;gap:10px;margin:0;font-size:22px;letter-spacing:.5px}
.hrow h1 .ear{width:22px;height:22px;display:inline-grid;place-items:center;background:#fff;color:#111;border-radius:50%}
.hrow input[type="search"]{flex:1;min-width:140px;border:0;border-radius:14px;padding:10px 14px;background:rgba(255,255,255,.25);color:#fff;outline:2px solid transparent}
.hrow input::placeholder{color:#fff}
.hgrp{display:flex;gap:8px;align-items:center}
.btn{border:0;border-radius:999px;padding:8px 14px;background:rgba(255,255,255,.15);color:#fff;box-shadow:var(--shadow)}
.btn.solid{background:#fff;color:#111}
main{display:grid;grid-template-columns:1fr 2fr;gap:10px;padding:10px}
@media(max-width:1100px){main{grid-template-columns:1fr}}
.left,.right{background:var(--panel);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;min-height:60vh}
.leftHdr{display:flex;align-items:center;gap:10px;padding:10px;background:linear-gradient(90deg,var(--hdr-b),var(--hdr-a));color:#fff}
.leftHdr .btnAdd{margin-left:auto}
.procList{padding:10px;display:flex;flex-direction:column;gap:10px}
.procCard{
  border-radius:14px;background:#fff;border:1px solid var(--ring);box-shadow:var(--shadow);
  padding:10px;display:grid;grid-template-columns:1fr auto;gap:6px;position:relative
}
.procCard .titleRow{display:flex;align-items:center;gap:8px}
.procCard .badge{width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.05)}
.procCard .title{flex:1;font-weight:700}
.procCard .actions{display:flex;gap:6px}
.procCard .details{grid-column:1 / -1}
.procCard textarea{width:100%;min-height:100px;border:1px solid var(--ring);border-radius:10px;padding:10px;background:#f8f9fb}
.procCard.dragging{opacity:.6}
.rightHdr{display:flex;gap:8px;align-items:center;padding:10px;background:linear-gradient(90deg,var(--hdr-b),var(--hdr-a));color:#fff}
.rightHdr .last{margin-left:auto;font-size:12px;opacity:.9}
.section{padding:12px;display:flex;flex-direction:column;gap:12px}
.subCard{
  background:linear-gradient(180deg,#444,#6a6a6a);color:#fff;border-radius:12px;padding:10px 12px;box-shadow:var(--shadow)
}
.subCard .row{display:flex;align-items:center;gap:8px}
.subCard .name{font-weight:700}
.subCard .sDetails{margin-top:8px;background:rgba(0,0,0,.18);border-radius:10px;padding:8px;display:none}
.subCard textarea{width:100%;min-height:80px;border:0;border-radius:8px;padding:8px;background:#1f1f1f;color:#fff}
.step{
  position:relative;background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:12px 12px 10px 52px;box-shadow:var(--shadow)
}
.step .bubble{
  position:absolute;left:10px;top:12px;width:28px;height:28px;border-radius:50%;
  background:#fff;border:2px solid #000;display:grid;place-items:center;font-weight:800;font-size:12px;z-index:2
}
.step .vline{
  position:absolute;left:24px;top:32px;width:4px;bottom:8px;border-radius:4px;background:#bbb;z-index:1
}
.step .head{display:flex;gap:6px;align-items:center}
.step .title{font-weight:700;flex:1}
.step .dWrap{margin-top:8px}
.step .dWrap textarea{width:100%;min-height:90px;border:1px solid var(--ring);border-radius:10px;padding:8px;background:#fff}
.attachRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
.chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--chip-ink);border:1px solid #dfe3ff;border-radius:999px;padding:6px 10px}
.sino{margin-top:10px;border-top:1px dashed #d7d9de;padding-top:10px}
.sino .hdr{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.badgeNO{font-weight:900;color:#fff;background:#111;padding:4px 10px;border-radius:999px;font-size:12px}
.badgeSI{font-weight:900;color:#fff;background:#0b8ec7;padding:3px 9px;border-radius:999px;font-size:11px}
.points{display:flex;flex-direction:column;gap:6px;margin-left:6px}
.point{display:grid;grid-template-columns:auto 1fr auto;gap:6px;align-items:center;background:#fff;border:1px solid var(--ring);border-radius:10px;padding:6px}
.pnum{font-weight:700;font-size:12px;color:#666;padding:2px 6px;border-radius:6px;background:#f2f3f7}
.point input{width:100%;border:0;outline:none;padding:6px;border-radius:8px;background:#f8f9fb}
.flag{background:#fff;border:1px solid var(--ring);border-radius:8px;padding:4px 8px;display:flex;gap:6px;align-items:center}
.flag .swatch{width:10px;height:10px;border-radius:3px;border:1px solid rgba(0,0,0,.15)}
.flag strong{font-size:12px}
.saveEnd{margin-top:10px;display:flex;justify-content:flex-end}
.saveEnd .goal{display:inline-flex;gap:8px;align-items:center;background:#111;color:#fff;border-radius:999px;padding:8px 12px;box-shadow:var(--shadow)}
/* drag visual */
.drag-handle{cursor:grab}
.drag-over{outline:2px dashed #bbb}
</style>
</head>
<body>
<header>
  <div class="hrow">
    <h1><span class="ear">üéß</span> PROCESOS AUDIO</h1>
    <input id="q" type="search" placeholder="Buscar‚Ä¶"/>
    <div class="hgrp">
      <button class="btn solid" id="btnHtml">‚¨áÔ∏è HTML</button>
      <button class="btn" id="btnCloudSave" title="Guardar en nube local">‚òÅÔ∏è</button>
      <button class="btn" id="btnCloudLoad" title="Actualizar de nube local">üîÑ</button>
      <button class="btn" id="btnLock" title="Bloquear/Editar (PIN)">üîí</button>
      <button class="btn" id="btnSave" title="Guardar">üíæ Guardar</button>
    </div>
  </div>
</header>

<main>
  <section class="left">
    <div class="leftHdr">
      <button id="addProcess" class="btn solid">+Procesos</button>
    </div>
    <div class="procList" id="procList"></div>
  </section>

  <section class="right">
    <div class="rightHdr">
      <div id="selName">Selecciona un proceso‚Ä¶</div>
      <button id="addSub" class="btn">+ Subproceso</button>
      <button id="addStep" class="btn">+ Paso</button>
      <div class="last" id="lastUpd">√öltima actualizaci√≥n ‚Äî</div>
    </div>
    <div class="section" id="rightBody"></div>
  </section>
</main>

<!-- semilla de datos incrustada / se reemplaza al exportar -->
<script id="seed" type="application/json">{
  "processes":[
    {"id":"p1","name":"Revisi√≥n auditiva","desc":"Describe aqu√≠ el proceso...","color":"#f9d1d1","subprocs":[
      {"id":"s1","name":"Ayudas","desc":"","responsable":"Audi√≥logo","steps":[]}
    ]},
    {"id":"p2","name":"Producto","desc":"","color":"#d1f9e2","subprocs":[]}
  ],
  "last":"‚Äî",
  "locked":false
}</script>

<script>
/* ---------- Estado & Utilidades ---------- */
const $=sel=>document.querySelector(sel), $$=sel=>Array.from(document.querySelectorAll(sel));
const uid=()=>Math.random().toString(36).slice(2,9);
const PALETTE=['#ffe5e5','#fde2d3','#fff2cc','#e7f8d6','#d6f5f9','#e3e1ff','#f6dfff','#ffd6eb','#e6f0ff','#f2ffe6','#fff0e6','#efe6ff','#e6fff8','#f8e6ff'];
let state=loadState();
let selProcId=state.processes[0]?.id||null;

function loadState(){
  try{
    const local=localStorage.getItem('procesosAudio2');
    if(local){return JSON.parse(local)}
  }catch(e){}
  try{
    return JSON.parse($('#seed').textContent);
  }catch(e){ return {processes:[],last:'‚Äî',locked:false}; }
}
function saveState(){
  localStorage.setItem('procesosAudio2',JSON.stringify(state));
  state.last=new Date().toLocaleString();
  $('#lastUpd').textContent='√öltima actualizaci√≥n '+state.last;
}
function colorFor(i){
  const used=state.processes.map(p=>p.color);
  const palette=PALETTE.filter(c=>!used.includes(c));
  return palette[i%palette.length]||PALETTE[i%PALETTE.length];
}
function setLock(flag){
  state.locked=flag; saveState();
  document.body.classList.toggle('locked',flag);
  $('#btnLock').textContent=flag?'üîì':'üîí';
}

/* ---------- Render izquierda ---------- */
function renderLeft(){
  const list=$('#procList'); list.innerHTML='';
  const q=$('#q').value.trim().toLowerCase();
  state.processes.forEach((p,idx)=>{
    if(q && !p.name.toLowerCase().includes(q) && !p.desc.toLowerCase().includes(q)) return;
    const card=document.createElement('div'); card.className='procCard'; card.draggable=true; card.dataset.id=p.id;
    card.style.setProperty('--c',p.color);
    const titleRow=document.createElement('div'); titleRow.className='titleRow';
    const badge=document.createElement('span'); badge.className='badge'; badge.style.background=p.color;
    const title=document.createElement('div'); title.className='title drag-handle'; title.textContent=p.name;
    const actions=document.createElement('div'); actions.className='actions';
    const btnEdit=btn('‚úèÔ∏è','Editar','gray'); 
    const btnTgl=btn('‚ñæ','Detalle','gray'); 
    const btnDel=btn('üóëÔ∏è','Eliminar','flat'); btnDel.style.filter='none';
    actions.append(btnEdit,btnTgl,btnDel);
    titleRow.append(badge,title,actions);
    const details=document.createElement('div'); details.className='details'; details.style.display='none';
    const ta=document.createElement('textarea'); ta.placeholder='Descripci√≥n del proceso‚Ä¶'; ta.value=p.desc||'';
    details.append(ta);
    card.append(titleRow,details);
    if(selProcId===p.id) card.style.outline='2px solid #a3a3a3';
    // actions
    btnEdit.onclick=()=>{ const n=prompt('Nombre del proceso:',p.name); if(n){p.name=n; saveState(); renderAll()} };
    btnTgl.onclick=()=>{ details.style.display=details.style.display==='none'?'block':'none' };
    ta.oninput=()=>{ p.desc=ta.value; saveState() };
    btnDel.onclick=()=>{ if(confirm('¬øEliminar proceso?')){ 
      const i=state.processes.findIndex(x=>x.id===p.id); if(i>-1){ state.processes.splice(i,1); selProcId=state.processes[0]?.id||null; saveState(); renderAll(); }
    }};
    card.onclick=e=>{ if(e.target.closest('.actions'))return; selProcId=p.id; renderAll(); };
    // drag sort
    card.addEventListener('dragstart',e=>{ card.classList.add('dragging'); e.dataTransfer.setData('text/plain',p.id) });
    card.addEventListener('dragend',()=>card.classList.remove('dragging'));
    list.append(card);
    card.addEventListener('dragover',e=>{
      e.preventDefault(); const dragging=$('.procCard.dragging'); if(!dragging||dragging===card)return;
      const dragId=dragging.dataset.id;
      const overId=card.dataset.id;
      if(dragId===overId)return;
      list.insertBefore(dragging, card);
    });
    card.addEventListener('drop',()=>{
      const ids=$$('.procCard').map(c=>c.dataset.id);
      state.processes.sort((a,b)=>ids.indexOf(a.id)-ids.indexOf(b.id));
      saveState(); renderLeft();
    });
  });
}
function btn(txt,tip,cls=''){ const b=document.createElement('button'); b.className='icon '+cls; b.title=tip; b.textContent=txt; return b }

/* ---------- Render derecha ---------- */
function current(){ return state.processes.find(p=>p.id===selProcId)||null }
function renderRight(){
  const p=current(); const body=$('#rightBody'); body.innerHTML='';
  $('#selName').textContent=p? p.name : 'Selecciona un proceso‚Ä¶';
  if(!p){ return }
  // subprocesos
  p.subprocs.forEach((s,si)=>{
    const box=document.createElement('div'); box.style.background=p.color+'30'; box.style.border='1px solid #ddd'; box.style.borderRadius='12px';
    const sub=document.createElement('div'); sub.className='subCard';
    const row=document.createElement('div'); row.className='row';
    const name=document.createElement('div'); name.className='name'; name.textContent=s.name||'Sub-proceso';
    const eBtn=btn('‚úèÔ∏è','Editar','gray'); const tBtn=btn('‚ñæ','Detalle','gray');
    const resp=document.createElement('select'); ['Audi√≥logo','Responsable','Otros'].forEach(v=>{ const o=document.createElement('option');o.text=v;o.value=v; resp.append(o) });
    resp.value=s.responsable||'Audi√≥logo';
    row.append(name,eBtn,tBtn,resp);
    const sdet=document.createElement('div'); sdet.className='sDetails';
    const sta=document.createElement('textarea'); sta.placeholder='Descripci√≥n del sub-proceso‚Ä¶'; sta.value=s.desc||'';
    sdet.append(sta);
    sub.append(row,sdet);
    box.append(sub);
    // pasos
    s.steps.forEach((st,sti)=>{
      const step=renderStep(p,s,st,sti,si);
      box.append(step);
    });
    // a√±adir paso
    const addWrap=document.createElement('div'); addWrap.className='saveEnd';
    const add=document.createElement('button'); add.className='btn'; add.textContent='+ A√±adir paso'; 
    add.onclick=()=>{ s.steps.push(newStep()); saveState(); renderRight() }
    addWrap.append(add); box.append(addWrap);
    body.append(box);
    // actions sub
    eBtn.onclick=()=>{ const n=prompt('Nombre del sub-proceso:', s.name||'Sub-proceso'); if(n){ s.name=n; saveState(); renderRight() } };
    tBtn.onclick=()=>{ sdet.style.display=sdet.style.display==='none'?'block':'none' };
    sta.oninput=()=>{ s.desc=sta.value; saveState() };
    resp.onchange=()=>{ s.responsable=resp.value; saveState() };
  });
  alignConnectors();
}
function renderStep(proc,sub,st,sti,si){
  const step=document.createElement('div'); step.className='step'; step.style.setProperty('--pc',proc.color);
  const bubble=document.createElement('div'); bubble.className='bubble'; bubble.textContent=(sti+1);
  const vline=document.createElement('div'); vline.className='vline'; vline.style.background=proc.color;
  const head=document.createElement('div'); head.className='head';
  const title=document.createElement('div'); title.className='title'; title.textContent=st.title||'Paso';
  const edit=btn('‚úèÔ∏è','Editar','gray'); const toggle=btn('‚ñæ','Desplegar','gray'); const help=btn('‚ùì','Ayuda','gray');
  const resp=document.createElement('select'); ['Audi√≥logo','Responsable','Otros'].forEach(v=>{ const o=document.createElement('option');o.text=v;o.value=v; resp.append(o) }); resp.value=st.responsable||'Audi√≥logo';
  head.append(title,edit,toggle,help,resp);
  const dWrap=document.createElement('div'); dWrap.className='dWrap'; dWrap.style.display='none';
  const dta=document.createElement('textarea'); dta.placeholder='Detalle del paso‚Ä¶'; dta.value=st.desc||'';
  dWrap.append(dta);
  // Si/No bloque (va DESPU√âS del detalle)
  const sino=document.createElement('div'); sino.className='sino';
  // NO
  const hdrNo=document.createElement('div'); hdrNo.className='hdr';
  const bNo=document.createElement('span'); bNo.className='badgeNO'; bNo.textContent='NO';
  const plusNo=btn('+','A√±adir punto NO','gray');
  hdrNo.append(bNo,plusNo);
  const pointsNo=document.createElement('div'); pointsNo.className='points';
  // SI
  const hdrSi=document.createElement('div'); hdrSi.className='hdr';
  const bSi=document.createElement('span'); bSi.className='badgeSI'; bSi.textContent='S√ç';
  const plusSi=btn('+','A√±adir punto S√ç','gray');
  hdrSi.append(bSi,plusSi);
  const pointsSi=document.createElement('div'); pointsSi.className='points';
  sino.append(hdrNo,pointsNo,hdrSi,pointsSi);
  // Adjuntos visibles
  const attachRow=document.createElement('div'); attachRow.className='attachRow';
  const addLinkChip=()=>{ if(st.link){ const c=document.createElement('span'); c.className='chip'; c.innerHTML='üîó <a href="'+st.link+'" target="_blank">Enlace</a>'; attachRow.append(c)} }
  const addDocChip=()=>{ if(st.doc){ const c=document.createElement('span'); c.className='chip'; c.innerHTML='üìÑ <a href="'+st.doc+'" target="_blank">Documento</a>'; attachRow.append(c)} }
  const btnLink=btn('üîó','Adjuntar enlace',''); const btnDoc=btn('üìÑ','Adjuntar documento','');
  attachRow.append(btnLink,btnDoc);
  addLinkChip(); addDocChip();
  // Guardar / meta
  const saveEnd=document.createElement('div'); saveEnd.className='saveEnd';
  const goal=document.createElement('button'); goal.className='goal'; goal.innerHTML='üéØ <b>Guardar</b>';
  saveEnd.append(goal);
  // Conectar todo
  step.append(bubble,vline,head,dWrap,sino,attachRow,saveEnd);
  // acciones
  toggle.onclick=()=>{ dWrap.style.display=dWrap.style.display==='none'?'block':'none' };
  edit.onclick=()=>{ const n=prompt('T√≠tulo del paso:',st.title||'Paso'); if(n){ st.title=n; saveState(); renderRight()} };
  dta.oninput=()=>{ st.desc=dta.value; saveState() };
  resp.onchange=()=>{ st.responsable=resp.value; saveState() };
  plusNo.onclick=()=>{ (st.no||(st.no=[])).push(newPoint()); saveState(); renderRight() };
  plusSi.onclick=()=>{ (st.yes||(st.yes=[])).push(newPoint()); saveState(); renderRight() };
  btnLink.onclick=()=>{ const u=prompt('URL del enlace: ',st.link||'https://'); if(!u)return; st.link=u; saveState(); renderRight() };
  btnDoc.onclick=()=>{ const u=prompt('URL del documento: ',st.doc||'https://'); if(!u)return; st.doc=u; saveState(); renderRight() };
  goal.onclick=()=>{ saveState(); alert('Paso guardado.'); };
  // render puntos
  const base=(sti+1);
  (st.no||[]).forEach((pt,i)=> pointsNo.append(renderPoint(proc,st,pt,`${base}.${i+1}`,st.no)) );
  (st.yes||[]).forEach((pt,i)=> pointsSi.append(renderPoint(proc,st,pt,`${base}.${i+1}`,st.yes)) );
  return step;
}
function renderPoint(proc,st,pt,label,arr){
  const row=document.createElement('div'); row.className='point';
  const pnum=document.createElement('span'); pnum.className='pnum'; pnum.textContent=label;
  const inp=document.createElement('input'); inp.placeholder='Escribe‚Ä¶'; inp.value=pt.text||'';
  const tools=document.createElement('div'); tools.style.display='flex'; tools.style.gap='6px';
  const plus=btn('+','A√±adir sub-punto','gray'); 
  const flag=document.createElement('span'); flag.className='flag'; flag.title='Vincular a proceso';
  const sw=document.createElement('span'); sw.className='swatch'; sw.style.background=proc.color; flag.append('üö©',sw);
  const del=btn('‚Äî','Eliminar','gray');
  tools.append(plus,flag,del);
  row.append(pnum,inp,tools);
  // acciones
  inp.oninput=()=>{ pt.text=inp.value; saveState() };
  plus.onclick=()=>{ (pt.children||(pt.children=[])).push(newPoint()); saveState(); renderRight() };
  del.onclick=()=>{ const i=arr.indexOf(pt); if(i>-1){ arr.splice(i,1); saveState(); renderRight() } };
  flag.onclick=()=>{ // seleccionar proceso destino
    const id=prompt('ID o nombre del proceso destino:');
    if(!id) return;
    const found=state.processes.find(x=>x.id===id || x.name.toLowerCase()===id.toLowerCase());
    if(found){ pt.next=found.id; pt.nextName=found.name; pt.nextColor=found.color; saveState(); renderRight(); }
    else alert('No encontrado. Usa un ID o el nombre exacto.');
  };
  // sub-children
  (pt.children||[]).forEach((ch,i)=> row.after( renderPoint(proc,st,ch,`${label}.${i+1}`,pt.children) ));
  // etiqueta si hay pr√≥ximo proceso
  if(pt.next){
    const chip=document.createElement('span'); chip.className='chip'; chip.style.borderColor='#ddd';
    chip.innerHTML='‚Üí <b>IR AL PROCESO:</b> '+(pt.nextName||pt.next);
    chip.style.background='#fff'; 
    chip.style.color='#111';
    chip.style.outline='2px solid rgba(0,0,0,.03)';
    chip.style.borderLeft='8px solid '+(pt.nextColor||'#999');
    row.append(chip);
  }
  return row;
}
/* ---------- Helpers ---------- */
function newSub(){ return {id:uid(),name:'Nuevo subproceso',desc:'',responsable:'Audi√≥logo',steps:[]} }
function newStep(){ return {id:uid(),title:'Nuevo paso',desc:'',responsable:'Audi√≥logo',yes:[],no:[],link:'',doc:''} }
function newPoint(){ return {id:uid(),text:'',children:[]} }

/* ---------- Conectores verticales ---------- */
function alignConnectors(){
  // en esta versi√≥n el conector vive dentro de cada step y va de la burbuja al final del step.
  // as√≠ncrono para esperar layout
  requestAnimationFrame(()=>{
    $$('.step').forEach(s=>{
      const b=s.querySelector('.bubble'); const v=s.querySelector('.vline');
      if(!b||!v) return;
      const br=b.getBoundingClientRect(), sr=s.getBoundingClientRect();
      const top=br.bottom - sr.top + 2; // desde debajo del n√∫mero
      v.style.top=top+'px';
      v.style.left=(b.offsetLeft + b.offsetWidth/2 - 2)+'px';
      // llega hasta el borde inferior dejando margen
      v.style.height=(s.clientHeight - top - 8)+'px';
    });
  });
}

/* ---------- Eventos de UI global ---------- */
$('#addProcess').onclick=()=>{
  const i=state.processes.length;
  state.processes.push({id:uid(),name:'Nuevo proceso',desc:'',color:colorFor(i),subprocs:[newSub()]});
  selProcId=state.processes[state.processes.length-1].id; saveState(); renderAll();
};
$('#addSub').onclick=()=>{ const p=current(); if(!p) return; p.subprocs.push(newSub()); saveState(); renderRight() };
$('#addStep').onclick=()=>{ const p=current(); if(!p) return;
  if(!p.subprocs.length) p.subprocs.push(newSub());
  p.subprocs[0].steps.push(newStep()); saveState(); renderRight();
};
$('#btnSave').onclick=()=>{ saveState(); alert('Guardado'); };
$('#btnCloudSave').onclick=()=>{ saveState(); alert('Guardado en nube local'); };
$('#btnCloudLoad').onclick=()=>{ state=loadState(); renderAll(); alert('Actualizado desde nube local'); };
$('#btnLock').onclick=()=>{ 
  if(!state.locked){ const pin=prompt('Introduce PIN para bloquear/editar:'); if(pin!=='AR4321') return alert('PIN incorrecto'); }
  setLock(!state.locked);
};
$('#btnHtml').onclick=()=> downloadHTML();
$('#q').oninput=()=> renderLeft();

/* ---------- Exportar HTML sin document.write ---------- */
function downloadHTML(){
  // clon del documento y actualizaci√≥n de la semilla
  const clone=document.documentElement.cloneNode(true);
  const seed=clone.querySelector('#seed');
  if(seed){ seed.textContent=JSON.stringify(state); }
  const html=new XMLSerializer().serializeToString(clone);
  const blob=new Blob([html],{type:'text/html'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='ProcesosAudio.html'; a.click();
  URL.revokeObjectURL(a.href);
}

/* ---------- Inicializaci√≥n ---------- */
function renderAll(){ renderLeft(); renderRight(); $('#lastUpd').textContent='√öltima actualizaci√≥n '+(state.last||'‚Äî'); }
setLock(state.locked);
renderAll();
window.addEventListener('resize',alignConnectors);
</script>
</body>
</html>
