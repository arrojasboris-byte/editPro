<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>PROCESOS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --radius: 18px;
        --bg: #f3f4f6;
      }
      body {
        margin: 0;
        background: var(--bg);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      #app {
        height: 100vh;
        display: flex;
        flex-direction: column;
        max-width: 100vw;
      }
      .top {
        display: flex;
        gap: 8px;
        align-items: center;
        background: linear-gradient(90deg, #000, #5a0000);
        color: #fff;
        padding: 10px 12px;
      }
      .top h1 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
      }
      .top input {
        flex: 1;
        border: none;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 5px 12px;
        color: #fff;
      }
      .top .btn {
        background: rgba(248, 250, 252, 0.12);
        border: 1px solid rgba(248, 250, 252, 0.14);
        color: #fff;
        border-radius: 999px;
        cursor: pointer;
        font-size: 12px;
        padding: 4px 10px;
      }
      .main {
        flex: 1;
        display: flex;
        gap: 10px;
        padding: 10px;
        box-sizing: border-box;
        min-height: 0;
      }
      .main.two-panels #steps {
        display: none !important;
      }
      .panel {
        background: #fff;
        border-radius: var(--radius);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.04);
      }
      .panel header {
        background: #000;
        color: #fff;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .panel .body {
        flex: 1;
        overflow: auto;
        padding: 6px;
      }

      /* PROCESOS */
      #proc {
        flex: 0 0 340px;
        max-width: 360px;
      }
      .proc-item {
        border-radius: 14px;
        margin-bottom: 6px;
        padding: 4px 6px 4px 8px;
        display: flex;
        gap: 4px;
        align-items: flex-start;
        cursor: pointer;
      }
      .proc-item.active {
        outline: 2px solid rgba(0, 0, 0, 0.05);
      }
      .proc-num {
        font-size: 11px;
        font-weight: 700;
        margin-right: 4px;
      }
      .proc-input {
        border: none;
        background: transparent;
        font-weight: 600;
        font-size: 13px;
        width: 100%;
        outline: none;
      }
      .proc-desc-toggle {
        font-size: 10px;
        background: rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 999px;
        padding: 0 6px;
        cursor: pointer;
      }
      .proc-desc textarea {
        width: 100%;
        min-height: 45px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        padding: 3px 4px;
        font-size: 11px;
      }
      .del-btn {
        background: rgba(0, 0, 0, 0.07);
        border: none;
        border-radius: 999px;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        cursor: pointer;
      }

      /* SUBPROCESOS */
      #sub {
        flex: 1 1 0;
        min-width: 260px;
      }
      #sub.hidden-sub {
        display: none;
      }
      #sub header {
        background: linear-gradient(90deg, #000, #5e6f5e);
      }
      .sub-top-actions {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 8px;
      }
      .sub-top-actions button {
        background: rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 8px;
        padding: 3px 10px;
        font-size: 11px;
        cursor: pointer;
      }
      .sub-box {
        border: 1px solid rgba(0, 0, 0, 0.03);
        border-radius: 14px;
        padding: 6px 7px;
        margin-bottom: 6px;
        background: #fff;
      }
      .sub-box.active {
        outline: 2px solid rgba(0, 0, 0, 0.04);
      }
      .sub-header-inline {
        display: flex;
        gap: 4px;
        align-items: center;
        justify-content: space-between;
      }
      .label {
        font-size: 10px;
        text-transform: uppercase;
        color: #777;
        margin-top: 3px;
      }
      .input {
        width: 100%;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 3px 5px;
        font-size: 12px;
      }
      textarea.input {
        min-height: 40px;
        resize: vertical;
      }

      /* PASOS */
      #steps {
        flex: 1 1 0;
        min-width: 260px;
      }
      #steps header {
        background: linear-gradient(90deg, #000, #5e6f5e);
      }
      .step {
        border: 1px solid #eee;
        border-radius: 14px;
        padding: 6px 7px 9px;
        margin-bottom: 6px;
        background: #fff;
        position: relative;
      }
      .step-num {
        font-weight: 700;
        font-size: 11px;
        margin-bottom: 4px;
      }
      .step-del {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.04);
        border: none;
        border-radius: 999px;
        width: 22px;
        height: 22px;
        cursor: pointer;
      }
      .origin {
        font-size: 11px;
        color: #555;
        margin-bottom: 5px;
        font-weight: 500;
      }
      .extras {
        display: flex;
        gap: 6px;
        margin-top: 4px;
      }
      .extras button {
        border: none;
        background: rgba(0, 0, 0, 0.04);
        border-radius: 999px;
        padding: 2px 6px;
        font-size: 11px;
        cursor: pointer;
      }
      .extra-field {
        margin-top: 4px;
      }

      /* responsive */
      @media (max-width: 1024px) {
        .main { flex-wrap: wrap; }
        #proc { flex-basis: 100%; max-width: 100%; }
        #sub, #steps { flex: 1 1 100%; max-width: 100%; }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="top">
        <h1>PROCESOS</h1>
        <input id="search" placeholder="Buscar..." oninput="doSearch(this.value)" />
        <button class="btn" onclick="alert('Guardado en localStorage ✅')">💾 Guardar</button>
      </div>
      <div class="main" id="main">
        <!-- PROCESOS -->
        <div class="panel" id="proc">
          <header>
            <span>Procesos</span>
            <div style="display:flex;gap:6px">
              <button class="btn" onclick="addProcess()">+ Proceso</button>
              <button class="btn" onclick="quickAddSub()">+ Subp.</button>
              <button class="btn" onclick="quickAddStep()">+ Paso</button>
            </div>
          </header>
          <div class="body" id="procList"></div>
        </div>

        <!-- SUBPROCESOS -->
        <div class="panel" id="sub">
          <header id="subHeader">
            <span>Subproceso</span>
            <button class="btn" onclick="addSub()">+ Subproceso</button>
          </header>
          <div class="body" id="subList"></div>
        </div>

        <!-- PASOS -->
        <div class="panel" id="steps">
          <header id="stepHeader">
            <span>Pasos</span>
            <button class="btn" onclick="addStep()">+ Paso</button>
          </header>
          <div class="body" id="stepList"></div>
        </div>
      </div>
    </div>

    <script>
      const LS_KEY = "procesos_app_v2";
      const pastel = ["#ffe4e1","#fff5cc","#e2f0ff","#e5ffe8","#f3e5ff","#ffeaf2","#e9fff9"];
      const responsables = ["Audiólogo","Responsable","Franquiciado"];

      const saved = localStorage.getItem(LS_KEY);
      let data = saved ? JSON.parse(saved) : [
        {id:"p1",name:"REPARACIONES",color:pastel[0],description:"",showDesc:false,subprocesses:[],steps:[]},
        {id:"p2",name:"AJUSTE REMOTO",color:pastel[1],description:"",showDesc:false,subprocesses:[],steps:[]},
      ];

      let currentP = data[0]?.id || null;
      let currentS = null;
      let stepScope = {type:"process",id:currentP};
      let showSteps = false;
      let searchTerm = "";

      // ENTER: confirmar y salir del input
      window.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          const a = document.activeElement;
          if (a && (a.tagName === "INPUT" || a.tagName === "TEXTAREA")) {
            e.preventDefault();
            a.blur();
          }
        }
      });

      function save(){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }

      function uid(){ return Math.random().toString(36).slice(2,9); }

      function doSearch(v){ searchTerm = v.toLowerCase(); render(); }

      function getCurrentP(){ return data.find(p => p.id === currentP) || null; }
      function getCurrentS(){
        const p = getCurrentP(); if (!p) return null;
        return (p.subprocesses||[]).find(s=>s.id===currentS) || null;
      }

      function render(){
        renderProcesses();
        renderSub();
        renderSteps();
        adjustPanels();
        save();
      }

      function adjustPanels(){
        const main = document.getElementById("main");
        // si steps está oculto o no se está mostrando -> two panels
        if (!showSteps){
          main.classList.add("two-panels");
        } else {
          main.classList.remove("two-panels");
        }
      }

      /* -------- PROCESOS -------- */
      function renderProcesses(){
        const box = document.getElementById("procList");
        box.innerHTML = "";
        let list = data.slice();

        if (searchTerm){
          list = list.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.description||"").toLowerCase().includes(searchTerm));
        }

        // primero con subprocesos
        list.sort((a,b)=>{
          const ah = (a.subprocesses||[]).length>0;
          const bh = (b.subprocesses||[]).length>0;
          if (ah===bh) return 0;
          return ah ? -1 : 1;
        });

        list.forEach((p,idx)=>{
          const div = document.createElement("div");
          div.className = "proc-item" + (p.id===currentP ? " active" : "");
          div.style.background = p.color;
          div.onclick = () => {
            currentP = p.id;
            currentS = null;
            const hasSubs = (p.subprocesses||[]).length>0;
            const hasSteps = (p.steps||[]).length>0;
            if (!hasSubs && hasSteps){
              stepScope = {type:"process",id:p.id};
              showSteps = true;
            } else {
              stepScope = {type:"process",id:p.id};
              showSteps = false;
            }
            render();
          };

          const num = document.createElement("div");
          num.className = "proc-num";
          num.textContent = (idx+1)+".";
          div.appendChild(num);

          const flex = document.createElement("div");
          flex.style.flex = "1";

          const inp = document.createElement("input");
          inp.className = "proc-input";
          inp.value = p.name;
          inp.onclick = ev => ev.stopPropagation();
          inp.oninput = ev => { p.name = ev.target.value; save(); };
          flex.appendChild(inp);

          const tgl = document.createElement("button");
          tgl.className = "proc-desc-toggle";
          tgl.textContent = p.showDesc ? "▲ Desc" : "▼ Desc";
          tgl.onclick = ev => { ev.stopPropagation(); p.showDesc=!p.showDesc; render(); };
          flex.appendChild(tgl);

          if (p.showDesc){
            const d = document.createElement("div");
            d.className = "proc-desc";
            const ta = document.createElement("textarea");
            ta.value = p.description || "";
            ta.oninput = ev => { p.description = ev.target.value; save(); };
            d.appendChild(ta);
            flex.appendChild(d);
          }

          div.appendChild(flex);

          const del = document.createElement("button");
          del.className = "del-btn";
          del.type = "button";
          del.textContent = "−";
          del.onclick = ev => {
            ev.stopPropagation();
            deleteProcess(p.id);
          };
          div.appendChild(del);

          box.appendChild(div);
        });
      }

      function deleteProcess(id){
        data = data.filter(p => p.id !== id);
        if (currentP === id){
          currentP = data[0]?.id || null;
          currentS = null;
          stepScope = {type:"process",id:currentP};
          showSteps = false;
        }
        render();
      }

      function addProcess(){
        const np = {
          id: uid(),
          name: "Nuevo proceso",
          color: pastel[data.length % pastel.length],
          description: "",
          showDesc: false,
          subprocesses: [],
          steps: []
        };
        data.push(np);
        currentP = np.id;
        currentS = null;
        stepScope = {type:"process",id:np.id};
        showSteps = false;
        render();
      }

      function quickAddSub(){
        if (!currentP){ alert("Selecciona un proceso"); return; }
        addSub();
      }

      function quickAddStep(){
        if (stepScope.type==="process" && !currentP){ alert("Selecciona un proceso"); return; }
        if (stepScope.type==="subprocess" && !currentS){ alert("Selecciona un subproceso"); return; }
        addStep();
      }

      /* -------- SUBPROCESOS -------- */
      function renderSub(){
        const p = getCurrentP();
        const list = document.getElementById("subList");
        const subPanel = document.getElementById("sub");
        const subHeader = document.getElementById("subHeader");
        const stepsPanel = document.getElementById("steps");
        list.innerHTML = "";

        if (p){
          subHeader.style.background = "linear-gradient(90deg,#000,"+shade(p.color,-20)+")";
        }

        if (!p){
          subPanel.classList.remove("hidden-sub");
          stepsPanel.classList.remove("full-width");
          list.innerHTML = "<p style='color:#888;text-align:center;margin-top:20px'>Selecciona un proceso</p>";
          return;
        }

        const subs = p.subprocesses || [];
        const procSteps = p.steps || [];

        // si no hay subprocesos y sí hay pasos -> ocultar panel central
        if (subs.length===0 && procSteps.length>0){
          subPanel.classList.add("hidden-sub");
          stepsPanel.style.display = "flex";
          stepsPanel.style.flex = "1 1 0";
          showSteps = true;
          stepScope = {type:"process",id:p.id};
          return;
        } else {
          subPanel.classList.remove("hidden-sub");
          stepsPanel.style.display = "flex";
        }

        // barra superior con botón único de pasos
        const topActions = document.createElement("div");
        topActions.className = "sub-top-actions";
        const btnPasos = document.createElement("button");
        btnPasos.textContent = "Pasos →";
        btnPasos.onclick = () => {
          // si hay un subproceso seleccionado, muestra sus pasos
          if (currentS){
            stepScope = {type:"subprocess",id:currentS};
          } else {
            stepScope = {type:"process",id:p.id};
          }
          showSteps = true;
          render();
        };
        topActions.appendChild(btnPasos);
        list.appendChild(topActions);

        if (subs.length===0){
          list.innerHTML += "<div style='color:#888;text-align:center;margin-top:15px'>Este proceso no tiene subprocesos.</div>";
          return;
        }

        subs.forEach(s=>{
          const box = document.createElement("div");
          box.className = "sub-box" + (s.id===currentS ? " active":"");
          box.style.background = hexToRgba(p.color,0.35);
          box.onclick = () => { currentS = s.id; renderSub(); };

          const head = document.createElement("div");
          head.className = "sub-header-inline";

          const name = document.createElement("input");
          name.className = "input";
          name.value = s.name;
          name.oninput = e => { s.name = e.target.value; save(); };
          head.appendChild(name);

          const del = document.createElement("button");
          del.className = "del-btn";
          del.textContent = "−";
          del.onclick = ev => { ev.stopPropagation(); deleteSub(s.id); };
          head.appendChild(del);

          box.appendChild(head);

          // Proceso origen
          const lab0 = document.createElement("div");
          lab0.className = "label";
          lab0.textContent = "Proceso origen";
          box.appendChild(lab0);

          const pv = document.createElement("div");
          pv.style.fontSize = "11px";
          pv.textContent = p.name;
          box.appendChild(pv);

          // Descripción
          const lab1 = document.createElement("div");
          lab1.className = "label";
          lab1.textContent = "Descripción";
          box.appendChild(lab1);
          const ta = document.createElement("textarea");
          ta.className = "input";
          ta.value = s.description || "";
          ta.oninput = e => { s.description = e.target.value; save(); };
          box.appendChild(ta);

          // Responsable
          const lab2 = document.createElement("div");
          lab2.className = "label";
          lab2.textContent = "Persona responsable";
          box.appendChild(lab2);
          const sel = document.createElement("select");
          sel.className = "input";
          responsables.forEach(r=>{
            const opt = document.createElement("option");
            opt.value = r; opt.textContent = r; sel.appendChild(opt);
          });
          sel.value = s.responsable || responsables[0];
          sel.onchange = e => { s.responsable = e.target.value; save(); };
          box.appendChild(sel);

          // Enlace
          const lab3 = document.createElement("div");
          lab3.className = "label";
          lab3.textContent = "Enlace";
          box.appendChild(lab3);
          const link = document.createElement("input");
          link.className = "input";
          link.value = s.link || "";
          link.oninput = e => { s.link = e.target.value; save(); };
          box.appendChild(link);

          // Documento
          const lab4 = document.createElement("div");
          lab4.className = "label";
          lab4.textContent = "Documento";
          box.appendChild(lab4);
          const doc = document.createElement("input");
          doc.className = "input";
          doc.value = s.document || "";
          doc.oninput = e => { s.document = e.target.value; save(); };
          box.appendChild(doc);

          list.appendChild(box);
        });
      }

      function addSub(){
        const p = getCurrentP();
        if (!p) return;
        const ns = {
          id: uid(),
          name: "Nuevo subproceso",
          description: "",
          responsable: responsables[0],
          link: "",
          document: "",
          steps: []
        };
        p.subprocesses.push(ns);
        currentS = ns.id;
        stepScope = {type:"subprocess",id:ns.id};
        showSteps = false;
        render();
      }

      function deleteSub(id){
        const p = getCurrentP();
        if (!p) return;
        p.subprocesses = (p.subprocesses||[]).filter(s=>s.id!==id);
        if (currentS === id){
          currentS = null;
          stepScope = {type:"process",id:p.id};
          showSteps = false;
        }
        render();
      }

      /* -------- PASOS -------- */
      function renderSteps(){
        const list = document.getElementById("stepList");
        const stepHeader = document.getElementById("stepHeader");
        const p = getCurrentP();
        if (p){
          stepHeader.style.background = "linear-gradient(90deg,#000,"+shade(p.color,-20)+")";
        }
        list.innerHTML = "";
        if (!showSteps){
          list.innerHTML = "<p style='color:#888;text-align:center;margin-top:20px'>Pulsa “Pasos →”</p>";
          return;
        }

        let steps = [];
        let origin = "";
        if (stepScope.type === "process"){
          const pr = data.find(x=>x.id===stepScope.id);
          steps = pr ? (pr.steps||[]) : [];
          origin = "Proceso origen: " + (pr ? pr.name : "");
        } else {
          const sp = getCurrentS();
          steps = sp ? (sp.steps||[]) : [];
          origin = "Subproceso origen: " + (sp ? sp.name : "");
        }

        const org = document.createElement("div");
        org.className = "origin";
        org.textContent = origin;
        list.appendChild(org);

        if (!steps.length){
          list.innerHTML += "<div style='color:#888;text-align:center;margin-top:10px'>No hay pasos aún.</div>";
        }

        steps.forEach((st,idx)=>{
          // aseguramos arrays
          st.extraLinks = st.extraLinks || [];
          st.extraDocs = st.extraDocs || [];

          const box = document.createElement("div");
          box.className = "step";

          const del = document.createElement("button");
          del.className = "step-del";
          del.textContent = "−";
          del.onclick = () => { deleteStep(st.id); };
          box.appendChild(del);

          const num = document.createElement("div");
          num.className = "step-num";
          num.textContent = "Paso " + (idx+1);
          box.appendChild(num);

          const name = document.createElement("input");
          name.className = "input";
          name.value = st.name || "";
          name.placeholder = "Título del paso";
          name.oninput = e => { st.name = e.target.value; save(); };
          box.appendChild(name);

          const lab1 = document.createElement("div");
          lab1.className = "label";
          lab1.textContent = "Descripción";
          box.appendChild(lab1);
          const ta = document.createElement("textarea");
          ta.className = "input";
          ta.value = st.description || "";
          ta.oninput = e => { st.description = e.target.value; save(); };
          box.appendChild(ta);

          const lab2 = document.createElement("div");
          lab2.className = "label";
          lab2.textContent = "Enlace / documento";
          box.appendChild(lab2);

          const link = document.createElement("input");
          link.className = "input";
          link.value = st.link || "";
          link.placeholder = "Enlace / documento";
          link.oninput = e => { st.link = e.target.value; save(); };
          box.appendChild(link);

          const doc = document.createElement("input");
          doc.className = "input";
          doc.value = st.document || "";
          doc.placeholder = "Documento";
          doc.oninput = e => { st.document = e.target.value; save(); };
          box.appendChild(doc);

          // extras (iconos)
          const extraBar = document.createElement("div");
          extraBar.className = "extras";
          const addLink = document.createElement("button");
          addLink.textContent = "➕🔗";
          addLink.title = "Añadir otro enlace";
          addLink.onclick = () => {
            st.extraLinks.push("");
            renderSteps();
          };
          extraBar.appendChild(addLink);

          const addDoc = document.createElement("button");
          addDoc.textContent = "➕📄";
          addDoc.title = "Añadir otro documento";
          addDoc.onclick = () => {
            st.extraDocs.push("");
            renderSteps();
          };
          extraBar.appendChild(addDoc);
          box.appendChild(extraBar);

          // pintar extras
          st.extraLinks.forEach((v,ix)=>{
            const ef = document.createElement("input");
            ef.className = "input extra-field";
            ef.value = v;
            ef.placeholder = "Enlace extra "+(ix+1);
            ef.oninput = e => { st.extraLinks[ix] = e.target.value; save(); };
            box.appendChild(ef);
          });
          st.extraDocs.forEach((v,ix)=>{
            const ef = document.createElement("input");
            ef.className = "input extra-field";
            ef.value = v;
            ef.placeholder = "Documento extra "+(ix+1);
            ef.oninput = e => { st.extraDocs[ix] = e.target.value; save(); };
            box.appendChild(ef);
          });

          list.appendChild(box);
        });
      }

      function addStep(){
        if (stepScope.type === "process"){
          const p = getCurrentP(); if (!p){ alert("Selecciona un proceso"); return; }
          p.steps = p.steps || [];
          p.steps.push({id:uid(),name:"Nuevo paso",description:"",link:"",document:"",extraLinks:[],extraDocs:[]});
        } else {
          const s = getCurrentS(); if (!s){ alert("Selecciona un subproceso"); return; }
          s.steps = s.steps || [];
          s.steps.push({id:uid(),name:"Nuevo paso",description:"",link:"",document:"",extraLinks:[],extraDocs:[]});
        }
        showSteps = true;
        render();
      }

      function deleteStep(id){
        if (stepScope.type === "process"){
          const p = getCurrentP(); if (!p) return;
          p.steps = (p.steps||[]).filter(st=>st.id!==id);
        } else {
          const s = getCurrentS(); if (!s) return;
          s.steps = (s.steps||[]).filter(st=>st.id!==id);
        }
        renderSteps(); // reenumera
      }

      function shade(hex,percent){
        if(!hex) return "#000";
        const f=parseInt(hex.slice(1),16),
              t=percent<0?0:255,
              p=percent<0?percent*-1:percent,
              R=f>>16,
              G=f>>8&0x00FF,
              B=f&0x0000FF;
        return "#"+(0x1000000+
          (Math.round((t-R)*p/100)+R)*0x10000+
          (Math.round((t-G)*p/100)+G)*0x100+
          (Math.round((t-B)*p/100)+B)
        ).toString(16).slice(1);
      }
      function hexToRgba(hex, alpha){
        if(!hex) return "rgba(255,255,255,"+alpha+")";
        const h=hex.replace("#","");
        const r=parseInt(h.substring(0,2),16);
        const g=parseInt(h.substring(2,4),16);
        const b=parseInt(h.substring(4,6),16);
        return "rgba("+r+","+g+","+b+","+alpha+")";
      }

      render();
    </script>
  </body>
</html>
