<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PROCESOS AUDIO</title>
<style>
  :root{
    --bg:#2b2b2d;              /* gris base */
    --bg-soft:#323236;         /* gris suave */
    --panel:#3a3a3f;
    --ink:#f4f4f6;
    --muted:#bfc3cc;
    --accent:#e25b5b;
    --btn-grad-a:#4d4d52;
    --btn-grad-b:#2f3033;
    --shadow: 0 6px 18px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
    --radius:16px;
    --number-bg:#111;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);font:15px/1.4 system-ui,Segoe UI,Roboto,Inter,Arial;
  }
  /* Barra superior */
  header{
    position:sticky;top:0;z-index:5;
    background:linear-gradient(90deg,#6d6e73,#9b3c3c 40%,#6e2f2f 70%,#4a2828);
    padding:10px 14px;display:flex;gap:12px;align-items:center;
    box-shadow:0 6px 18px rgba(0,0,0,.25);
  }
  header h1{
    margin:0;font-weight:800;letter-spacing:.5px;display:flex;gap:10px;align-items:center;
    text-shadow:0 2px 0 rgba(0,0,0,.35);
  }
  header h1 .phone{font-size:22px;filter:drop-shadow(0 1px 0 rgba(0,0,0,.4))}
  header input[type="search"]{
    flex:1;max-width:640px;border:none;border-radius:999px;
    padding:10px 14px;background:#ffffff1a;color:#fff;outline:none;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
  }
  .pill{
    border:none;border-radius:999px;padding:10px 14px;
    background:linear-gradient(180deg,var(--btn-grad-a),var(--btn-grad-b));
    color:#fff;box-shadow:var(--shadow);cursor:pointer;display:inline-flex;gap:8px;align-items:center;
  }
  .pill:active{transform:translateY(1px)}
  .row{display:flex;gap:16px;padding:16px}

  /* Layout */
  .wrap{display:grid;grid-template-columns: 380px 1fr;gap:0;min-height:calc(100dvh - 64px)}
  @media (max-width:1100px){ .wrap{grid-template-columns:320px 1fr} }
  @media (max-width:860px){ .wrap{grid-template-columns:1fr} }

  /* Panel izquierdo */
  .left{
    border-right:1px solid #ffffff14;background:var(--bg-soft);
  }
  .left-head{
    display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid #ffffff14;
  }
  .left-list{padding:12px;display:flex;flex-direction:column;gap:10px}
  .proc{
    background:var(--panel);border-radius:14px;padding:10px 12px;
    display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;
    box-shadow:var(--shadow);cursor:pointer;border:2px solid transparent;
  }
  .proc .dot{width:10px;height:10px;border-radius:999px;box-shadow:inset 0 1px 0 rgba(255,255,255,.5)}
  .proc .name{font-weight:700}
  .proc .min{opacity:.8;font-size:12px}
  .proc .ctrls{display:flex;gap:8px}
  .ico{width:26px;height:26px;border-radius:8px;display:grid;place-items:center;
       background:#ffffff14;color:#fff;box-shadow:inset 0 1px 0 rgba(255,255,255,.08)}
  .proc.active{border-color:#fff8}

  /* Panel derecho */
  .right{background:var(--bg);overflow:auto}
  .process-sheet{padding:16px}
  .sheet-head{
    display:flex;align-items:center;gap:12px;background:var(--bg-soft);
    border-radius:14px;padding:12px 14px;box-shadow:var(--shadow);
  }
  .sheet-title{font-weight:900;letter-spacing:.3px}
  .badge{padding:4px 10px;border-radius:999px;background:#ffffff1a}
  .sub-grid{display:flex;flex-direction:column;gap:14px;margin-top:12px}

  /* Subproceso */
  .sub{
    background:var(--panel);border-radius:16px;padding:12px 12px 10px;box-shadow:var(--shadow);
  }
  .sub-head{
    display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;margin-bottom:8px;
    background:linear-gradient(180deg,#4a4a4f,#3b3b3f);padding:8px;border-radius:12px;
  }
  .sub-name{
    font-weight:800;letter-spacing:.2px;padding:8px 10px;border-radius:12px;
    background:linear-gradient(180deg,#111,#1c1c1f);color:#fff;border:1px solid #ffffff1a;
  }
  .sub-ctrls{display:flex;gap:8px;align-items:center}
  .resp{background:#ffffff10;border:1px solid #ffffff22;color:#fff;border-radius:10px;padding:6px 10px}

  /* Pasos l√≠nea vertical + burbuja */
  .steps{display:flex;flex-direction:column;gap:8px;position:relative}
  .step{
    position:relative;padding-left:72px;background:#22252a;border-radius:14px;
    box-shadow:var(--shadow);min-height:56px;display:flex;flex-direction:column;justify-content:center
  }
  /* L√≠nea vertical gruesa (color proceso) */
  .step::before{
    content:"";position:absolute;left:40px;top:10px;bottom:10px;width:6px;border-radius:6px;background:var(--line);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), 0 1px 0 rgba(255,255,255,.05);
  }
  /* burbuja n√∫mero grande */
  .bubble{
    position:absolute;left:20px;top:50%;transform:translateY(-50%);
    width:36px;height:36px;border-radius:999px;background:var(--number-bg);
    display:grid;place-items:center;font-weight:900;font-size:13px;border:1px solid #ffffff1a;
    box-shadow:0 6px 14px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
  }
  .step-head{
    display:flex;align-items:center;gap:10px;padding:8px 10px
  }
  .step-title{
    flex:1;border:none;background:transparent;color:#fff;font-weight:700;outline:none;
  }
  .step-ctrls{display:flex;gap:6px}
  .btn-icon{
    width:32px;height:32px;border-radius:10px;border:1px solid #ffffff20;display:grid;place-items:center;
    background:#ffffff0f;box-shadow:inset 0 1px 0 rgba(255,255,255,.06)
  }
  .detail{
    display:none;padding:8px 10px 12px
  }
  .detail textarea{
    width:100%;min-height:70px;border-radius:10px;border:1px solid #ffffff22;background:#ffffff10;color:#fff;padding:8px;outline:none
  }
  .si-no{display:flex;gap:14px;align-items:flex-start;margin-top:8px}
  .col {flex:1}
  .col h5{margin:0 0 6px;font-size:12px;letter-spacing:.4px;opacity:.85}
  .point{display:flex;align-items:center;gap:6px;margin:4px 0}
  .point input{
    flex:1;background:#ffffff10;color:#fff;border:1px solid #ffffff22;border-radius:8px;padding:6px 8px
  }
  .point .btn-icon{width:28px;height:28px}

  /* Adjuntos */
  .attach{display:flex;gap:10px;margin-top:6px}
  .attach .pill{padding:8px 10px}

  /* pie/control barra inferior */
  .dock{
    position:sticky;bottom:0;z-index:4;background:#1f1f20cc;backdrop-filter:blur(8px);
    padding:10px;display:flex;gap:10px;justify-content:center;border-top:1px solid #ffffff14
  }

  /* Editar: oculta iconos cuando NO est√° editando */
  body:not(.editing) .ico,
  body:not(.editing) .btn-icon,
  body:not(.editing) .sub-ctrls,
  body:not(.editing) .resp,
  body:not(.editing) .detail .attach .pill { display:none !important; }

  /* Mostrar detalle SIEMPRE justo tras el t√≠tulo (si est√° abierto) */
  .step.open .detail{ display:block }

  /* estados */
  .muted{opacity:.65}

  /* 3D botones */
  .act{
    background:linear-gradient(180deg,#585a60,#383a3f);
    border:1px solid #ffffff22;color:#fff;border-radius:12px;padding:8px 12px;
    box-shadow:var(--shadow);display:inline-flex;gap:8px;align-items:center
  }
  .act:active{transform:translateY(1px)}
</style>
</head>
<body>

<header>
  <h1><span class="phone">üéß</span> PROCESOS AUDIO</h1>
  <input type="search" id="q" placeholder="Buscar‚Ä¶">
  <button id="addProcess" class="pill">+ Procesos</button>
  <button id="addSP" class="pill">+ Subproceso + Paso</button>
  <button id="saveSP" class="pill">üéØ Guardar subproceso</button>
  <span id="last" class="badge">‚Äî</span>
</header>

<div class="wrap">
  <!-- IZQUIERDA -->
  <aside class="left">
    <div class="left-head">
      <strong class="muted">Procesos</strong>
    </div>
    <div id="procList" class="left-list"></div>
  </aside>

  <!-- DERECHA -->
  <main class="right">
    <div class="process-sheet" id="sheet"></div>
  </main>
</div>

<!-- DOCK inferior -->
<div class="dock">
  <button class="pill" id="toggleEdit">‚úèÔ∏è Editar</button>
  <button class="pill" id="compact">üß© Compacto</button>
  <button class="pill" id="exportHtml">‚¨áÔ∏è HTML</button>
</div>

<script>
/* ========= STATE ========= */
const LSKEY='PROCESOS_AUDIO_V2';
let state = load() || seed();
let current = 0;
let editing = false;

/* ========= UTILS ========= */
function save(){
  localStorage.setItem(LSKEY, JSON.stringify(state));
  document.getElementById('last').textContent =
    '√öltima actualizaci√≥n ' + new Date().toLocaleString();
}
function load(){
  try { return JSON.parse(localStorage.getItem(LSKEY)); } catch(e){ return null }
}
function seed(){
  // crea un proceso base
  return [{
    id: uid(), name:'Revisi√≥n auditiva', desc:'',
    pastel: pastel(0),
    sub:[]
  }];
}
function uid(){ return Math.random().toString(36).slice(2,9) }
function pastel(i){
  // paleta pastel estable
  const hues=[10,25,45,100,140,180,205,230,260,300,330];
  const h=hues[i%hues.length];
  return `hsl(${h} 70% 70%)`;
}
function byId(id){ return document.getElementById(id) }
function el(tag,cls,html){
  const e=document.createElement(tag);
  if(cls) e.className=cls;
  if(html!=null) e.innerHTML=html;
  return e;
}

/* ========= RENDER LEFT ========= */
function renderLeft(){
  const wrap=byId('procList'); wrap.innerHTML='';
  state.forEach((p,i)=>{
    const item=el('div','proc');
    item.style.setProperty('--pastel', p.pastel);
    item.innerHTML=`
      <span class="dot" style="background:${p.pastel}"></span>
      <div>
        <div class="name">${p.name||'Nuevo proceso'}</div>
        <div class="min muted">${p.sub.length} subprocesos</div>
      </div>
      <div class="ctrls">
        <button class="ico" title="Editar" onclick="renameProcess(${i})">‚úèÔ∏è</button>
        <button class="ico" title="Borrar" onclick="removeProcess(${i})">üóë</button>
      </div>
    `;
    item.onclick = (ev)=>{ if(ev.target.closest('.ico')) return; current=i; renderRight(); highlight() }
    wrap.appendChild(item);
  });
  highlight();
}
function highlight(){
  [...document.querySelectorAll('.proc')].forEach((n,idx)=>{
    n.classList.toggle('active', idx===current);
  });
}

/* ========= RENDER RIGHT ========= */
function renderRight(){
  const p=state[current]; if(!p) return;

  const sheet=byId('sheet'); sheet.innerHTML='';
  const head=el('div','sheet-head');
  head.innerHTML=`
    <div class="sheet-title">Proceso: <strong>${p.name||'Nuevo proceso'}</strong></div>
    <span class="badge" style="background:${p.pastel}22;color:#fff">Color</span>
    <button class="act" onclick="addSubWithStep()">+ Subproceso + Paso</button>
  `;
  sheet.appendChild(head);

  const grid=el('div','sub-grid'); sheet.appendChild(grid);

  // render cada subproceso
  p.sub.forEach((sp,si)=>{
    const sub=el('div','sub');
    const lineColor=p.pastel; // para pasos de este sub

    const head=el('div','sub-head');
    const name=el('input','sub-name');
    name.value=sp.name||'Subproceso';
    name.oninput=()=>{ sp.name=name.value; save() };

    const ctrls=el('div','sub-ctrls');
    ctrls.innerHTML=`
      <button class="ico" title="A√±adir paso" onclick="addStep(${si})">Ôºã</button>
      <button class="ico" title="Borrar subproceso" onclick="removeSub(${si})">üóë</button>
    `;
    const resp=el('select','resp');
    resp.innerHTML=`<option>Audi√≥logo</option><option>Responsable</option><option>Otros</option>`;
    resp.value=sp.resp||'Audi√≥logo';
    resp.oninput=()=>{ sp.resp=resp.value; save() };

    head.append(name, ctrls, resp);
    sub.appendChild(head);

    const steps=el('div','steps'); sub.appendChild(steps);

    (sp.steps||[]).forEach((st,idx)=>{
      const row=el('div','step'); 
      row.style.setProperty('--line', lineColor);

      const bubble=el('div','bubble', String(idx+1));
      row.appendChild(bubble);

      const head=el('div','step-head');
      const ti=el('input','step-title'); ti.value=st.title||'Nuevo paso';
      ti.oninput=()=>{ st.title=ti.value; save() };

      const sc=el('div','step-ctrls');
      sc.innerHTML=`
        <button class="btn-icon" title="Ver/ocultar detalle" onclick="toggleDetail(this)">‚ñæ</button>
        <button class="btn-icon" title="Borrar paso" onclick="removeStep(${si},${idx})">üóë</button>
      `;
      head.append(ti, sc);
      row.appendChild(head);

      /* DETALLE (siempre debajo del t√≠tulo) */
      const det=el('div','detail');
      det.innerHTML=`
        <textarea placeholder="Descripci√≥n">${st.desc||''}</textarea>
        <div class="si-no">
          <div class="col">
            <h5>NO</h5>
            <div class="point"><input value="${(st.no?.[0]||'')}" placeholder="Ej. 1.1"><button class="btn-icon" onclick="addPoint(${si},${idx},'no')">Ôºã</button></div>
          </div>
          <div class="col">
            <h5>S√ç</h5>
            <div class="point"><input value="${(st.yes?.[0]||'')}" placeholder="Ej. 1.1"><button class="btn-icon" onclick="addPoint(${si},${idx},'yes')">Ôºã</button></div>
          </div>
        </div>
        <div class="attach">
          <button class="pill" onclick="addLink(${si},${idx})">üîó Enlace</button>
          <button class="pill" onclick="addDoc(${si},${idx})">üìé Documento</button>
        </div>
      `;
      // bind textarea
      det.querySelector('textarea').oninput=(e)=>{ st.desc=e.target.value; save() };
      row.appendChild(det);

      steps.appendChild(row);
    });

    // guardar subproceso
    const foot=el('div','',`<div style="padding:10px 6px 0"><button class="pill" onclick="save();alert('Subproceso guardado');">üéØ Guardar subproceso</button></div>`);
    sub.appendChild(foot);

    grid.appendChild(sub);
  });

  // para que al entrar se vea todo compacto
  document.body.classList.toggle('editing', editing);
}

/* ========= ACTIONS ========= */
function addProcess(){
  const i=state.length;
  state.push({id:uid(), name:'Nuevo proceso', desc:'', pastel:pastel(i), sub:[]});
  current=state.length-1;
  save(); renderLeft(); renderRight();
}
function renameProcess(i){
  const name=prompt('Nombre del proceso:', state[i].name||'');
  if(name!=null){ state[i].name=name; save(); renderLeft(); renderRight() }
}
function removeProcess(i){
  if(!confirm('¬øEliminar proceso?')) return;
  state.splice(i,1); current=Math.max(0,current-1); save(); renderLeft(); renderRight();
}
function addSubWithStep(){
  const p=state[current]; if(!p) return;
  p.sub??=[]; 
  p.sub.push({id:uid(), name:'Nuevo subproceso', resp:'Audi√≥logo', steps:[{id:uid(), title:'Nuevo paso', desc:'', yes:[], no:[], links:[], docs:[]}]});
  save(); renderRight();
}
function addStep(si){
  const p=state[current]; const sp=p.sub[si];
  sp.steps.push({id:uid(), title:'Nuevo paso', desc:'', yes:[], no:[], links:[], docs:[]});
  save(); renderRight();
}
function removeSub(si){
  const p=state[current]; p.sub.splice(si,1); save(); renderRight();
}
function removeStep(si,idx){
  const p=state[current]; p.sub[si].steps.splice(idx,1); save(); renderRight();
}
function toggleDetail(btn){
  const step = btn.closest('.step'); step.classList.toggle('open');
}
function addPoint(si,idx,which){
  const p=state[current]; const st=p.sub[si].steps[idx];
  st[which]??=[]; st[which].push(''); save(); renderRight();
}
function addLink(si,idx){ alert('Adjuntar enlace (demo)'); }
function addDoc(si,idx){ alert('Adjuntar documento (demo)'); }

/* ========= EVENTS ========= */
document.getElementById('addProcess').onclick=addProcess;
document.getElementById('addSP').onclick=addSubWithStep;
document.getElementById('saveSP').onclick=()=>{ save(); alert('Subproceso guardado'); };
document.getElementById('toggleEdit').onclick=()=>{ editing=!editing; document.body.classList.toggle('editing', editing) };
document.getElementById('compact').onclick=()=>{ window.scrollTo({top:0,behavior:'smooth'}) };
document.getElementById('exportHtml').onclick=()=>{
  const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='procesos-audio.html'; a.click();
};

/* ========= INIT ========= */
renderLeft();
renderRight();
save(); // pone la fecha de √∫ltima actualizaci√≥n
</script>
</body>
</html>
