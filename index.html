<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PROCESOS AUDIO</title>
<style>
:root{
  --bg:#f2f3f5;         /* fondo gris claro */
  --panel:#ffffff;
  --ink:#17181a;
  --muted:#5a606b;
  --brand:#b02a2a;
  --brand2:#d45353;
  --shadow:0 10px 24px rgba(0,0,0,.08),0 2px 5px rgba(0,0,0,.04);
  --radius:16px;
  --chip:#f6f7f9;
}

/* --- REGLA CLAVE PARA EL MODAL --- */
.hide{ display:none !important; }

/* layout */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
}

/* header */
.header{
  position:sticky; top:0; z-index:20;
  background:linear-gradient(90deg,#a73939,#602323);
  color:#fff;
  padding:.75rem 1rem;
  display:flex; align-items:center; gap:.8rem;
  box-shadow:var(--shadow)
}
.h-title{
  display:flex; align-items:center; gap:.65rem; font-weight:800; font-size:1.4rem;
  letter-spacing:.5px
}
.h-search{flex:1}
.h-search input{
  width:100%; border:none; outline:none;
  background:rgba(255,255,255,.15); color:#fff;padding:.55rem .9rem;border-radius:999px
}

/* buttons 3D */
.btn3d{
  background:#fff; border:none; border-radius:999px; padding:.6rem 1rem;
  box-shadow:inset 0 -2px 0 rgba(0,0,0,.08), 0 4px 12px rgba(0,0,0,.1);
  font-weight:600; color:#222; display:inline-flex; gap:.5rem; align-items:center; cursor:pointer
}
.btn3d:active{ transform:translateY(1px) }

.icon{font-style:normal; display:inline-block; width:1.1rem; height:1.1rem; line-height:1.1rem; text-align:center}

/* layout principal */
.main{display:grid; grid-template-columns:320px 1fr; gap:16px; padding:14px}

/* procesos panel */
.proc-left{
  background:var(--panel); border-radius:var(--radius); padding:10px; box-shadow:var(--shadow); min-height:70vh
}
.proc-card{
  background:#fff; border-radius:14px; padding:.7rem .75rem; margin:.55rem 0; box-shadow:inset 0 -1px 0 rgba(0,0,0,.06),0 1px 0 rgba(0,0,0,.03);
  display:flex;align-items:center; gap:.6rem; justify-content:space-between; border:1px solid rgba(0,0,0,.05)
}
.proc-card .name{font-weight:800}
.proc-actions{display:flex; gap:.4rem}
.chip{
  background:var(--chip); border-radius:999px; padding:.25rem .55rem; font-weight:700; font-size:.8rem; color:#111; display:inline-flex; gap:.45rem; align-items:center
}
.dot{width:.65rem; height:.65rem; border-radius:50%; display:inline-block}

/* contenedor derecho */
.proc-right{
  display:grid; grid-template-columns:repeat(2,minmax(380px,1fr)); gap:16px;
}
.module{
  background:var(--panel); border-radius:18px; box-shadow:var(--shadow); overflow:hidden;
  display:flex; flex-direction:column
}
.mod-head{
  background:rgba(255,190,130,.35); /* se sobreescribe dinÃ¡micamente acorde al color del proceso */
  padding:.7rem; display:flex; align-items:center; gap:.5rem; justify-content:space-between;
}
.mod-title{
  background:#222; color:#fff; padding:.5rem .9rem; border-radius:999px; font-weight:800; box-shadow:inset 0 -2px 0 rgba(255,255,255,.08)
}
.mod-actions{display:flex; gap:.5rem; align-items:center}

/* pasos */
.mod-body{ padding:.65rem .75rem 1rem }
.step{
  background:#fff; border-radius:14px; padding:.7rem .8rem; margin:.55rem 0;
  display:grid; grid-template-columns:52px 1fr auto; align-items:center; gap:.6rem;
  border:1px solid rgba(0,0,0,.05); position:relative;
}
.step .num{
  background:#111;color:#fff;width:40px;height:40px;border-radius:50%; display:grid;place-items:center; font-weight:900; font-size:.98rem;
  position:relative; z-index:1;
}
.step .vline{
  position:absolute; left:26px; top:40px; bottom:-8px; width:6px; border-radius:6px; background:#f1c24f; opacity:.9;
}
.step .title{ font-size:1.05rem; font-weight:800 }
.step .right{ display:flex; gap:.45rem; align-items:center }

/* acciones pequeÃ±as en paso */
.pill{
  background:#fff; border:1px solid rgba(0,0,0,.08); color:#111; border-radius:999px; padding:.35rem .6rem; font-weight:700;
  display:inline-flex; gap:.4rem; align-items:center; box-shadow:inset 0 -2px 0 rgba(0,0,0,.06)
}

/* detalles (ocultos por defecto) */
.detail{ display:none; margin:.4rem 0 .1rem 52px }
.detail textarea{
  width:100%; min-height:84px; border-radius:12px; border:1px solid rgba(0,0,0,.1); padding:.6rem .7rem; resize:vertical;
}

/* modal selector proceso destino */
#procModal{
  position:fixed; inset:0; background:rgba(0,0,0,.35); display:grid; place-items:center; z-index:50;
}
#pmCard{
  width:min(520px,92vw); background:#fff; border-radius:18px; padding:1rem; box-shadow:var(--shadow)
}
#procModalList{ display:grid; gap:.5rem; margin-top:.5rem; max-height:50vh; overflow:auto }
#pmActions{ display:flex; justify-content:flex-end; margin-top:.7rem }

/* imprime */
@media print{
  .header, .proc-actions, .mod-actions, .right .pill, .btn3d, #procModal{ display:none !important }
  .main{ grid-template-columns:1fr; }
  .proc-left{ display:none }
  body{ background:#fff }
}
</style>
</head>
<body>

<header class="header">
  <div class="h-title">
    <span class="icon">ğŸ§</span> PROCESOS AUDIO
  </div>
  <div class="h-search"><input id="q" placeholder="Buscarâ€¦"></div>

  <!-- Botonera superior (no tocada) -->
  <button class="btn3d" id="btnAddProc"><span class="icon">ï¼‹</span> Procesos</button>
  <button class="btn3d" id="btnAddStep"><span class="icon">ï¼‹</span> Paso</button>
  <button class="btn3d" id="btnAddPack"><span class="icon">ï¼‹</span> Subproceso + Paso</button>

  <!-- PIN / PDF / HTML / Guardar nube -->
  <button class="btn3d" id="btnPIN" title="Desbloquear ediciÃ³n"><span class="icon">ğŸ”’</span></button>
  <button class="btn3d" id="btnPDF" title="Imprimir / PDF"><span class="icon">ğŸ–¨ï¸</span></button>
  <button class="btn3d" id="btnHTML" title="Descargar HTML"><span class="icon">â¬‡ï¸</span> HTML</button>
  <button class="btn3d" id="btnSaveCloud" title="Guardar"><span class="icon">ğŸ’¾</span> Guardar</button>
</header>

<main class="main">
  <!-- IZQUIERDA -->
  <aside class="proc-left">
    <div id="procList"></div>
  </aside>

  <!-- DERECHA -->
  <section class="proc-right" id="modules"></section>
</main>

<!-- MODAL selector proceso destino -->
<div id="procModal" class="hide">
  <div id="pmCard">
    <div style="font-weight:800;font-size:1.05rem">Selecciona proceso destino</div>
    <div id="procModalList"></div>
    <div id="pmActions">
      <button id="pmCancel" class="btn3d">Cancelar</button>
    </div>
  </div>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const colors = [
  '#ffb4b4','#ffd39c','#ffe18b','#c7f1a0','#a9e5ff','#bdb0ff','#ffc2e9','#f7d48b','#c0ffd7','#ffd0a0'
];
const roles = ['AudiÃ³logo','Responsable','Otros'];

const state = {
  processes: [],
  current: null, // id proceso seleccionado
  pinOk: false
};
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const uid = (p='id') => p+Math.random().toString(36).slice(2,9);

/* util show/hide */
const showBlock = el => { el.style.display='grid'; }
const hideBlock = el => { el.style.display='none'; }

/* persistencia */
const KEY='PROCESOS_AUDIO_V2';
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); stamp(); }
function load(){
  const raw = localStorage.getItem(KEY);
  if(!raw){
    // primer arranque
    const id = uid('p_');
    state.processes=[{id,name:'RevisiÃ³n auditiva',color:colors[0],detail:'',modules:[]}];
    state.current=id;
    state.processes[0].id=id;
    save();
  }else{
    try{
      const parsed = JSON.parse(raw);
      if(!parsed || !Array.isArray(parsed.processes)) throw 0;
      Object.assign(state, parsed);
    }catch(e){
      // fallback suave
      const id = uid('p_');
      state.processes=[{id,name:'RevisiÃ³n auditiva',color:colors[0],detail:'',modules:[]}];
      state.current=id;
    }
  }
}

/* sello de hora */
function stamp(){
  if(!$('#stamp')){
    const s=document.createElement('div');
    s.id='stamp';
    s.style.marginLeft='auto'; s.style.color='#ffdede';
    $('.header').appendChild(s);
  }
  const d=new Date();
  $('#stamp').textContent='Ãšltima actualizaciÃ³n '+d.toLocaleDateString()+' '+d.toLocaleTimeString();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function render(){
  renderLeft();
  renderRight();
}

function renderLeft(){
  const box = $('#procList'); box.innerHTML='';
  state.processes.forEach(p=>{
    const card=document.createElement('div'); card.className='proc-card';
    card.style.borderColor='rgba(0,0,0,.06)';
    card.innerHTML=`
      <div class="name"><span class="dot" style="background:${p.color}"></span> ${p.name}</div>
      <div class="proc-actions">
        <button class="btn3d" title="Editar" onclick="renameProcess('${p.id}')">âœï¸</button>
        <button class="btn3d" title="Eliminar" onclick="delProcess('${p.id}')">ğŸ—‘ï¸</button>
      </div>`;
    card.onclick = (e)=>{ if(e.target.closest('button')) return; state.current=p.id; save(); renderRight(); };
    if(state.current===p.id){ card.style.outline='2px solid '+p.color; card.style.outlineOffset='2px'; }
    box.appendChild(card);
  });
}

function renderRight(){
  const cur = state.processes.find(p=>p.id===state.current) || state.processes[0];
  if(!cur){ $('#modules').innerHTML=''; return; }
  const grid = $('#modules'); grid.innerHTML='';

  // cada mÃ³dulo (subproceso) ocupa una tarjeta
  cur.modules.forEach(m=>{
    const wrap=document.createElement('article'); wrap.className='module';

    const head=document.createElement('div'); head.className='mod-head';
    head.style.background = hexToTint(cur.color,.28);
    head.innerHTML=`
      <div class="mod-title">${m.title||'Nuevo subproceso'}</div>
      <div class="mod-actions">
        <select onchange="m.role=this.value; save();" title="Responsable">
          ${roles.map(r=>`<option ${m.role===r?'selected':''}>${r}</option>`).join('')}
        </select>
        <button class="btn3d" onclick="toggleDetail('m','${m.id}')">â–¾ Detalle</button>
        <button class="btn3d" onclick="addStep('${m.id}')">ï¼‹ Paso</button>
        <button class="btn3d" onclick="save()">ğŸ¯ Guardar</button>
        <button class="btn3d" onclick="delModule('${m.id}')">â€“</button>
      </div>`;
    wrap.appendChild(head);

    // cuerpo
    const body=document.createElement('div'); body.className='mod-body';
    // detalle subproceso
    const d=document.createElement('div'); d.className='detail'; d.id=`d_m_${m.id}`;
    d.innerHTML=`<textarea placeholder="DescripciÃ³n del subproceso" oninput="autoGrow(this); setDetail('m','${m.id}',this.value)">${m.detail||''}</textarea>`;
    body.appendChild(d);

    // pasos
    m.steps.forEach((s,ix)=>{
      const step=document.createElement('div'); step.className='step';
      step.style.borderColor='rgba(0,0,0,.05)';
      step.innerHTML=`
        <div class="num">${ix+1}</div>
        <div class="title">${s.title||'Nuevo paso'}</div>
        <div class="right">
          <button class="pill" title="Bandera â†’ proceso" onclick="pickLink('s','${m.id}','${s.id}')">ğŸš©</button>
          <button class="pill" title="Si/No" onclick="toggleDetail('s','${m.id}:${s.id}')">ï¼Ÿ</button>
          <button class="pill" title="Eliminar paso" onclick="delStep('${m.id}','${s.id}')">â€“</button>
        </div>
        <div class="vline" style="background:${cur.color}"></div>
      `;
      // detalle del paso (si/no + descripciÃ³n)
      const dd=document.createElement('div'); dd.className='detail'; dd.id=`d_s_${m.id}:${s.id}`;
      dd.innerHTML=`
        <div style="display:grid;gap:.5rem">
          <textarea placeholder="DescripciÃ³n del paso" oninput="autoGrow(this); setDetail('s','${m.id}:${s.id}',this.value)">${s.detail||''}</textarea>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem">
            ${condBlock('NO',cur.color, s.no||[], (txt)=>addCond('no','${m.id}','${s.id}',txt))}
            ${condBlock('SÃ',cur.color, s.yes||[], (txt)=>addCond('yes','${m.id}','${s.id}',txt))}
          </div>
        </div>`;
      body.appendChild(step);
      body.appendChild(dd);
    });

    wrap.appendChild(body);
    grid.appendChild(wrap);
  });

  // botÃ³n global para aÃ±adir pack a este proceso
  const addCard=document.createElement('article'); addCard.className='module';
  addCard.innerHTML=`
    <div class="mod-head" style="background:${hexToTint(cur.color,.2)}">
      <div class="mod-title" style="background:#111">Pasos</div>
      <div class="mod-actions">
        <button class="btn3d" onclick="addModule()">ï¼‹ Subproceso</button>
        <button class="btn3d" onclick="addModuleWithStep()">ï¼‹ Subproceso + Paso</button>
      </div>
    </div>`;
  $('#modules').appendChild(addCard);
}

/* bloque Si/No */
function condBlock(label,color,arr,onAdd){
  const low = label.toLowerCase();
  const headColor = low==='no' ? '#111' : '#0b74c8';
  return `
  <div style="background:#fff;border:1px solid rgba(0,0,0,.07);border-radius:12px;padding:.5rem">
    <div style="display:flex;gap:.4rem;align-items:center;margin-bottom:.4rem">
      <span class="pill" style="background:${headColor};color:#fff">${label}</span>
      <button class="pill" onclick="const t=prompt('AÃ±adir punto a ${label}:'); if(t) (${onAdd.toString().replace(' (txt)','(t)')});">ï¼‹</button>
    </div>
    <div style="display:grid;gap:.35rem">
      ${arr.map((pt,i)=>`
        <div class="chip" style="justify-content:space-between">
          <span><b>${i+1}.</b> ${escapeHtml(pt.text||'')}</span>
          <span style="display:flex;gap:.35rem">
            <button class="pill" title="Bandera â†’ proceso" onclick="pickLink('c','${pt.id}')">ğŸš©</button>
            <button class="pill" title="Eliminar" onclick="delCond('${pt.id}')">â€“</button>
          </span>
        </div>
      `).join('')}
    </div>
  </div>`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ EDICIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renameProcess(id){
  const p = state.processes.find(x=>x.id===id); if(!p) return;
  const t = prompt('Nombre del proceso', p.name || ''); if(t==null) return;
  p.name = t.trim()||p.name; save(); render();
}
function delProcess(id){
  if(!confirm('Â¿Eliminar proceso?')) return;
  const k = state.processes.findIndex(x=>x.id===id);
  if(k>-1) state.processes.splice(k,1);
  if(!state.processes.length){
    const nid=uid('p_'); state.processes=[{id:nid,name:'Nuevo proceso',color:colors[0],detail:'',modules:[]}];
    state.current=nid;
  }else if(state.current===id){
    state.current=state.processes[0].id;
  }
  save(); render();
}

function addProcess(){
  const id = uid('p_');
  state.processes.push({id,name:'Nuevo proceso',color:colors[state.processes.length % colors.length],detail:'',modules:[]});
  state.current=id; save(); render();
}
function addModule(){
  const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
  cur.modules.push({id:uid('m_'),title:'Nuevo subproceso',role:roles[0],detail:'',steps:[]});
  save(); renderRight();
}
function addModuleWithStep(){
  const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
  const mid = uid('m_');
  cur.modules.push({id:mid,title:'Nuevo subproceso',role:roles[0],detail:'',steps:[{id:uid('s_'),title:'Nuevo paso',detail:'',yes:[],no:[]} ]});
  save(); renderRight();
}
function delModule(mid){
  const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
  const i = cur.modules.findIndex(m=>m.id===mid); if(i>-1) cur.modules.splice(i,1);
  save(); renderRight();
}
function addStep(mid){
  const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
  const m = cur.modules.find(m=>m.id===mid); if(!m) return;
  m.steps.push({id:uid('s_'),title:'Nuevo paso',detail:'',yes:[],no:[]});
  save(); renderRight();
}
function delStep(mid,sid){
  const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
  const m = cur.modules.find(m=>m.id===mid); if(!m) return;
  const i = m.steps.findIndex(s=>s.id===sid); if(i>-1) m.steps.splice(i,1);
  save(); renderRight();
}

/* detalles */
function toggleDetail(kind,key){
  const id = kind==='m' ? `d_m_${key}` : `d_s_${key}`;
  const el = document.getElementById(id);
  el.style.display = (el.style.display==='block') ? 'none' : 'block';
}
function setDetail(kind,key,value){
  const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
  if(kind==='m'){
    const m = cur.modules.find(m=>m.id===key); if(!m) return;
    m.detail = value; save();
  }else{
    const [mid,sid]=key.split(':');
    const m = cur.modules.find(m=>m.id===mid); if(!m) return;
    const s = m.steps.find(x=>x.id===sid); if(!s) return;
    s.detail=value; save();
  }
}
function autoGrow(el){
  el.style.height='auto'; el.style.height=(el.scrollHeight+6)+'px';
}

/* condiciones si/no */
function addCond(which, mid, sid, text){
  const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
  const m = cur.modules.find(m=>m.id===mid); if(!m) return;
  const s = m.steps.find(x=>x.id===sid); if(!s) return;
  const item = { id:uid('c_'), text:text||'' , link:null };
  (which==='yes' ? s.yes : s.no).push(item);
  save(); renderRight();
}
function delCond(cid){
  const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
  for(const m of cur.modules){
    for(const s of m.steps){
      const i1=s.yes?.findIndex(c=>c.id===cid)??-1;
      if(i1>-1){ s.yes.splice(i1,1); save(); return renderRight(); }
      const i2=s.no?.findIndex(c=>c.id===cid)??-1;
      if(i2>-1){ s.no.splice(i2,1); save(); return renderRight(); }
    }
  }
}

/* bandera (en paso o punto) â†’ selecciona proceso destino */
let pendingLink = null;
/* === FUNCION REEMPLAZADA Y ROBUSTA === */
function openProcPicker(onPick){
  const modal = document.getElementById('procModal');
  const list  = document.getElementById('procModalList');

  // Reset lista + asegurar visibilidad
  list.innerHTML = '';
  showBlock(modal);
  modal.classList.remove('hide');

  if(Array.isArray(state.processes) && state.processes.length){
    state.processes.forEach(p=>{
      const b=document.createElement('button');
      b.className='btn3d';
      b.style.cssText='justify-content:flex-start;color:#111;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);border-radius:12px';
      b.innerHTML = `<span class="dot" style="background:${p.color}"></span> <strong>${escapeHtml(p.name)}</strong>`;
      b.onclick = ()=>{ hideBlock(modal); onPick(p.id); };
      list.appendChild(b);
    });
  }else{
    const note=document.createElement('div');
    note.style.cssText='padding:.6rem .4rem;color:#111;background:#fff;border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,.06)';
    note.innerHTML = `No hay procesos disponibles.<br>Usa <b>+ Procesos</b> para crear uno.`;
    list.appendChild(note);
  }

  const cancel = document.getElementById('pmCancel');
  cancel.onclick = () => hideBlock(modal);
  modal.onclick  = (e) => { if(e.target===modal) hideBlock(modal); };
}

function pickLink(kind, ...ids){
  // kind: 's' â†’ paso  | 'c' â†’ cond punto
  pendingLink = { kind, ids };
  openProcPicker((pid)=>{
    if(!pendingLink) return;
    const {kind, ids} = pendingLink;
    if(kind==='s'){
      const [mid,sid] = ids;
      const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
      const m = cur.modules.find(m=>m.id===mid); if(!m) return;
      const s = m.steps.find(x=>x.id===sid); if(!s) return;
      s.link = pid;
    }else if(kind==='c'){
      const cid=ids[0];
      const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
      for(const m of cur.modules){
        for(const s of m.steps){
          const it1=s.yes?.find(c=>c.id===cid); if(it1){ it1.link=pid; save(); return renderRight(); }
          const it2=s.no?.find(c=>c.id===cid);  if(it2){ it2.link=pid; save(); return renderRight(); }
        }
      }
    }
    save(); renderRight();
    pendingLink=null;
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function downloadHTML(){
  // genera HTML auto-contenido (sin document.write)
  const html = document.documentElement.cloneNode(true);
  // opcional: quitar modal abierto
  html.querySelector('#procModal')?.classList.add('hide');
  const final='<!doctype html>\n'+html.outerHTML;
  const blob=new Blob([final],{type:'text/html'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='procesos-audio.html'; a.click();
  URL.revokeObjectURL(url);
}
function printPDF(){ window.print(); }

function requirePIN(){
  if(state.pinOk) return (state.pinOk=false, state.pinOk=true);
  const code = prompt('PIN (p.ej. AR4321)');
  if(code && code.trim().toUpperCase()==='AR4321'){ state.pinOk=true; alert('EdiciÃ³n desbloqueada'); }
  else alert('PIN incorrecto');
}

/* helpers */
function hexToTint(hex, amt){
  // mezcla con blanco
  const h=hex.replace('#','');
  const r=parseInt(h.substring(0,2),16), g=parseInt(h.substring(2,4),16), b=parseInt(h.substring(4,6),16);
  const R=Math.round(r+(255-r)*amt), G=Math.round(g+(255-g)*amt), B=Math.round(b+(255-b)*amt);
  return `rgba(${R},${G},${B},.85)`;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[m]); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('#btnAddProc').onclick = ()=>{ addProcess(); };
$('#btnAddStep').onclick = ()=>{
  const cur = state.processes.find(p=>p.id===state.current); if(!cur) return;
  if(!cur.modules.length) addModule();
  addStep(cur.modules[0].id);
};
$('#btnAddPack').onclick = ()=> addModuleWithStep();
$('#btnPIN').onclick = ()=> requirePIN();
$('#btnPDF').onclick = ()=> printPDF();
$('#btnHTML').onclick = ()=> downloadHTML();
$('#btnSaveCloud').onclick = ()=> save();

$('#q').oninput = (e)=>{
  const q = e.target.value.toLowerCase();
  for(const el of $$('#procList .proc-card')){
    const name = el.querySelector('.name')?.innerText.toLowerCase()||'';
    el.style.display = name.includes(q)?'flex':'none';
  }
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
load(); render(); stamp();
</script>
</body>
</html>
