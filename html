<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Plataforma de procesos (local)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f3f4f6;
      }
      :root {
        --radius: 18px;
      }

      /* PANTALLA PIN */
      #pin {
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle, #d72626, #410000 70%);
      }
      #pin .box {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 26px 20px 20px;
        border-radius: 16px;
        color: #fff;
        text-align: center;
        width: 280px;
      }
      #pin input {
        width: 100%;
        padding: 6px 4px;
        margin-top: 10px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.2);
        color: #fff;
        text-align: center;
        letter-spacing: 0.3em;
      }
      #pin button {
        margin-top: 12px;
        width: 100%;
        padding: 7px 0;
        border: none;
        background: #d72626;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
      }

      /* APP */
      #app {
        display: none;
        height: 100vh;
        flex-direction: column;
        max-width: 100vw;
      }
      .top {
        display: flex;
        gap: 8px;
        align-items: center;
        background: linear-gradient(90deg, #000, #5a0000);
        color: #fff;
        padding: 10px;
      }
      .top h1 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
      }
      .top input {
        flex: 1;
        max-width: 430px;
        border: none;
        background: rgba(255, 255, 255, 0.12);
        padding: 5px 10px;
        border-radius: 999px;
        color: #fff;
      }
      .main {
        flex: 1;
        display: flex;
        gap: 10px;
        padding: 10px;
        box-sizing: border-box;
        width: 100%;
        min-height: 0;
      }
      .panel {
        background: #fff;
        border-radius: var(--radius);
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.04);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0;
      }
      .panel header {
        padding: 9px 12px;
        background: #000;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .panel-title {
        font-weight: 600;
      }

      /* BOTONES SOBRE NEGRO */
      .top .btn,
      .panel > header .btn,
      .top .btn-small,
      .panel > header .btn-small {
        background: rgba(248, 250, 252, 0.12);
        color: #f8fafc;
        border: 1px solid rgba(248, 250, 252, 0.14);
      }

      /* PANEL IZQUIERDA */
      #proc {
        flex: 0 0 280px;
        max-width: 320px;
      }
      .panel .body {
        flex: 1;
        overflow: auto;
        padding: 8px;
      }
      .proc-item {
        background: #fff;
        border: 2px solid transparent;
        border-radius: 14px;
        margin-bottom: 6px;
        padding: 4px 6px 4px 8px;
        display: flex;
        gap: 4px;
        align-items: flex-start;
        cursor: pointer;
      }
      .proc-item.active {
        box-shadow: inset 0 0 0 2px rgba(0, 0, 0, 0.05);
      }
      .proc-input {
        border: none;
        background: transparent;
        font-weight: 600;
        font-size: 13px;
        width: 100%;
        outline: none;
      }
      .proc-num {
        font-size: 11px;
        font-weight: 700;
        margin-right: 4px;
        color: #000;
      }
      .proc-desc {
        margin-top: 4px;
        font-size: 11px;
      }
      .proc-desc textarea {
        width: 100%;
        min-height: 45px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        padding: 3px 4px;
        font-size: 11px;
        background: #fff;
      }
      .proc-desc-toggle {
        font-size: 10px;
        background: rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 12px;
        padding: 1px 6px;
        cursor: pointer;
      }
      .btn {
        background: rgba(188, 0, 0, 0.1);
        border: none;
        border-radius: 999px;
        padding: 3px 9px;
        color: #bc0000;
        cursor: pointer;
      }
      .btn-small {
        padding: 2px 7px;
        font-size: 11px;
      }

      /* PANEL CENTRAL */
      #sub {
        flex: 1 1 35%;
        min-width: 260px;
      }
      #sub.hidden-sub {
        display: none;
      }
      .sub-box {
        border: 1px solid rgba(0, 0, 0, 0.03);
        border-radius: 14px;
        padding: 6px 7px;
        margin-bottom: 6px;
        background: #fff;
      }
      .sub-box.active {
        outline: 2px solid rgba(0, 0, 0, 0.04);
      }
      .label {
        font-size: 10px;
        text-transform: uppercase;
        color: #777;
        margin-top: 3px;
      }
      .input {
        width: 100%;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 3px 5px;
        font-size: 12px;
      }
      textarea.input {
        min-height: 40px;
        resize: vertical;
      }
      .sub-header-inline {
        display: flex;
        gap: 4px;
        align-items: center;
        justify-content: space-between;
      }
      .sub-actions {
        display: flex;
        gap: 4px;
      }
      .sub-steps-btn {
        background: rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 8px;
        padding: 2px 8px;
        font-size: 11px;
        cursor: pointer;
      }
      .sub-steps-btn.active {
        background: #000;
        color: #fff;
      }
      /* fila superior de acciones en panel central */
      .sub-top-actions {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 8px;
      }
      .sub-top-actions button {
        background: rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 8px;
        padding: 3px 10px;
        font-size: 11px;
        cursor: pointer;
      }

      /* PANEL PASOS */
      #steps {
        flex: 1 1 35%;
        min-width: 260px;
        transition: all 0.2s ease;
      }
      #steps.hidden {
        width: 0;
        min-width: 0;
        opacity: 0;
        pointer-events: none;
      }
      #steps.full-width {
        flex: 1 1 auto;
        width: 100%;
      }
      .step {
        border: 1px solid #eee;
        border-radius: 14px;
        padding: 5px 7px;
        margin-bottom: 6px;
        background: #fff;
      }
      .step-num {
        font-weight: 700;
        font-size: 11px;
        margin-bottom: 4px;
      }
      .origin {
        font-size: 11px;
        color: #555;
        margin-bottom: 5px;
        font-weight: 500;
      }

      /* RESPONSIVE */
      @media (max-width: 1024px) {
        .main {
          flex-wrap: wrap;
        }
        #proc {
          flex-basis: 100%;
          max-width: 100%;
        }
        #sub,
        #steps {
          flex: 1 1 100%;
          max-width: 100%;
        }
      }
      @media (max-width: 640px) {
        .top {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <!-- PANTALLA PIN -->
    <div id="pin">
      <div class="box">
        <h2>PROCESOS</h2>
        <p style="opacity:.7;font-size:12px">Introduce tu PIN</p>
        <input id="pinInput" type="password" placeholder="AR4321" />
        <button onclick="checkPin()">Entrar</button>
        <p id="pinErr" style="color:#ffe0e0;font-size:11px"></p>
      </div>
    </div>

    <!-- APP -->
    <div id="app">
      <div class="top">
        <h1>PROCESOS</h1>
        <input id="search" placeholder="Buscar..." oninput="doSearch(this.value)" />
        <button class="btn" onclick="alert('Guardado en localStorage ✅')">💾 Guardar</button>
      </div>
      <div class="main">
        <!-- PANEL PROCESOS -->
        <div class="panel" id="proc">
          <header>
            <span class="panel-title">Procesos</span>
            <div style="display:flex;gap:6px">
              <button class="btn-small btn" onclick="addProcess()">+ Proceso</button>
              <button class="btn-small btn" onclick="quickAddSub()">+ Subp.</button>
              <button class="btn-small btn" onclick="quickAddStep()">+ Paso</button>
            </div>
          </header>
          <div class="body" id="procList"></div>
        </div>

        <!-- PANEL SUBPROCESO -->
        <div class="panel" id="sub">
          <header id="subHeader">
            <span class="panel-title">Subproceso</span>
            <button class="btn" onclick="addSub()">+ Subproceso</button>
          </header>
          <div class="body" id="subList"></div>
        </div>

        <!-- PANEL PASOS -->
        <div class="panel" id="steps">
          <header id="stepHeader">
            <span class="panel-title">Pasos</span>
            <button class="btn" onclick="addStep()">+ Paso</button>
          </header>
          <div class="body" id="stepList"></div>
        </div>
      </div>
    </div>

    <script>
      const LS_KEY = "procesos_app_v1";
      const pastel = ["#ffe4e1", "#fff5cc", "#e2f0ff", "#e5ffe8", "#f3e5ff", "#ffeaf2", "#e9fff9"];
      const responsables = ["Audiólogo", "Responsable", "Franquiciado"];

      const saved = localStorage.getItem(LS_KEY);
      let data = saved
        ? JSON.parse(saved)
        : [
            {
              id: "p1",
              name: "REPARACIONES",
              color: pastel[0],
              description: "",
              showDesc: false,
              subprocesses: [],
              steps: [],
            },
            {
              id: "p2",
              name: "AJUSTE REMOTO",
              color: pastel[1],
              description: "",
              showDesc: false,
              subprocesses: [],
              steps: [],
            },
            {
              id: "p3",
              name: "HIT",
              color: pastel[2],
              description: "",
              showDesc: false,
              subprocesses: [],
              steps: [],
            },
          ];

      let currentP = data[0]?.id || null;
      let currentS = null;
      let stepScope = { type: "process", id: currentP };
      let showSteps = false;
      let searchTerm = "";

      function saveLocal() {
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }

      // ENTER global
      window.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const pinVisible = document.getElementById("pin").style.display !== "none";
          if (pinVisible) {
            e.preventDefault();
            checkPin();
            return;
          }
          const a = document.activeElement;
          if (a && a.tagName === "INPUT") {
            e.preventDefault();
            a.blur();
          }
        }
      });

      function checkPin() {
        const v = document.getElementById("pinInput").value;
        if (v === "AR4321") {
          document.getElementById("pin").style.display = "none";
          document.getElementById("app").style.display = "flex";
          render();
        } else {
          document.getElementById("pinErr").textContent = "PIN incorrecto";
        }
      }

      function uid() {
        return Math.random().toString(36).slice(2, 9);
      }
      function doSearch(val) {
        searchTerm = val.toLowerCase();
        render();
      }

      // ORDENAMOS: primero procesos con subprocesos
      function getFilteredData() {
        let base = data.slice();
        if (searchTerm) {
          base = base
            .map((p) => {
              const matchP =
                p.name.toLowerCase().includes(searchTerm) ||
                (p.description || "").toLowerCase().includes(searchTerm);
              const filteredSub = (p.subprocesses || []).filter(
                (s) =>
                  s.name.toLowerCase().includes(searchTerm) ||
                  (s.description || "").toLowerCase().includes(searchTerm)
              );
              const filteredSteps = (p.steps || []).filter(
                (st) =>
                  st.name.toLowerCase().includes(searchTerm) ||
                  (st.description || "").toLowerCase().includes(searchTerm)
              );
              if (matchP || filteredSub.length || filteredSteps.length) {
                return {
                  ...p,
                  subprocesses: filteredSub.length ? filteredSub : p.subprocesses,
                  steps: filteredSteps.length ? filteredSteps : p.steps,
                };
              }
              return null;
            })
            .filter(Boolean);
        }
        base.sort((a, b) => {
          const aHas = (a.subprocesses || []).length > 0;
          const bHas = (b.subprocesses || []).length > 0;
          if (aHas === bHas) return 0;
          return aHas ? -1 : 1;
        });
        return base;
      }

      function render() {
        renderProcesses();
        renderSub();
        renderSteps();
        document.getElementById("steps").classList.toggle("hidden", !showSteps);
        saveLocal();
      }

      function renderProcesses() {
        const box = document.getElementById("procList");
        box.innerHTML = "";
        const list = getFilteredData();
        list.forEach((p, idx) => {
          const div = document.createElement("div");
          div.className = "proc-item" + (p.id === currentP ? " active" : "");
          div.style.background = p.color;
          div.onclick = () => {
            currentP = p.id;
            currentS = null;
            const hasSubs = (p.subprocesses || []).length > 0;
            const hasSteps = (p.steps || []).length > 0;
            if (!hasSubs && hasSteps) {
              stepScope = { type: "process", id: p.id };
              showSteps = true;
            } else {
              showSteps = false;
              stepScope = { type: "process", id: p.id };
            }
            render();
          };
          const num = document.createElement("div");
          num.className = "proc-num";
          num.textContent = idx + 1 + ".";
          div.appendChild(num);
          const flex = document.createElement("div");
          flex.style.flex = "1";
          const inp = document.createElement("input");
          inp.className = "proc-input";
          inp.value = p.name;
          inp.onclick = (ev) => ev.stopPropagation();
          inp.oninput = (ev) => {
            p.name = ev.target.value;
            saveLocal();
          };
          flex.appendChild(inp);
          const tgl = document.createElement("button");
          tgl.className = "proc-desc-toggle";
          tgl.textContent = p.showDesc ? "▲ Descripción" : "▼ Descripción";
          tgl.onclick = (ev) => {
            ev.stopPropagation();
            p.showDesc = !p.showDesc;
            render();
          };
          flex.appendChild(tgl);
          if (p.showDesc) {
            const d = document.createElement("div");
            d.className = "proc-desc";
            const ta = document.createElement("textarea");
            ta.value = p.description || "";
            ta.oninput = (ev) => {
              p.description = ev.target.value;
              saveLocal();
            };
            d.appendChild(ta);
            flex.appendChild(d);
          }
          div.appendChild(flex);
          const del = document.createElement("button");
          del.className = "btn";
          del.textContent = "−";
          del.onclick = (ev) => {
            ev.stopPropagation();
            delProcess(p.id);
          };
          div.appendChild(del);
          box.appendChild(div);
        });
      }

      function delProcess(id) {
        data = data.filter((p) => p.id !== id);
        if (currentP === id) {
          currentP = data[0]?.id || null;
          stepScope = { type: "process", id: currentP };
          currentS = null;
          showSteps = false;
        }
        render();
      }

      function addProcess() {
        const idx = data.length % pastel.length;
        const np = {
          id: uid(),
          name: "Nuevo proceso",
          color: pastel[idx],
          description: "",
          showDesc: false,
          subprocesses: [],
          steps: [],
        };
        data.push(np);
        currentP = np.id;
        currentS = null;
        stepScope = { type: "process", id: np.id };
        showSteps = false;
        render();
      }

      function quickAddSub() {
        if (!currentP) {
          alert("Selecciona un proceso");
          return;
        }
        addSub();
      }

      function quickAddStep() {
        if (stepScope.type === "process" && !currentP) {
          alert("Selecciona un proceso");
          return;
        }
        if (stepScope.type === "subprocess" && !currentS) {
          alert("Selecciona un subproceso y pulsa Pasos");
          return;
        }
        addStep();
      }

      function getCurrentP() {
        return data.find((p) => p.id === currentP) || null;
      }

      function getCurrentS() {
        const p = getCurrentP();
        if (!p) return null;
        return (p.subprocesses || []).find((s) => s.id === currentS) || null;
      }

      function renderSub() {
        const p = getCurrentP();
        const list = document.getElementById("subList");
        const subPanel = document.getElementById("sub");
        const subHeader = document.getElementById("subHeader");
        const stepsPanel = document.getElementById("steps");

        if (p) {
          subHeader.style.background = "linear-gradient(90deg,#000," + shade(p.color, -20) + ")";
        }

        list.innerHTML = "";

        if (!p) {
          subPanel.classList.remove("hidden-sub");
          stepsPanel.classList.remove("full-width");
          list.innerHTML =
            "<p style='color:#888;font-size:13px;text-align:center;margin-top:20px'>Selecciona un proceso</p>";
          return;
        }

        const subs = p.subprocesses || [];
        const procSteps = p.steps || [];

        // si NO hay subprocesos y SÍ hay pasos → ocultamos central
        if (subs.length === 0 && procSteps.length > 0) {
          subPanel.classList.add("hidden-sub");
          stepsPanel.classList.add("full-width");
          stepScope = { type: "process", id: p.id };
          showSteps = true;
          return;
        } else {
          subPanel.classList.remove("hidden-sub");
          stepsPanel.classList.remove("full-width");
        }

        // fila con botón "Pasos →"
        const topActions = document.createElement("div");
        topActions.className = "sub-top-actions";
        const btnPasosProc = document.createElement("button");
        btnPasosProc.textContent = "Pasos →";
        btnPasosProc.onclick = () => {
          stepScope = { type: "process", id: p.id };
          showSteps = true;
          render();
        };
        topActions.appendChild(btnPasosProc);
        list.appendChild(topActions);

        if (subs.length === 0) {
          // Aquí ya no mostramos "Ver pasos del proceso", porque ya tienes el botón arriba
          list.innerHTML +=
            "<div style='color:#888;font-size:13px;text-align:center;margin-top:20px'>Este proceso no tiene subprocesos.</div>";
          return;
        }

        subs.forEach((s) => {
          const box = document.createElement("div");
          box.className = "sub-box" + (s.id === currentS ? " active" : "");
          box.style.background = hexToRgba(p.color, 0.35);
          box.onclick = () => {
            currentS = s.id;
          };
          const head = document.createElement("div");
          head.className = "sub-header-inline";
          const name = document.createElement("input");
          name.className = "input";
          name.value = s.name;
          name.oninput = (e) => {
            s.name = e.target.value;
            saveLocal();
          };
          head.appendChild(name);
          const actions = document.createElement("div");
          actions.className = "sub-actions";
          const btnPasos = document.createElement("button");
          btnPasos.textContent = "Pasos";
          btnPasos.className =
            "sub-steps-btn" +
            (stepScope.type === "subprocess" && stepScope.id === s.id && showSteps ? " active" : "");
          btnPasos.onclick = (ev) => {
            ev.stopPropagation();
            currentS = s.id;
            stepScope = { type: "subprocess", id: s.id };
            showSteps = true;
            render();
          };
          const del = document.createElement("button");
          del.className = "btn";
          del.textContent = "−";
          del.onclick = (ev) => {
            ev.stopPropagation();
            delSub(s.id);
          };
          actions.appendChild(btnPasos);
          actions.appendChild(del);
          head.appendChild(actions);
          box.appendChild(head);
          const origin = document.createElement("div");
          origin.className = "label";
          origin.textContent = "Proceso origen";
          box.appendChild(origin);
          const originVal = document.createElement("div");
          originVal.style.fontSize = "11px";
          originVal.textContent = p.name;
          box.appendChild(originVal);
          const lab = document.createElement("div");
          lab.className = "label";
          lab.textContent = "Descripción";
          box.appendChild(lab);
          const ta = document.createElement("textarea");
          ta.className = "input";
          ta.value = s.description || "";
          ta.oninput = (e) => {
            s.description = e.target.value;
            saveLocal();
          };
          box.appendChild(ta);
          const lab2 = document.createElement("div");
          lab2.className = "label";
          lab2.textContent = "Persona responsable";
          box.appendChild(lab2);
          const sel = document.createElement("select");
          sel.className = "input";
          responsables.forEach((r) => {
            const opt = document.createElement("option");
            opt.value = r;
            opt.textContent = r;
            sel.appendChild(opt);
          });
          sel.value = s.responsable || responsables[0];
          sel.onchange = (e) => {
            s.responsable = e.target.value;
            saveLocal();
          };
          box.appendChild(sel);
          const lab3 = document.createElement("div");
          lab3.className = "label";
          lab3.textContent = "Enlace";
          box.appendChild(lab3);
          const link = document.createElement("input");
          link.className = "input";
          link.value = s.link || "";
          link.oninput = (e) => {
            s.link = e.target.value;
            saveLocal();
          };
          box.appendChild(link);
          const lab4 = document.createElement("div");
          lab4.className = "label";
          lab4.textContent = "Documento";
          box.appendChild(lab4);
          const doc = document.createElement("input");
          doc.className = "input";
          doc.value = s.document || "";
          doc.oninput = (e) => {
            s.document = e.target.value;
            saveLocal();
          };
          box.appendChild(doc);
          list.appendChild(box);
        });
      }

      function addSub() {
        const p = getCurrentP();
        if (!p) return;
        const ns = {
          id: uid(),
          name: "Nuevo subproceso",
          description: "",
          responsable: responsables[0],
          link: "",
          document: "",
          steps: [],
        };
        p.subprocesses = p.subprocesses || [];
        p.subprocesses.push(ns);
        currentS = ns.id;
        stepScope = { type: "subprocess", id: ns.id };
        showSteps = false;
        render();
      }

      function delSub(id) {
        const p = getCurrentP();
        if (!p) return;
        p.subprocesses = (p.subprocesses || []).filter((s) => s.id !== id);
        if (stepScope.type === "subprocess" && stepScope.id === id) {
          stepScope = { type: "process", id: p.id };
          showSteps = false;
        }
        render();
      }

      function renderSteps() {
        const list = document.getElementById("stepList");
        const stepHeader = document.getElementById("stepHeader");
        const p = getCurrentP();
        if (p) {
          stepHeader.style.background = "linear-gradient(90deg,#000," + shade(p.color, -20) + ")";
        }
        list.innerHTML = "";
        if (!showSteps) {
          list.innerHTML =
            "<p style='color:#888;font-size:13px;text-align:center;margin-top:20px'>Pulsa “Pasos” →</p>";
          return;
        }
        let steps = [];
        let originTitle = "";
        if (stepScope.type === "process") {
          const proc = data.find((x) => x.id === stepScope.id);
          steps = proc ? proc.steps || [] : [];
          originTitle = "Proceso origen: " + (proc ? proc.name : "");
        } else {
          const sp = getCurrentS();
          steps = sp ? sp.steps || [] : [];
          originTitle = "Subproceso origen: " + (sp ? sp.name : "");
        }
        const originEl = document.createElement("div");
        originEl.className = "origin";
        originEl.textContent = originTitle;
        list.appendChild(originEl);
        if (!steps || steps.length === 0) {
          list.innerHTML +=
            "<div style='color:#888;font-size:13px;text-align:center;margin-top:10px'>No hay pasos aún.</div>";
        }
        steps.forEach((st, idx) => {
          const box = document.createElement("div");
          box.className = "step";
          const num = document.createElement("div");
          num.className = "step-num";
          num.textContent = "Paso " + (idx + 1);
          box.appendChild(num);
          const name = document.createElement("input");
          name.className = "input";
          name.value = st.name;
          name.placeholder = "Título del paso";
          name.oninput = (e) => {
            st.name = e.target.value;
            saveLocal();
          };
          box.appendChild(name);
          const lab1 = document.createElement("div");
          lab1.className = "label";
          lab1.textContent = "Descripción";
          box.appendChild(lab1);
          const ta = document.createElement("textarea");
          ta.className = "input";
          ta.value = st.description || "";
          ta.oninput = (e) => {
            st.description = e.target.value;
            saveLocal();
          };
          box.appendChild(ta);
          const lab2 = document.createElement("div");
          lab2.className = "label";
          lab2.textContent = "Enlace";
          box.appendChild(lab2);
          const lin = document.createElement("input");
          lin.className = "input";
          lin.value = st.link || "";
          lin.oninput = (e) => {
            st.link = e.target.value;
            saveLocal();
          };
          box.appendChild(lin);
          const lab3 = document.createElement("div");
          lab3.className = "label";
          lab3.textContent = "Documento/adjunto";
          box.appendChild(lab3);
          const doc = document.createElement("input");
          doc.className = "input";
          doc.value = st.document || "";
          doc.oninput = (e) => {
            st.document = e.target.value;
            saveLocal();
          };
          box.appendChild(doc);
          const del = document.createElement("button");
          del.className = "btn";
          del.textContent = "− Eliminar paso";
          del.onclick = () => {
            delStep(st.id);
          };
          box.appendChild(del);
          list.appendChild(box);
        });
      }

      function addStep() {
        if (stepScope.type === "process") {
          const p = getCurrentP();
          if (!p) {
            alert("Selecciona un proceso");
            return;
          }
          p.steps = p.steps || [];
          p.steps.push({ id: uid(), name: "Nuevo paso", description: "", link: "", document: "" });
          showSteps = true;
        } else {
          const s = getCurrentS();
          if (!s) {
            alert("Selecciona un subproceso y pulsa Pasos");
            return;
          }
          s.steps = s.steps || [];
          s.steps.push({ id: uid(), name: "Nuevo paso", description: "", link: "", document: "" });
          showSteps = true;
        }
        render();
      }

      function delStep(id) {
        if (stepScope.type === "process") {
          const p = getCurrentP();
          p.steps = (p.steps || []).filter((st) => st.id !== id);
        } else {
          const s = getCurrentS();
          if (!s) return;
          s.steps = (s.steps || []).filter((st) => st.id !== id);
        }
        renderSteps();
      }

      function hexToRgba(hex, alpha) {
        if (!hex) return "rgba(255,255,255," + alpha + ")";
        const h = hex.replace("#", "");
        const r = parseInt(h.substring(0, 2), 16);
        const g = parseInt(h.substring(2, 4), 16);
        const b = parseInt(h.substring(4, 6), 16);
        return "rgba(" + r + "," + g + "," + b + "," + alpha + ")";
      }
      function shade(hex, percent) {
        if (!hex) return "#000";
        const f = parseInt(hex.slice(1), 16),
          t = percent < 0 ? 0 : 255,
          p = percent < 0 ? percent * -1 : percent;
        const R = f >> 16,
          G = (f >> 8) & 0x00ff,
          B = f & 0x0000ff;
        return (
          "#" +
          (0x1000000 +
            (Math.round((t - R) * p / 100) + R) * 0x10000 +
            (Math.round((t - G) * p / 100) + G) * 0x100 +
            (Math.round((t - B) * p / 100) + B))
            .toString(16)
            .slice(1)
        );
      }
    </script>
  </body>
</html>
